<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="一、泛型基类（通用单例模式） 代码全景分析 核心功能：确保在整个游戏中，某个类（比如\u00a0GameManager）有且仅有一个实例，并提供一个全局的访问点（Instance），让任何其他脚本都能轻松调用它。\n">
<title>Unity模块化代码设计</title>

<link rel='canonical' href='https://SelYioZn.github.io/p/unity%E6%A8%A1%E5%9D%97%E5%8C%96%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1/'>

<link rel="stylesheet" href="/scss/style.min.7f00f5e0f678700c9a1d7393b1aba3b245111ee003b07ad4ecc15c9c9161b436.css"><meta property='og:title' content="Unity模块化代码设计">
<meta property='og:description' content="一、泛型基类（通用单例模式） 代码全景分析 核心功能：确保在整个游戏中，某个类（比如\u00a0GameManager）有且仅有一个实例，并提供一个全局的访问点（Instance），让任何其他脚本都能轻松调用它。\n">
<meta property='og:url' content='https://SelYioZn.github.io/p/unity%E6%A8%A1%E5%9D%97%E5%8C%96%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1/'>
<meta property='og:site_name' content='黎Yio'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-12-05T19:21:47&#43;08:00'/><meta property='article:modified_time' content='2025-12-05T19:21:47&#43;08:00'/>
<meta name="twitter:title" content="Unity模块化代码设计">
<meta name="twitter:description" content="一、泛型基类（通用单例模式） 代码全景分析 核心功能：确保在整个游戏中，某个类（比如\u00a0GameManager）有且仅有一个实例，并提供一个全局的访问点（Instance），让任何其他脚本都能轻松调用它。\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_95bb9a9076a907fa.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">😴</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">黎Yio</a></h1>
            <h2 class="site-description">前天我遇见了小兔，昨天遇见了小鹿，今天则遇见了你。</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://SelYioZn.github.io/en/" >English</option>
                                
                                    <option value="https://SelYioZn.github.io/" selected>简体中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#一泛型基类通用单例模式">一、泛型基类（通用单例模式）</a>
      <ol>
        <li><a href="#代码全景分析">代码全景分析</a>
          <ol>
            <li><a href="#示例子类">示例子类：</a></li>
            <li><a href="#在其他脚本中调用">在其他脚本中调用：</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#二基于-dotween-插件的场景切换控制器继承泛型单例">二、基于 DOTween 插件的场景切换控制器(继承泛型单例)</a>
      <ol>
        <li><a href="#代码全景分析-1">代码全景分析</a>
          <ol>
            <li><a href="#代码调用示例">代码调用示例：</a></li>
          </ol>
        </li>
        <li><a href="#核心技能点总结">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三3d公告板相机">三、3D公告板（相机）：</a>
      <ol>
        <li><a href="#代码全景分析-2">代码全景分析</a></li>
        <li><a href="#核心技能点总结-1">核心技能点总结</a></li>
        <li><a href="#25d适用版本">2.5D适用版本：</a></li>
      </ol>
    </li>
    <li><a href="#四ui的淡入淡出dotween">四、UI的淡入淡出（Dotween)</a>
      <ol>
        <li><a href="#代码全景分析-3">代码全景分析</a></li>
        <li><a href="#使用场景与示例">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-2">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#五ui跟随2d可用">五、UI跟随（2D可用）</a>
      <ol>
        <li><a href="#代码全景分析-4">代码全景分析</a></li>
        <li><a href="#使用场景与示例-1">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-3">核心技能点总结</a></li>
        <li><a href="#2d专用版本">2D专用版本：</a>
          <ol>
            <li><a href="#摄像机缩放">摄像机缩放：</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#六音效播放器2d">六、音效播放器(2D)</a>
      <ol>
        <li><a href="#代码全景分析-5">代码全景分析</a></li>
        <li><a href="#使用示例">使用示例</a></li>
        <li><a href="#2d-项目必须注意的配置">2D 项目必须注意的配置</a></li>
      </ol>
    </li>
    <li><a href="#七列表洗牌扩展">七、列表洗牌扩展</a>
      <ol>
        <li><a href="#代码全景分析-6">代码全景分析</a></li>
        <li><a href="#使用场景与示例-2">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-4">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#八拖拽瞄准控制器">八、拖拽瞄准控制器</a>
      <ol>
        <li><a href="#代码全景分析-7">代码全景分析</a></li>
        <li><a href="#1直线瞄准">1.直线瞄准</a></li>
        <li><a href="#使用场景与示例-3">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-2d-特化">核心技能点总结 (2D 特化)</a></li>
        <li><a href="#2抛物线瞄准">2.抛物线瞄准</a></li>
        <li><a href="#如何设置-unity-组件">如何设置 Unity 组件</a></li>
      </ol>
    </li>
    <li><a href="#九数值与ui绑定系统">九、数值与UI绑定系统</a>
      <ol>
        <li><a href="#代码全景分析-8">代码全景分析</a></li>
        <li><a href="#使用场景示例ui-血条绑定">使用场景示例：UI 血条绑定</a></li>
        <li><a href="#playercs-角色脚本">Player.cs (角色脚本)</a></li>
        <li><a href="#核心技能点总结-5">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十对象池框架">十、对象池框架</a>
      <ol>
        <li><a href="#代码全景分析-9">代码全景分析</a></li>
        <li><a href="#使用场景与示例-4">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-6">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十一视觉反馈">十一、视觉反馈</a>
      <ol>
        <li><a href="#代码全景分析-10">代码全景分析</a></li>
        <li><a href="#核心技能点总结-7">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十二刚体速度保持传送门">十二、刚体速度保持/传送门</a>
      <ol>
        <li><a href="#代码全景分析-11">代码全景分析</a>
          <ol>
            <li></li>
          </ol>
        </li>
        <li><a href="#核心技能点总结-8">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十三智能生命周期控制器">十三、智能生命周期控制器</a>
      <ol>
        <li><a href="#代码全景分析-12">代码全景分析</a></li>
        <li><a href="#场景示例错误示范-vs-正确示范">场景示例（错误示范 vs 正确示范）</a></li>
        <li><a href="#2d-特效管理的最佳实践">2D 特效管理的最佳实践</a></li>
      </ol>
    </li>
    <li><a href="#十五2d旋转器">十五、2D旋转器</a>
      <ol>
        <li><a href="#代码全景分析-13">代码全景分析</a></li>
      </ol>
    </li>
    <li><a href="#十六鼠标点击响应器">十六、鼠标点击响应器</a>
      <ol>
        <li><a href="#代码全景分析-14">代码全景分析</a></li>
        <li><a href="#使用场景与示例-5">使用场景与示例</a></li>
        <li><a href="#关键设置必须做否则代码无效">关键设置（必须做，否则代码无效！）</a></li>
        <li><a href="#核心技能点总结-9">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十七延迟执行器">十七、延迟执行器</a>
      <ol>
        <li><a href="#代码全景分析-15">代码全景分析</a></li>
        <li><a href="#用场景与示例">用场景与示例</a></li>
        <li><a href="#核心技能点总结-10">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十八富文本构建器">十八、富文本构建器</a>
      <ol>
        <li><a href="#代码全景分析-16">代码全景分析</a></li>
        <li><a href="#使用场景与示例-6">使用场景与示例</a></li>
        <li><a href="#示例代码">示例代码</a>
          <ol>
            <li><a href="#优化">优化：</a></li>
          </ol>
        </li>
        <li><a href="#核心技能点总结-11">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#十九帧率计数器">十九、帧率计数器</a>
      <ol>
        <li><a href="#代码全景分析-17">代码全景分析</a></li>
        <li><a href="#使用场景">使用场景</a></li>
        <li><a href="#如何在项目中使用setup">如何在项目中使用（Setup）</a></li>
        <li><a href="#核心技能点总结-12">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十刚体冻结器">二十、刚体冻结器</a>
      <ol>
        <li><a href="#代码全景分析-18">代码全景分析</a></li>
        <li><a href="#使用场景与示例-7">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-13">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十一随机激活器">二十一、随机激活器</a>
      <ol>
        <li><a href="#代码全景分析-19">代码全景分析</a></li>
        <li><a href="#使用场景与示例-8">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-14">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十二全局事件总线">二十二、全局事件总线</a>
      <ol>
        <li><a href="#代码全景分析-20">代码全景分析</a></li>
        <li><a href="#使用场景与示例-9">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-15">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十三有限状态机">二十三、有限状态机</a>
      <ol>
        <li><a href="#代码全景分析-21">代码全景分析</a></li>
        <li><a href="#使用场景与示例编写一个-2d-巡逻怪">使用场景与示例：编写一个 2D 巡逻怪</a></li>
        <li><a href="#核心技能点总结-16">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十四数值修饰器">二十四、数值修饰器</a>
      <ol>
        <li><a href="#代码全景分析-22">代码全景分析</a></li>
        <li><a href="#使用场景与示例-10">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-17">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十五音频管理器">二十五、音频管理器</a>
      <ol>
        <li><a href="#代码全景分析-23">代码全景分析</a></li>
        <li><a href="#使用场景与示例-11">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-18">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#音频系统结合">[音频系统结合]</a>
      <ol>
        <li><a href="#使用指南如何调用">使用指南：如何调用？</a></li>
      </ol>
    </li>
    <li><a href="#二十六调试控制台">二十六、调试控制台</a>
      <ol>
        <li><a href="#代码全景分析-24">代码全景分析</a></li>
        <li><a href="#使用场景-1">使用场景</a></li>
        <li><a href="#核心技能点总结-19">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十七数据持久化">二十七、数据持久化</a>
      <ol>
        <li><a href="#代码全景分析-25">代码全景分析</a></li>
        <li><a href="#使用场景与示例-12">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-20">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十八顿帧时间冻结管理器">二十八、顿帧/时间冻结管理器</a>
      <ol>
        <li><a href="#代码全景分析-26">代码全景分析</a></li>
        <li><a href="#使用场景示例连击与处决">使用场景示例：连击与处决</a></li>
        <li><a href="#核心技能点总结-21">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#二十九加权随机算法">二十九、加权随机算法</a>
      <ol>
        <li><a href="#代码全景分析-27">代码全景分析</a></li>
        <li><a href="#使用场景与示例-13">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-22">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十通用悬停提示器">三十、通用悬停提示器</a>
      <ol>
        <li><a href="#代码全景分析-28">代码全景分析</a></li>
        <li><a href="#如何在-unity-中组装setup">如何在 Unity 中组装（Setup）</a></li>
        <li><a href="#核心技能点总结-23">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十一冷却时间追踪器">三十一、冷却时间追踪器</a>
      <ol>
        <li><a href="#代码全景分析-29">代码全景分析</a></li>
        <li><a href="#使用场景与示例-14">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-24">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十二视差滚动背景">三十二、视差滚动背景</a>
      <ol>
        <li><a href="#代码全景分析-30">代码全景分析</a></li>
        <li><a href="#如何在-unity-中搭建无限背景">如何在 Unity 中搭建无限背景</a></li>
        <li><a href="#核心技能点总结-25">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十三屏幕边界限制器">三十三、屏幕边界限制器</a>
      <ol>
        <li><a href="#代码全景分析-31">代码全景分析</a></li>
        <li><a href="#核心技能点总结-26">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十四协程锁">三十四、协程锁</a>
      <ol>
        <li><a href="#代码全景分析-32">代码全景分析</a></li>
        <li><a href="#使用场景与示例-15">使用场景与示例</a></li>
        <li><a href="#核心技能点总结-27">核心技能点总结</a></li>
      </ol>
    </li>
    <li><a href="#三十五版本号显示器">三十五、版本号显示器</a>
      <ol>
        <li><a href="#代码全景分析-33">代码全景分析</a></li>
        <li><a href="#使用场景与配置">使用场景与配置</a></li>
        <li></li>
        <li><a href="#核心技能点总结-28">核心技能点总结</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/unity%E6%A8%A1%E5%9D%97%E5%8C%96%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1/">Unity模块化代码设计</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published" datetime='2025-12-05T19:21:47&#43;08:00'>2025-12-05</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="一泛型基类通用单例模式">一、泛型基类（通用单例模式）
</h2><h3 id="代码全景分析">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：确保在整个游戏中，某个类（比如 GameManager）<strong>有且仅有一个实例</strong>，并提供一个全局的访问点（Instance），让任何其他脚本都能轻松调用它。</p>
</li>
<li>
<p><strong>设计模式</strong>：单例模式（Singleton Pattern）。</p>
</li>
<li>
<p><strong>技术亮点</strong>：使用了 <strong>C# 泛型（Generics）</strong>，这意味着你只需要写一次这个基类，以后任何管理类想要变身单例，只需要继承它即可，无需重复写单例逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 泛型单例基类 - 工业级版本</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;para&gt;用法：public class MyManager : Singleton&lt;MyManager&gt;&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Singleton</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">_instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 线程锁，防止多线程并发访问时生成多个实例（虽然Unity大部分API非线程安全，但这是好习惯）</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 标记程序是否正在退出</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">bool</span> <span class="n">_isQuitting</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">Instance</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果游戏正在退出，不再创建新的单例，防止报错</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_isQuitting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">$&#34;[Singleton] 游戏正在退出，不再创建 {typeof(T)} 的实例。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">lock</span> <span class="p">(</span><span class="n">_lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 1. 尝试在场景中查找</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_instance</span> <span class="p">=</span> <span class="n">FindObjectOfType</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 2. 如果场景中没有，自动创建一个</span>
</span></span><span class="line"><span class="cl">                        <span class="n">GameObject</span> <span class="n">singletonObj</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">_instance</span> <span class="p">=</span> <span class="n">singletonObj</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">singletonObj</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">&#34;(Singleton) &#34;</span> <span class="p">+</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;[Singleton] 场景中不存在 {typeof(T)}，已自动创建。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_instance</span> <span class="p">=</span> <span class="k">this</span> <span class="k">as</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">DontDestroyOnLoad</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span> <span class="c1">// 保证切场景不销毁</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">!=</span> <span class="k">this</span><span class="p">)</span> <span class="c1">// 【关键修复】确保不是“自己杀自己”</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">$&#34;[Singleton] 发现重复的 {typeof(T)}，销毁物体: {gameObject.name}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 当游戏退出或场景切换销毁时调用</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">OnDestroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">this</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_isQuitting</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="示例子类">示例子类：
</h4><pre><code>// 注意这里：继承 Singleton&lt;AudioManager&gt;
public class AudioManager : Singleton&lt;AudioManager&gt;
{
    // 子类如果有自己的Awake，必须调用 base.Awake() !!!
    protected override void Awake()
    {
        base.Awake(); // 必须保留这句，否则单例赋值逻辑会失效
        InitializeAudio();
    }

    public void PlaySound(string clipName)
    {
        Debug.Log(&quot;播放音效: &quot; + clipName);
    }

    private void InitializeAudio() { /*...*/ }
}
</code></pre>
<h4 id="在其他脚本中调用">在其他脚本中调用：
</h4><pre><code>public class PlayerAttack : MonoBehaviour
{
    void Attack()
    {
        // 哪怕你没有持有AudioManager的引用，也可以直接调用
        AudioManager.Instance.PlaySound(&quot;SwordSwing&quot;);
    }
}
</code></pre>
<p><strong>核心技能总结</strong></p>
<ol>
<li>
<p><strong>⚔️ C# 语言特性维度</strong>
A. 泛型约束 (Generic Constraints)
代码体现：where T : MonoBehaviour
核心知识：
泛型不是随便传的，我们必须告诉编译器 T 必须是 MonoBehaviour 的子类。
为什么要约束？ 因为只有 MonoBehaviour 才有 FindObjectOfType、Destroy、gameObject 这些属性和方法。如果不约束，编译器会报错。
B. 静态 vs 实例 (Static vs Instance)
代码体现：private static T _instance vs public void PlayMusic()
核心知识：
静态 (static)：属于类本身，内存中只有一份，生命周期伴随整个程序运行。这是单例“全局唯一”的物理基础。
实例 (this)：属于 new 出来的对象（或 AddComponent 出来的组件）。
难点：在静态属性（Instance）中，不能直接访问非静态成员（除非先有了实例 _instance）。
C. 属性封装与懒加载 (Lazy Loading)
代码体现：get { if (_instance == null) &hellip; }
核心知识：
单例不应该在游戏一开始就全部创建（那样启动会很卡）。
懒加载：只有当你第一次调用 GameManager.Instance 时，它才会被创建或查找。这是一种用“第一次调用的微小卡顿”换取“快速启动”的优化策略。</p>
</li>
<li>
<p><strong>⚙️ Unity 引擎机制维度</strong>
A. 脚本生命周期 (Script Lifecycle)
核心知识：
Awake：是初始化的最佳时机。单例的赋值必须在 Awake，而不是 Start，确保其他脚本在 Start 调用单例时，单例已经准备好了。
执行顺序陷阱：Unity 中不同脚本的 Awake 执行顺序是不确定的。所以必须支持自动创建或懒加载，防止脚本 A 调用脚本 B 的单例时，脚本 B 还没醒来。
B. 场景持久化 (Persistence)
代码体现：DontDestroyOnLoad(gameObject)
核心知识：默认情况下，加载新场景时，旧场景的所有物体都会被销毁。
单例通常是全局管理器，必须使用此 API 让其“穿越”场景而不被销毁。
C. 对象查找开销代码体现：FindObjectOfType<T>()
核心知识：
这是一个非常昂贵的操作（遍历内存中所有对象）。
单例的价值：缓存（Cache）了这个结果。第一次慢，后面每次访问 Instance 都是 O(1) 的速度，极快。</p>
</li>
<li>
<p><strong>🛡️ 架构与防御性编程（资深必备</strong>）
A. 竞态条件与自杀 Bug (Race Condition)
代码体现：else if (_instance != this)
核心知识：
理解为什么简单的 else { Destroy } 会导致单例把自己删掉。
这是多脚本协作时的逻辑漏洞，必须区分“存在的那个是不是我”。
B. 退出清理保护 (Quit Safety)
代码体现：_isQuitting 标记
核心知识：
Unity 关闭游戏时，会按随机顺序销毁对象。
如果 A 在销毁时调用了 B 的单例，而 B 已经被销毁了，普通的单例逻辑会试图创建一个新的 B（因为 _instance 为空）。
这会导致报错：Some objects were not cleaned up when closing the scene。必须用标志位拦截。
C. 线程安全 (Thread Safety)
代码体现：lock(_lock)
核心知识：
虽然 Unity 的 API（如 FindObjectOfType）只能在主线程跑，但 C# 逻辑层可能是多线程的（如网络消息回调）。
加锁是为了防止极端的并发情况下创建出两个单例对象。这是工业级代码的规范体现。</p>
</li>
<li>
<p><strong>📝 最佳实践口诀</strong>
为了让你在实际开发中不出错，记住这三条：
子类 Awake 必加 base：
只要继承了 Singleton<T>，写 Awake 时第一行必须是 base.Awake()，否则单例逻辑失效。
不要在 OnDestroy 乱调单例：
尽量避免在物体销毁时去调用其他的单例管理器，很容易触发“僵尸对象”报错。
单例不是万能药：慎用：不要把所有类都做成单例。只有<strong>全局唯一</strong>且<strong>需要跨域访问</strong>的管理器（如音频、UI、游戏状态）才适合。如果滥用单例，代码耦合度会极高，导致后期难以维护。</p>
</li>
</ol>
<h2 id="二基于-dotween-插件的场景切换控制器继承泛型单例">二、基于 DOTween 插件的场景切换控制器(继承泛型单例)
</h2><h3 id="代码全景分析-1">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：提供一个全局接口 LoadScene(string name)，调用后执行流程：<strong>屏幕变黑 -&gt; 异步加载新场景 -&gt; 屏幕变亮</strong>。</p>
</li>
<li>
<p><strong>关键技术</strong>：</p>
<ul>
<li>
<p><strong>Coroutine (协程)</strong>：处理随时间发生的逻辑（先淡出，再加载，再淡入）。</p>
</li>
<li>
<p><strong>AsyncOperation</strong>：Unity 的后台加载机制，防止加载大场景时游戏彻底卡死。</p>
</li>
<li>
<p><strong>CanvasGroup</strong>：控制 UI 透明度和交互的最优组件。</p>
</li>
<li>
<p><strong>DOTween</strong>：用于丝滑地处理数值（透明度）变化。</p>
</li>
</ul>
</li>
</ul>
<p><strong>准备工作（在 Unity 编辑器中）：</strong></p>
<ol>
<li>
<p><strong>创建 UI</strong>：</p>
<ul>
<li>
<p>创建一个 Canvas，Sort Order 设置为 <strong>999</strong>（确保它永远覆盖在最上层）。</p>
</li>
<li>
<p>创建一个全屏黑色的 Panel (Image)。</p>
</li>
<li>
<p>给这个 Panel 添加 CanvasGroup 组件，把 Alpha 设为 0，勾选 Blocks Raycasts。</p>
</li>
<li>
<p><strong>重要</strong>：取消勾选 Interactable 和 Blocks Raycasts（初始状态应不阻挡点击，只有切换时才阻挡）。</p>
</li>
</ul>
</li>
<li>
<p><strong>挂载脚本</strong>：</p>
<ul>
<li>
<p>创建一个空物体 SceneSystem，挂上此脚本。</p>
</li>
<li>
<p>把刚才那个 Panel 拖给 fadeCanvasGroup 变量。</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.SceneManagement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span> <span class="c1">// 用于 Action 回调</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 1. 继承之前的工业级泛型单例</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">SceneTransitionController</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">SceneTransitionController</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;UI 设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;必须赋值：用于遮挡画面的带有 CanvasGroup 的 UI 物体&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CanvasGroup</span> <span class="n">fadeCanvasGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Image</span> <span class="n">progressBar</span><span class="p">;</span> <span class="c1">// 可选：进度条</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">fadeDuration</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 添加一个事件，当加载开始和结束时通知外部（例如停止背景音乐）</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">event</span> <span class="n">Action</span> <span class="n">OnLoaderStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">event</span> <span class="n">Action</span> <span class="n">OnLoaderComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span> <span class="c1">// 别忘了这句！</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 防呆设计：如果没赋值，尝试自己找一下，或者报错</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fadeCanvasGroup</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fadeCanvasGroup</span> <span class="p">=</span> <span class="n">GetComponentInChildren</span><span class="p">&lt;</span><span class="n">CanvasGroup</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">fadeCanvasGroup</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">&#34;❌ SceneTransitionController: 忘了赋值 FadeCanvasGroup！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始状态确保是透的且不阻挡点击</span>
</span></span><span class="line"><span class="cl">        <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 加载场景</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;sceneName&#34;&gt;场景名&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;onSceneLoaded&#34;&gt;可选：场景加载完毕但在淡入前的回调（比如初始化玩家位置）&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">LoadScene</span><span class="p">(</span><span class="kt">string</span> <span class="n">sceneName</span><span class="p">,</span> <span class="n">Action</span> <span class="n">onSceneLoaded</span> <span class="p">=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">ProcessSceneLoading</span><span class="p">(</span><span class="n">sceneName</span><span class="p">,</span> <span class="n">onSceneLoaded</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">ProcessSceneLoading</span><span class="p">(</span><span class="kt">string</span> <span class="n">sceneName</span><span class="p">,</span> <span class="n">Action</span> <span class="n">onSceneLoaded</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 触发开始事件</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnLoaderStart</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 阻挡点击并淡出（变黑）</span>
</span></span><span class="line"><span class="cl">        <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="n">fadeDuration</span><span class="p">).</span><span class="n">WaitForCompletion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 异步加载</span>
</span></span><span class="line"><span class="cl">        <span class="n">AsyncOperation</span> <span class="n">asyncLoad</span> <span class="p">=</span> <span class="n">SceneManager</span><span class="p">.</span><span class="n">LoadSceneAsync</span><span class="p">(</span><span class="n">sceneName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">asyncLoad</span><span class="p">.</span><span class="n">allowSceneActivation</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 关键：先不自动切换，等我们手动放行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 模拟进度条逻辑</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// AsyncOperation 的 progress 只会从 0 走到 0.9，剩下 0.1 是激活阶段</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">asyncLoad</span><span class="p">.</span><span class="n">progress</span> <span class="p">&lt;</span> <span class="m">0.9f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">progressBar</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">fillAmount</span> <span class="p">=</span> <span class="n">asyncLoad</span><span class="p">.</span><span class="n">progress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 补满进度条视觉</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">progressBar</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">fillAmount</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 等待一小会儿让玩家看清进度条满了（可选体验优化）</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSeconds</span><span class="p">(</span><span class="m">0.2f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 允许切换场景</span>
</span></span><span class="line"><span class="cl">        <span class="n">asyncLoad</span><span class="p">.</span><span class="n">allowSceneActivation</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 等待场景彻底初始化完毕</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(!</span><span class="n">asyncLoad</span><span class="p">.</span><span class="n">isDone</span><span class="p">)</span> <span class="k">yield</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行场景加载完成的逻辑（比如生成主角）</span>
</span></span><span class="line"><span class="cl">        <span class="n">onSceneLoaded</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 淡入（变透明）并恢复点击</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">fadeDuration</span><span class="p">).</span><span class="n">WaitForCompletion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">fadeCanvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 触发结束事件</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnLoaderComplete</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h4 id="代码调用示例">代码调用示例：
</h4><pre><code>public class MainMenu : MonoBehaviour
{
    public void OnStartButtonClick()
    {
        // 点击后，平滑过渡到 &quot;GameScene&quot;
        SceneTransitionController.Instance.LoadScene(&quot;GameScene&quot;);
    }
}
</code></pre>
<h3 id="核心技能点总结">核心技能点总结
</h3><ol>
<li>
<p><strong>CanvasGroup vs SetActive</strong>：</p>
<ul>
<li>做 UI 渐隐渐显，永远首选 CanvasGroup。它比控制 GameObject.SetActive 开销略大，但它能处理 Alpha 渐变，还能通过 Interactable 和 BlocksRaycasts 批量控制交互，非常适合做遮罩。</li>
</ul>
</li>
<li>
<p><strong>DOTween 协程集成</strong>：</p>
<ul>
<li>掌握 WaitForCompletion()。它让你可以像写线性代码一样写动画逻辑，避免了复杂的“回调地狱”（Callback Hell）。</li>
</ul>
</li>
<li>
<p><strong>AsyncOperation 的 0.9 陷阱</strong>：</p>
<ul>
<li>面试常问：asyncLoad.progress 最多只能到 0.9。如果你设置了 allowSceneActivation = false，它就会卡在 0.9 等待你设置为 true。</li>
</ul>
</li>
<li>
<p><strong>DontDestroyOnLoad 的 UI 坑</strong>：</p>
<ul>
<li>由于这个 Canvas 是 DontDestroyOnLoad 的，它里面引用的 Camera (Render Camera) 在切换场景后可能会丢失（如果你的 Canvas 是 Screen Space - Camera 模式）。通常建议加载过渡页使用 <strong>Screen Space - Overlay</strong> 模式，这样不需要依赖摄像机。</li>
</ul>
</li>
</ol>
<h2 id="三3d公告板相机">三、3D公告板（相机）：
</h2><h3 id="代码全景分析-2">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：让挂载此脚本的物体（通常是 Quad 面片或 Canvas）始终朝向摄像机。</p>
</li>
<li>
<p><strong>应用场景</strong>：</p>
<ol>
<li>
<p><strong>头顶血条/名字</strong>：无论玩家怎么转视角，血条永远正对屏幕。</p>
</li>
<li>
<p><strong>场景装饰</strong>：低消耗的树木、草丛（LOD技术），远看是纸片，但永远面朝你，看起来像立体的。</p>
</li>
<li>
<p><strong>物品掉落</strong>：地上的金币、装备图标。</p>
</li>
</ol>
</li>
<li>
<p><strong>关键逻辑</strong>：使用了 LateUpdate 配合 LookAt 算法。</p>
</li>
</ul>
<p><strong>使用示例：</strong></p>
<p><strong>场景 A：怪物头顶的血条</strong></p>
<ol>
<li>
<p>创建一个 Canvas，设置为 World Space。</p>
</li>
<li>
<p>在 Canvas 下放一个 Slider（血条）。</p>
</li>
<li>
<p>把这个 Canvas 放在怪物的子物体里，调整到头顶位置。</p>
</li>
<li>
<p><strong>挂载此脚本</strong>，取消勾选 lockYAxis。</p>
<ul>
<li>效果：无论你从天上看还是侧面看，血条永远正正方方地显示在屏幕上。</li>
</ul>
</li>
</ol>
<p><strong>场景 B：场景里的纸片树</strong></p>
<ol>
<li>
<p>创建一个 Quad（四边形面片），贴上树的纹理（透明贴图）。</p>
</li>
<li>
<p><strong>挂载此脚本</strong>，<strong>勾选</strong> lockYAxis。</p>
<ul>
<li>
<p>效果：当你在地面跑动时，树会绕着 Y 轴转动面朝你；当你飞到空中俯视时，树依然直立，不会倒下，符合透视规律。</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Billboard</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否锁定Y轴（树木/地面NPC选True，飞行物/血条UI选False）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">lockYAxis</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;如果贴图显示反了，勾选此项进行翻转&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">reverseFace</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 自动寻找摄像机的策略</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">_targetCamera</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化时找一次</span>
</span></span><span class="line"><span class="cl">        <span class="n">UpdateCameraReference</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 每一帧检查一下摄像机是否存在（轻量级检查）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_targetCamera</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">UpdateCameraReference</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果还是找不到（比如场景里没摄像机），直接退出，防止报错</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_targetCamera</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 获取目标向量（与其说是“看着摄像机”，不如说是“与摄像机平行”）</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用 transform.forward = camera.transform.forward 是最高效的，不需要 LookAt 计算</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">targetForward</span> <span class="p">=</span> <span class="n">_targetCamera</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 处理反向</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">reverseFace</span><span class="p">)</span> <span class="n">targetForward</span> <span class="p">=</span> <span class="p">-</span><span class="n">targetForward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 处理 Y 轴锁定</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lockYAxis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 投影到水平面：把 Y 轴分量去掉</span>
</span></span><span class="line"><span class="cl">            <span class="n">targetForward</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">targetForward</span><span class="p">.</span><span class="n">Normalize</span><span class="p">();</span> <span class="c1">// 归一化，防止向量长度变为0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 应用旋转</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 直接修改 forward 比 LookAt 性能稍微好一点点，且逻辑更直观</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">targetForward</span> <span class="p">!=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">transform</span><span class="p">.</span><span class="n">forward</span> <span class="p">=</span> <span class="n">targetForward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 封装查找摄像机的逻辑，方便后续扩展</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">UpdateCameraReference</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_targetCamera</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-1">核心技能点总结
</h3><ol>
<li>
<p><strong>LateUpdate 的重要性</strong>：任何跟随摄像机移动或旋转的物体（UI、跟随宠物、摄像机臂），<strong>必须</strong>放在 LateUpdate，否则必然抖动。</p>
</li>
<li>
<p><strong>LookAt 的两种流派</strong>：</p>
<ul>
<li>
<p>LookAt(target)：聚光灯效果，物体都指向中心点（适合炮台、眼球）。</p>
</li>
<li>
<p>forward = target.forward（或原代码的写法）：平行光效果，所有物体朝向一致（适合 UI、粒子、Billboard）。</p>
</li>
</ul>
</li>
<li>
<p><strong>缓存 Camera.main</strong>：虽然 Unity 2020+ 对 Camera.main 做了优化，但在 Update 这种高频调用中，缓存引用依然是不可动摇的黄金法则。</p>
</li>
</ol>
<h3 id="25d适用版本">2.5D适用版本：
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Billboard2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;2.5D 设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;通常 2.5D 游戏（如饥荒）需要锁定 Y 轴，让物体站立&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">lockYAxis</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Transform</span> <span class="n">_camTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Quaternion</span> <span class="n">_originalRotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Camera</span><span class="p">.</span><span class="n">main</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">_camTransform</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">transform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录初始旋转，防止脚本把美术原本调好的倾角覆盖了</span>
</span></span><span class="line"><span class="cl">        <span class="n">_originalRotation</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_camTransform</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 获取摄像机的朝向</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">forward</span> <span class="p">=</span> <span class="n">_camTransform</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 如果是 2.5D 树木/人物，必须锁定 Y 轴（只绕 Y 转，不抬头低头）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lockYAxis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">forward</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">forward</span><span class="p">.</span><span class="n">Normalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 应用旋转</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注意：这里我们只改变 LookRotation，但保留物体自身的 Up 向量</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这样可以避免一些奇怪的翻转问题</span>
</span></span><span class="line"><span class="cl">        <span class="n">transform</span><span class="p">.</span><span class="n">rotation</span> <span class="p">=</span> <span class="n">Quaternion</span><span class="p">.</span><span class="n">LookRotation</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="四ui的淡入淡出dotween">四、UI的淡入淡出（Dotween)
</h2><h3 id="代码全景分析-3">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：控制 UI 面板的 <strong>显示 (Show)</strong> 和 <strong>隐藏 (Hide)</strong>，并自动处理过渡动画。</p>
</li>
<li>
<p><strong>关键组件</strong>：CanvasGroup（核心）、DOTween（动画驱动）。</p>
</li>
<li>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>
<p><strong>DOKill()</strong>：防止玩家手速过快（疯狂开关面板）导致的动画冲突。</p>
</li>
<li>
<p><strong>Action 回调</strong>：允许动画播放完后执行逻辑（比如关闭窗口后销毁数据）。</p>
</li>
<li>
<p><strong>SetActive 优化</strong>：隐藏后关闭物体，避免不可见的 UI 继续消耗 CPU/GPU 资源（Draw Calls &amp; Raycast 计算）。</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(CanvasGroup))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UIPanelFader</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;动画设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">duration</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Ease</span> <span class="n">showEase</span> <span class="p">=</span> <span class="n">Ease</span><span class="p">.</span><span class="n">OutBack</span><span class="p">;</span> <span class="c1">// 推荐：带一点回弹，手感更好</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Ease</span> <span class="n">hideEase</span> <span class="p">=</span> <span class="n">Ease</span><span class="p">.</span><span class="n">InBack</span><span class="p">;</span>  <span class="c1">// 推荐：缩回去时的加速感</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;功能开关&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">animateScale</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>     <span class="c1">// 是否启用缩放动画</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">startHidden</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CanvasGroup</span> <span class="n">_canvasGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RectTransform</span> <span class="n">_rectTransform</span><span class="p">;</span> <span class="c1">// 用于缩放动画</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">CanvasGroup</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rectTransform</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">RectTransform</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">startHidden</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HideImmediate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Show</span><span class="p">(</span><span class="n">Action</span> <span class="n">onComplete</span> <span class="p">=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 准备工作</span>
</span></span><span class="line"><span class="cl">        <span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">animateScale</span><span class="p">)</span> <span class="n">_rectTransform</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 如果是从隐藏状态开始，重置初始值</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果当前已经是半透明（比如 alpha 0.5），则不重置，直接继续渐变</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_canvasGroup</span><span class="p">.</span><span class="n">alpha</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">animateScale</span><span class="p">)</span> <span class="n">_rectTransform</span><span class="p">.</span><span class="n">localScale</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">one</span> <span class="p">*</span> <span class="m">0.8f</span><span class="p">;</span> <span class="c1">// 初始大小 0.8</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 执行动画</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="n">duration</span><span class="p">).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// SetUpdate(true) 保证游戏暂停时UI也能动</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">animateScale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_rectTransform</span><span class="p">.</span><span class="n">DOScale</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">one</span><span class="p">,</span> <span class="n">duration</span><span class="p">).</span><span class="n">SetEase</span><span class="p">(</span><span class="n">showEase</span><span class="p">).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 延迟调用完成回调</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这里用 Sequence 或者简单的 Timer 都可以，DOTween 的 OnComplete 挂在一个 Tween 上即可</span>
</span></span><span class="line"><span class="cl">        <span class="n">DOVirtual</span><span class="p">.</span><span class="n">DelayedCall</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">interactable</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">onComplete</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Hide</span><span class="p">(</span><span class="n">Action</span> <span class="n">onComplete</span> <span class="p">=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">animateScale</span><span class="p">)</span> <span class="n">_rectTransform</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 立即禁止交互</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">interactable</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 执行动画</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">duration</span><span class="p">).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">animateScale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_rectTransform</span><span class="p">.</span><span class="n">DOScale</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">one</span> <span class="p">*</span> <span class="m">0.8f</span><span class="p">,</span> <span class="n">duration</span><span class="p">).</span><span class="n">SetEase</span><span class="p">(</span><span class="n">hideEase</span><span class="p">).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 完成清理</span>
</span></span><span class="line"><span class="cl">        <span class="n">DOVirtual</span><span class="p">.</span><span class="n">DelayedCall</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">onComplete</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}).</span><span class="n">SetUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">HideImmediate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">interactable</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">blocksRaycasts</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景与示例">使用场景与示例
</h3><p><strong>场景：一个通用的游戏暂停窗口 (PausePanel)</strong></p>
<p><strong>步骤：</strong></p>
<ol>
<li>
<p>创建一个 UI Panel，命名为 PausePanel。</p>
</li>
<li>
<p>挂载 UIPanelFader 脚本（会自动添加 CanvasGroup）。</p>
</li>
<li>
<p>编写一个管理器来控制它：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UIManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UIPanelFader</span> <span class="n">pausePanel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 当玩家按下 ESC 键</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">TogglePauseMenu</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pausePanel</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">activeSelf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 关闭时，我想在完全看不见后，打印一句话</span>
</span></span><span class="line"><span class="cl">            <span class="n">pausePanel</span><span class="p">.</span><span class="n">Hide</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;暂停菜单已完全关闭&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pausePanel</span><span class="p">.</span><span class="n">Show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="核心技能点总结-2">核心技能点总结
</h3><ol>
<li>
<p><strong>CanvasGroup 的统治力</strong>：</p>
<ul>
<li>
<p>做 UI 整体显隐，<strong>永远</strong>使用 CanvasGroup，不要去遍历修改 Image.color。</p>
</li>
<li>
<p>CanvasGroup 修改 Alpha 只会产生极少的 DrawCall 开销，而且能统一控制子物体的透明度。</p>
</li>
</ul>
</li>
<li>
<p><strong>Tween 的生命周期管理</strong>：</p>
<ul>
<li>必须掌握 DOKill()。在异步动画的世界里，永远假设用户会以每秒 10 次的速度狂点按钮，你的代码必须能处理这种情况。</li>
</ul>
</li>
<li>
<p><strong>UI 不受时间缩放影响</strong>：</p>
<ul>
<li>牢记 SetUpdate(true)。UI（尤其是暂停菜单、设置菜单）必须独立于游戏时间（TimeScale）运行。</li>
</ul>
</li>
<li>
<p><strong>交互阻断 (Raycast Blocking)</strong>：</p>
<ul>
<li>隐藏动画开始时，<strong>第一件事</strong>就是关掉射线检测 (blocksRaycasts = false)。这是用户体验优化的铁律。</li>
</ul>
</li>
</ol>
<h2 id="五ui跟随2d可用">五、UI跟随（2D可用）
</h2><h3 id="代码全景分析-4">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：每一帧计算目标物体在屏幕上的位置，并把 UI 移动到那里。</p>
</li>
<li>
<p><strong>适用场景</strong>：Canvas 模式为 <strong>Screen Space - Overlay</strong> 或 <strong>Screen Space - Camera</strong> 的情况。</p>
</li>
<li>
<p><strong>关键算法</strong>：Camera.WorldToScreenPoint。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UIFollowWorldObject</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;基础偏移量（基于参考分辨率，例如1920x1080）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">baseOffset</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否限制在屏幕范围内（类似指示器）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">clampToScreen</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Transform</span> <span class="n">_targetTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">_mainCamera</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RectTransform</span> <span class="n">_myRectTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CanvasGroup</span> <span class="n">_canvasGroup</span><span class="p">;</span> <span class="c1">// 用于优化显隐</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Canvas</span> <span class="n">_parentCanvas</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_myRectTransform</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">RectTransform</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_canvasGroup</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">CanvasGroup</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果没有 CanvasGroup，自动加一个，用于高性能显隐</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_canvasGroup</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">_canvasGroup</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">CanvasGroup</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取父级 Canvas，用于计算缩放</span>
</span></span><span class="line"><span class="cl">        <span class="n">_parentCanvas</span> <span class="p">=</span> <span class="n">GetComponentInParent</span><span class="p">&lt;</span><span class="n">Canvas</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始缓存摄像机</span>
</span></span><span class="line"><span class="cl">        <span class="n">UpdateCamera</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetTarget</span><span class="p">(</span><span class="n">Transform</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_targetTransform</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 安全检查</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_targetTransform</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 摄像机缓存检查（防止摄像机切换后丢失）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_mainCamera</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">UpdateCamera</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_mainCamera</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 还是没摄像机，啥也不干</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 计算屏幕坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">worldPos</span> <span class="p">=</span> <span class="n">_targetTransform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">screenPos</span> <span class="p">=</span> <span class="n">_mainCamera</span><span class="p">.</span><span class="n">WorldToScreenPoint</span><span class="p">(</span><span class="n">worldPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 处理背后逻辑 (Z &lt; 0)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">isBehind</span> <span class="p">=</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">z</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">isBehind</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">clampToScreen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 5. 计算真正的偏移量（关键点：分辨率自适应）</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取 Canvas 的缩放因子，让 50px 在 4K 屏上自动变成 100px</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">scaleFactor</span> <span class="p">=</span> <span class="n">_parentCanvas</span><span class="p">.</span><span class="n">scaleFactor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">finalOffset</span> <span class="p">=</span> <span class="n">baseOffset</span> <span class="p">*</span> <span class="n">scaleFactor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 6. 应用坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">finalPos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">screenPos</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">finalOffset</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">finalOffset</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// (选做) 限制在屏幕边缘逻辑</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">clampToScreen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果在背后，要把坐标翻转过来，否则指示器方向是反的</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">isBehind</span><span class="p">)</span> <span class="n">finalPos</span> <span class="p">*=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 限制坐标在屏幕范围内</span>
</span></span><span class="line"><span class="cl">            <span class="n">finalPos</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">finalPos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">finalPos</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">finalPos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 只要开启限制，就永远显示</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 普通模式：在屏幕范围内才显示</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">isOnScreen</span> <span class="p">=</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">x</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">x</span> <span class="p">&lt;</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span> <span class="p">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">                              <span class="n">screenPos</span><span class="p">.</span><span class="n">y</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">y</span> <span class="p">&lt;</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetVisible</span><span class="p">(</span><span class="n">isOnScreen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_myRectTransform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">finalPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 性能优化：使用 CanvasGroup 来显隐，避免 Canvas Rebuild</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">SetVisible</span><span class="p">(</span><span class="kt">bool</span> <span class="n">visible</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">targetAlpha</span> <span class="p">=</span> <span class="n">visible</span> <span class="p">?</span> <span class="m">1f</span> <span class="p">:</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Approximately</span><span class="p">(</span><span class="n">_canvasGroup</span><span class="p">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">targetAlpha</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_canvasGroup</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">targetAlpha</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">UpdateCamera</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mainCamera</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用场景与示例-1">使用场景与示例
</h3><p><strong>场景：制作一个怪物头顶的血条</strong></p>
<ol>
<li>
<p><strong>准备 UI</strong>：</p>
<ul>
<li>
<p>在 Canvas (Screen Space - Overlay) 下创建一个 Image（作为血条背景）。</p>
</li>
<li>
<p>将此脚本挂载到这个 Image 上。</p>
</li>
</ul>
</li>
<li>
<p><strong>准备怪物</strong>：</p>
<ul>
<li>场景里有一个怪物 Enemy_Goblin。</li>
</ul>
</li>
<li>
<p><strong>连接逻辑</strong>：</p>
<ul>
<li>
<p>你需要一个管理器（或者怪物自身的脚本）在生成怪物时，初始化这个 UI。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Enemy</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">healthBarPrefab</span><span class="p">;</span> <span class="c1">// 拖入刚才做好的 UI Prefab </span>
</span></span><span class="line"><span class="cl">   <span class="k">void</span> <span class="n">Start</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 1. 实例化 UI 到 Canvas 下</span>
</span></span><span class="line"><span class="cl">       <span class="n">GameObject</span> <span class="n">uiObj</span> <span class="p">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">healthBarPrefab</span><span class="p">,</span> <span class="n">FindObjectOfType</span><span class="p">&lt;</span><span class="n">Canvas</span><span class="p">&gt;().</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 2. 获取脚本并设置目标</span>
</span></span><span class="line"><span class="cl">       <span class="n">UIFollowWorldObject</span> <span class="n">follower</span> <span class="p">=</span> <span class="n">uiObj</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">UIFollowWorldObject</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 3. 告诉 UI：你跟着我（this.transform）</span>
</span></span><span class="line"><span class="cl">       <span class="n">follower</span><span class="p">.</span><span class="n">SetTarget</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-3">核心技能点总结
</h3><ol>
<li>
<p><strong>坐标空间转换 (Coordinate Space)</strong>：</p>
<ul>
<li>
<p>必须熟练掌握 WorldToScreenPoint。</p>
</li>
<li>
<p>理解 <strong>World Space</strong>（3D坐标）、<strong>Screen Space</strong>（像素坐标）、<strong>Viewport Space</strong>（0-1 比例坐标）的区别。</p>
</li>
</ul>
</li>
<li>
<p><strong>投影数学 (Projection Math)</strong>：</p>
<ul>
<li>理解为什么 screenPos.z &lt; 0 代表在背后。这是透视投影矩阵运算的结果。</li>
</ul>
</li>
<li>
<p><strong>UI 性能优化</strong>：</p>
<ul>
<li>
<p><strong>Dirty Flag（脏标记）</strong>：UI 动一下代价是很大的（Mesh 重绘）。尽量减少 SetActive，尽量不要每帧修改 Layout 组件。</p>
</li>
<li>
<p>这种跟随脚本最好配合 Canvas 的 <strong>Screen Space - Camera</strong> 模式使用，或者尽量让这些 UI 处于 Canvas 的独立子层级中。</p>
</li>
</ul>
</li>
</ol>
<h3 id="2d专用版本">2D专用版本：
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UIFollow2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;垂直偏移量 (像素)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">yOffset</span> <span class="p">=</span> <span class="m">50f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Transform</span> <span class="n">targetTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">mainCamera</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RectTransform</span> <span class="n">myRectTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Canvas</span> <span class="n">parentCanvas</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainCamera</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">myRectTransform</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">RectTransform</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">parentCanvas</span> <span class="p">=</span> <span class="n">GetComponentInParent</span><span class="p">&lt;</span><span class="n">Canvas</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetTarget</span><span class="p">(</span><span class="n">Transform</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">targetTransform</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">targetTransform</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">mainCamera</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 世界坐标转屏幕坐标</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 2D 正交相机中，Z 轴深度不影响 screenPos.x/y 的结果，只影响 screenPos.z</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">screenPos</span> <span class="p">=</span> <span class="n">mainCamera</span><span class="p">.</span><span class="n">WorldToScreenPoint</span><span class="p">(</span><span class="n">targetTransform</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 2D 游戏特有的剔除逻辑</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 2D 中，我们通常不需要判断 screenPos.z &lt; 0 (因为相机不会旋转到背面)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 但我们需要判断物体是否在屏幕范围内（视锥体剔除），避免在屏幕外还渲染UI</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 简单的做法是：只要 target 活着就显示，复杂的可以计算屏幕边缘</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">gameObject</span><span class="p">.</span><span class="n">activeSelf</span><span class="p">)</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 计算偏移 (结合 Canvas 缩放)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这一步对于适配不同分辨率至关重要</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">finalOffset</span> <span class="p">=</span> <span class="n">yOffset</span> <span class="p">*</span> <span class="n">parentCanvas</span><span class="p">.</span><span class="n">scaleFactor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 赋值</span>
</span></span><span class="line"><span class="cl">        <span class="n">myRectTransform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">screenPos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">screenPos</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">finalOffset</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="摄像机缩放">摄像机缩放：
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 动态偏移算法</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">zoomRatio</span> <span class="p">=</span> <span class="m">5f</span> <span class="p">/</span> <span class="n">mainCamera</span><span class="p">.</span><span class="n">orthographicSize</span><span class="p">;</span> <span class="c1">// 假设 5 是标准大小</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dynamicOffset</span> <span class="p">=</span> <span class="n">yOffset</span> <span class="p">*</span> <span class="n">zoomRatio</span> <span class="p">*</span> <span class="n">parentCanvas</span><span class="p">.</span><span class="n">scaleFactor</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="六音效播放器2d">六、音效播放器(2D)
</h2><h3 id="代码全景分析-5">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：实现“即用即弃”的 3D 音效播放。</p>
</li>
<li>
<p><strong>设计模式</strong>：静态工具类（Static Utility Class）。</p>
</li>
<li>
<p><strong>适用场景</strong>：快速原型开发、Game Jam，或者不需要统一管理音量的小型项目。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine.Audio</span><span class="p">;</span> <span class="c1">// 引入混音器命名空间 </span>
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span> <span class="c1">// 继承自之前的泛型单例基类 </span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">class</span> <span class="nc">SoundManager</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">SoundManager</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Header(&#34;2D 音频配置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Tooltip(&#34;必须赋值：音效输出到的混音组 (Master/SFX)&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">AudioMixerGroup</span> <span class="n">sfxMixerGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">  [Tooltip(&#34;对象池容量 (根据同屏最大音效数设定，2D游戏通常20-30够了)&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">int</span> <span class="n">poolSize</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 对象池队列</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;</span> <span class="n">_audioSourcePool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">GameObject</span> <span class="n">_poolRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">InitializePool</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="k">void</span> <span class="n">InitializePool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_audioSourcePool</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">      <span class="n">_poolRoot</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">(</span><span class="s">&#34;AudioPool_Root&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_poolRoot</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">poolSize</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">CreateNewAudioSource</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">AudioSource</span> <span class="n">CreateNewAudioSource</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">GameObject</span> <span class="n">go</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">(</span><span class="s">&#34;Pooled_SFX&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">go</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">_poolRoot</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">AudioSource</span> <span class="n">source</span> <span class="p">=</span> <span class="n">go</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// === 2D 关键设置 ===</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 1. 设置为 2D 声音 (Spatial Blend = 0)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 这样声音大小就不受 Z 轴深度影响，只受代码逻辑控制，</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 彻底解决了 &#34;2D游戏因为摄像机远导致声音小&#34; 的问题。</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">spatialBlend</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 2. 绑定混音器</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">sfxMixerGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 3. 不要在唤醒时播放</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">playOnAwake</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">go</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_audioSourcePool</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 播放 2D 音效（智能处理左右声道）</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;param name=&#34;clip&#34;&gt;音效片段&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;param name=&#34;worldPos&#34;&gt;发声的世界坐标 (用于计算左右声道)&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;param name=&#34;volume&#34;&gt;基础音量&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;param name=&#34;pitchRandom&#34;&gt;随机音调范围 (0.1 表示 0.9~1.1)&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">PlaySound</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">volume</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">,</span> <span class="kt">float</span> <span class="n">pitchRandom</span> <span class="p">=</span> <span class="m">0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 1. 从池中获取</span>
</span></span><span class="line"><span class="cl">      <span class="n">AudioSource</span> <span class="n">source</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_audioSourcePool</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">source</span> <span class="p">=</span> <span class="n">_audioSourcePool</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="n">source</span> <span class="p">=</span> <span class="n">CreateNewAudioSource</span><span class="p">();</span> <span class="c1">// 池子不够了临时加一个</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">worldPos</span><span class="p">;</span> <span class="c1">// 位置其实不影响音量了，但在Scene里看着方便</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 2. 计算 2D 立体声 (Stereo Pan)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 原理：将世界坐标转为视口坐标 (0~1)，然后映射到 Pan (-1~1)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">Camera</span><span class="p">.</span><span class="n">main</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">Vector3</span> <span class="n">viewportPos</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">WorldToViewportPoint</span><span class="p">(</span><span class="n">worldPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// viewport.x: 0(左) ~ 0.5(中) ~ 1(右)</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// panStereo: -1(左) ~ 0(中) ~ 1(右)</span>
</span></span><span class="line"><span class="cl">          <span class="kt">float</span> <span class="n">pan</span> <span class="p">=</span> <span class="p">(</span><span class="n">viewportPos</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="m">0.5f</span><span class="p">)</span> <span class="p">*</span> <span class="m">2f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">source</span><span class="p">.</span><span class="n">panStereo</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">pan</span><span class="p">,</span> <span class="p">-</span><span class="m">0.8f</span><span class="p">,</span> <span class="m">0.8f</span><span class="p">);</span> <span class="c1">// 限制一下，防止单耳太绝对</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">source</span><span class="p">.</span><span class="n">panStereo</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span> <span class="c1">// 没摄像机就居中</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 3. 应用随机音调</span>
</span></span><span class="line"><span class="cl">      <span class="kt">float</span> <span class="n">finalPitch</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">pitchRandom</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">finalPitch</span> <span class="p">=</span> <span class="m">1.0f</span> <span class="p">+</span> <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(-</span><span class="n">pitchRandom</span><span class="p">,</span> <span class="n">pitchRandom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">pitch</span> <span class="p">=</span> <span class="n">finalPitch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 4. 播放</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">volume</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 5. 延迟回收 (考虑 Pitch 对时长的影响)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果 pitch = 0.5 (半速)，时长需要 / 0.5 = 2倍时长</span>
</span></span><span class="line"><span class="cl">      <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">ReturnToPool</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">clip</span><span class="p">.</span><span class="n">length</span> <span class="p">/</span> <span class="n">finalPitch</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 简单的UI音效播放（不需要位置，永远居中）</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayUISound</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">volume</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">PlaySound</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">      <span class="c1">// 这里虽然传了 Vector2.zero，但在 PlaySound 里如果没有摄像机看这里，panStereo 可能会偏</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 更好的做法是给 source.panStereo 强制设为 0，这里为了代码精简就不展开了</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">ReturnToPool</span><span class="p">(</span><span class="n">AudioSource</span> <span class="n">source</span><span class="p">,</span> <span class="kt">float</span> <span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 多等 0.1秒 缓冲，防止声音没尾音突然切断</span>
</span></span><span class="line"><span class="cl">      <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSeconds</span><span class="p">(</span><span class="n">delay</span> <span class="p">+</span> <span class="m">0.1f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_audioSourcePool</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用示例">使用示例
</h3><p>假设你有一个 2D 角色 PlayerController2D，在跳跃时播放音效：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PlayerController2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioClip</span> <span class="n">jumpSFX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetButtonDown</span><span class="p">(</span><span class="s">&#34;Jump&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Jump</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Jump</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 逻辑...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用单例播放</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 传入 transform.position，管理器会自动计算声音该从左耳机出还是右耳机出</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 0.1f 的随机音调，让连续跳跃的声音不那么机械</span>
</span></span><span class="line"><span class="cl">        <span class="n">SoundManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlaySound</span><span class="p">(</span><span class="n">jumpSFX</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">,</span> <span class="m">0.1f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2d-项目必须注意的配置">2D 项目必须注意的配置
</h3><p>为了让这段代码正常工作，请确保：</p>
<ol>
<li>
<p><strong>AudioMixer</strong>：在 Project 面板右键 -&gt; Create -&gt; Audio Mixer，创建一个。双击打开，点 &ldquo;Groups&rdquo; 下面的 Master，点加号创建一个子组叫 &ldquo;SFX&rdquo;。</p>
</li>
<li>
<p><strong>SoundManager 挂载</strong>：在场景里创建一个空物体 GameManager，挂上 SoundManager 脚本。</p>
</li>
<li>
<p><strong>赋值</strong>：把刚才创建的 SFX Mixer Group 拖到脚本的 Sfx Mixer Group 槽位里。</p>
</li>
</ol>
<h2 id="七列表洗牌扩展">七、列表洗牌扩展
</h2><h3 id="代码全景分析-6">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：为 C# 的集合类型增加“洗牌”和“随机获取”功能。</p>
</li>
<li>
<p><strong>语法特性</strong>：<strong>静态扩展方法 (this 关键字)</strong>。这是 C# 的语法糖，能让你像调用原生方法一样调用自定义方法（例如 myList.Shuffle()）。</p>
</li>
<li>
<p><strong>算法核心</strong>：<strong>Fisher-Yates 洗牌算法</strong>。这是计算机科学中公认的、效率最高（O(n)）、随机性最均匀的洗牌算法。</p>
</li>
<li>
<p><strong>2D 应用场景</strong>：</p>
<ol>
<li>
<p><strong>卡牌游戏</strong>：洗牌堆。</p>
</li>
<li>
<p><strong>Roguelike</strong>：随机生成地牢房间顺序。</p>
</li>
<li>
<p><em>RPG</em>：从掉落列表中随机抽取一件装备。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">ListExtensions</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 对列表进行随机洗牌 (Fisher-Yates 算法) - 使用 Unity 随机库</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Shuffle</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">ListExtensions</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span> 
</span></span><span class="line"><span class="cl">   <span class="cs">/// &lt;summary&gt; </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 对列表进行随机洗牌 (Fisher-Yates 算法) - 使用 Unity 随机库 </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// &lt;/summary&gt; </span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Shuffle</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">n</span><span class="p">--;</span>
</span></span><span class="line"><span class="cl">           <span class="c1">// 使用 UnityEngine.Random 保持全项目随机统一 (方便做种子回放)</span>
</span></span><span class="line"><span class="cl">           <span class="kt">int</span> <span class="n">k</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">n</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="c1">// 交换</span>
</span></span><span class="line"><span class="cl">           <span class="n">T</span> <span class="k">value</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">           <span class="n">list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">           <span class="n">list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 随机获取一个元素（不移除）</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">GetRandom</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">list</span><span class="p">[</span><span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 【新增功能】随机获取一个元素，并将其从列表中移除 (类似抽卡、掉落池)</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">PopRandom</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">T</span> <span class="n">item</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 移除该元素</span>
</span></span><span class="line"><span class="cl">   <span class="n">list</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 【新增功能】优化版移除：将选中的元素和最后一个元素交换，然后移除最后一个。</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// 注意：这会破坏列表顺序，但对于“袋中取球”逻辑，性能比 RemoveAt 高得多 (O(1) vs O(n))</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">PopRandomSwap</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">T</span> <span class="n">item</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">lastIndex</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 把选中的元素覆盖为最后一个元素</span>
</span></span><span class="line"><span class="cl">   <span class="n">list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">lastIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 移除最后一个（开销极小）</span>
</span></span><span class="line"><span class="cl">   <span class="n">list</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">lastIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="使用场景与示例-2">使用场景与示例
</h3><p>假设你正在做一个 <strong>2D 卡牌战斗游戏</strong>。</p>
<p><strong>场景 A：战斗开始，洗牌</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DeckManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">myDeck</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="s">&#34;攻击&#34;</span><span class="p">,</span> <span class="s">&#34;防御&#34;</span><span class="p">,</span> <span class="s">&#34;火球术&#34;</span><span class="p">,</span> <span class="s">&#34;治疗&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果没有扩展方法，你得写个循环去洗牌</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有了扩展方法，直接像原生功能一样调用：</span>
</span></span><span class="line"><span class="cl">        <span class="n">myDeck</span><span class="p">.</span><span class="n">Shuffle</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;第一张牌是: &#34;</span> <span class="p">+</span> <span class="n">myDeck</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>场景 B：敌人随机生成点</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">EnemySpawner</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 场景里放了一堆空物体作为出生点</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Transform</span><span class="p">[]</span> <span class="n">spawnPoints</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">enemyPrefab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">SpawnEnemy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 数组也实现了 IList，所以也能用 GetRandom！</span>
</span></span><span class="line"><span class="cl">        <span class="n">Transform</span> <span class="n">randomPoint</span> <span class="p">=</span> <span class="n">spawnPoints</span><span class="p">.</span><span class="n">GetRandom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">randomPoint</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Instantiate</span><span class="p">(</span><span class="n">enemyPrefab</span><span class="p">,</span> <span class="n">randomPoint</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-4">核心技能点总结
</h3><ol>
<li>
<p><strong>扩展方法 (Extension Methods)</strong>：</p>
<ul>
<li>学会使用 this 关键字扩展现有类。这是编写“语法糖”和“工具库”的神技，能极大地提高代码可读性。</li>
</ul>
</li>
<li>
<p><strong>泛型 (Generics)</strong>：</p>
<ul>
<li><T> 的使用让你的代码可以复用于任何数据类型，体现了 DRY (Don&rsquo;t Repeat Yourself) 原则。</li>
</ul>
</li>
<li>
<p><strong>Fisher-Yates 洗牌算法</strong>：</p>
<ul>
<li>面试必考题。记住它比 OrderBy(Random) 性能好得多且分布更均匀。</li>
</ul>
</li>
<li>
<p><strong>List 性能陷阱</strong>：</p>
<ul>
<li>理解 RemoveAt 会引起内存移动。对于大列表的随机抽取，掌握“交换移除法 (Swap Removal)”是性能优化的关键。</li>
</ul>
</li>
</ol>
<h2 id="八拖拽瞄准控制器">八、拖拽瞄准控制器
</h2><h3 id="代码全景分析-7">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：按下鼠标 -&gt; 拖拽蓄力 -&gt; 松开鼠标 -&gt; 发出一个发射向量（Vector2）。</p>
</li>
<li>
<p><strong>交互模式</strong>：<strong>反向拖拽</strong>（Drag Back）。即鼠标向左拉，物体向右飞（类似拉弹弓）。</p>
</li>
<li>
<p><strong>设计亮点</strong>：使用了 System.Action<Vector2> 委托。这意味着这个脚本<strong>只负责计算输入</strong>，不负责具体的移动逻辑。这是一个非常优秀的<strong>解耦</strong>设计。</p>
</li>
</ul>
<h3 id="1直线瞄准">1.直线瞄准
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(LineRenderer))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DragAimController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;物理参数&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;最大施加力的大小&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">maxPower</span> <span class="p">=</span> <span class="m">20f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;鼠标拖拽距离 -&gt; 力度的转化倍率&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">powerMultiplier</span> <span class="p">=</span> <span class="m">2f</span><span class="p">;</span> <span class="c1">// 调整这个手感</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;鼠标最大允许拖拽多远（世界坐标单位）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">maxDragDistance</span> <span class="p">=</span> <span class="m">3f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;视觉设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否反向显示瞄准线（True=显示飞出方向，False=显示拉皮筋方向）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">showLaunchDirection</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 事件：发射</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Vector2</span><span class="p">&gt;</span> <span class="n">OnFire</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 事件：开始瞄准/瞄准中（可选：用于让摄像机稍微偏移或者主角播放动画）</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span> <span class="n">OnAimStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span> <span class="n">OnAimEnd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LineRenderer</span> <span class="n">_aimLine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_startPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">_mainCam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mainCam</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LineRenderer</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">positionCount</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2D 优化：确保线在最上层</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">sortingOrder</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">useWorldSpace</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HandleInput</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">HandleInput</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 按下 (兼容鼠标左键和单点触摸)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButtonDown</span><span class="p">(</span><span class="m">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">StartAiming</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 拖拽中</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_isDragging</span> <span class="p">&amp;&amp;</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButton</span><span class="p">(</span><span class="m">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">UpdateAiming</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 松开</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_isDragging</span> <span class="p">&amp;&amp;</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButtonUp</span><span class="p">(</span><span class="m">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Fire</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">StartAiming</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_startPoint</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span> <span class="c1">// 锁定发射点为角色当前位置</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">_startPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnAimStart</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">UpdateAiming</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 【关键修复】获取鼠标位置并强制 Z=0</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">rawMousePos</span> <span class="p">=</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">ScreenToWorldPoint</span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">currentMousePos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">rawMousePos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rawMousePos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 计算拉拽向量 (起点 -&gt; 鼠标)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">dragVector</span> <span class="p">=</span> <span class="n">currentMousePos</span> <span class="p">-</span> <span class="n">_startPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 限制拖拽半径</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dragVector</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&gt;</span> <span class="n">maxDragDistance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dragVector</span> <span class="p">=</span> <span class="n">dragVector</span><span class="p">.</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">maxDragDistance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 计算这一帧如果发射，会有多大的力</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 真正的发射方向是拖拽的反方向 (-dragVector)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">launchDirection</span> <span class="p">=</span> <span class="p">-</span><span class="n">dragVector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 视觉绘制</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">showLaunchDirection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 画出飞出去的方向</span>
</span></span><span class="line"><span class="cl">            <span class="n">_aimLine</span><span class="p">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">_startPoint</span> <span class="p">+</span> <span class="n">launchDirection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 画出拉皮筋的效果（跟随鼠标）</span>
</span></span><span class="line"><span class="cl">            <span class="n">_aimLine</span><span class="p">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">_startPoint</span> <span class="p">+</span> <span class="n">dragVector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Fire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimLine</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnAimEnd</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 重新计算最终力度（避免 Update 和 Fire 之间有微小误差）</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">rawMousePos</span> <span class="p">=</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">ScreenToWorldPoint</span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">currentMousePos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">rawMousePos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rawMousePos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">dragVector</span> <span class="p">=</span> <span class="n">currentMousePos</span> <span class="p">-</span> <span class="n">_startPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dragVector</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&gt;</span> <span class="n">maxDragDistance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dragVector</span> <span class="p">=</span> <span class="n">dragVector</span><span class="p">.</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">maxDragDistance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 发射向量 = 拖拽反方向 * 倍率</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">fireVector</span> <span class="p">=</span> <span class="p">-</span><span class="n">dragVector</span> <span class="p">*</span> <span class="n">powerMultiplier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 最终力度钳制</span>
</span></span><span class="line"><span class="cl">        <span class="n">fireVector</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">ClampMagnitude</span><span class="p">(</span><span class="n">fireVector</span><span class="p">,</span> <span class="n">maxPower</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 只有拉动了一定距离才发射（防误触）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fireVector</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&gt;</span> <span class="m">0.1f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">OnFire</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">fireVector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用场景与示例-3">使用场景与示例
</h3><p><strong>场景：让主角像炮弹一样飞出去</strong></p>
<ol>
<li>
<p><strong>主角设置</strong>：</p>
<ul>
<li>
<p>给主角挂上 Rigidbody2D (设为 Dynamic)。</p>
</li>
<li>
<p>挂上 DragAimController 脚本。</p>
</li>
<li>
<p>创建一个新脚本 PlayerMovement 来接收信号。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PlayerMovement</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DragAimController</span> <span class="n">_aimController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimController</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">DragAimController</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnEnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 订阅事件：当瞄准控制器决定“发射”时，执行 Launch 方法</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimController</span><span class="p">.</span><span class="n">OnFire</span> <span class="p">+=</span> <span class="n">Launch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 养成好习惯：要在 OnDisable 取消订阅，防止内存泄漏</span>
</span></span><span class="line"><span class="cl">        <span class="n">_aimController</span><span class="p">.</span><span class="n">OnFire</span> <span class="p">-=</span> <span class="n">Launch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Launch</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">forceVector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2D 物理发射</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Impulse 模式适合瞬间的爆发力（如开炮、跳跃）</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="n">forceVector</span><span class="p">,</span> <span class="n">ForceMode2D</span><span class="p">.</span><span class="n">Impulse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-2d-特化">核心技能点总结 (2D 特化)
</h3><ol>
<li>
<p><strong>屏幕转世界坐标的 Z 轴归零</strong>：</p>
<ul>
<li>
<p>ScreenToWorldPoint 必须处理 Z 轴。如果不处理，它会返回 Camera.z (通常是 -10)，导致距离计算错误。</p>
</li>
<li>
<p>标准写法：Vector2 worldPos = Camera.main.ScreenToWorldPoint(Input.mousePosition); (C# 自动把 Vector3 强转为 Vector2，自动丢弃 Z 轴，这是最安全的做法)。</p>
</li>
</ul>
</li>
<li>
<p><strong>解耦设计 (Decoupling)</strong>：</p>
<ul>
<li>
<p>这个脚本只负责“算力度”，不负责“怎么动”。</p>
</li>
<li>
<p>通过 Action<Vector2> 把力度传出去，你可以把这个脚本挂在主角身上让他飞，也可以挂在弹弓上发射石头，甚至挂在 UI 摇杆上。</p>
</li>
</ul>
</li>
<li>
<p><strong>Vector2.ClampMagnitude</strong>：</p>
<ul>
<li>这是限制蓄力上限的神器。比手动写 if (v.magnitude &gt; max) v = v.normalized * max 要优雅得多。</li>
</ul>
</li>
<li>
<p><strong>LineRenderer 排序</strong>：</p>
<ul>
<li>在 2D 游戏中，LineRenderer 经常被背景遮挡。记得设置 sortingOrder 或者 sortingLayerName 确保它画在最上层。</li>
</ul>
</li>
</ol>
<h3 id="2抛物线瞄准">2.抛物线瞄准
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(LineRenderer))]</span>
</span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(Rigidbody2D))]</span> <span class="c1">// 需要物理组件来获取质量和重力缩放</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ParabolicAimController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;物理参数&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">maxPower</span> <span class="p">=</span> <span class="m">20f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">powerMultiplier</span> <span class="p">=</span> <span class="m">3f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">maxDragDistance</span> <span class="p">=</span> <span class="m">3f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;抛物线设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;模拟的点数量（点越多线越圆滑，但消耗越高）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">resolution</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;模拟的总时长（秒），决定线能画多长&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">simulationDuration</span> <span class="p">=</span> <span class="m">1.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;碰撞检测层级（线碰到什么层级会停止绘制，比如地面/墙壁）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">LayerMask</span> <span class="n">collisionLayer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 事件</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Vector2</span><span class="p">&gt;</span> <span class="n">OnFire</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LineRenderer</span> <span class="n">_lineRenderer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_startPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">_mainCam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mainCam</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LineRenderer</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">sortingOrder</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 关键优化：让线看起来更像虚线或平滑曲线</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">positionCount</span> <span class="p">=</span> <span class="n">resolution</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HandleInput</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">HandleInput</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButtonDown</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="n">StartAiming</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_isDragging</span> <span class="p">&amp;&amp;</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButton</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="n">UpdateAiming</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_isDragging</span> <span class="p">&amp;&amp;</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetMouseButtonUp</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="n">Fire</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">StartAiming</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_startPoint</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">UpdateAiming</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 计算发射力度向量 (Force)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">forceVector</span> <span class="p">=</span> <span class="n">CalculateForce</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 将 力 转换为 初速度 (Velocity)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 物理公式：F = m * a  =&gt;  a = F / m</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果使用 ForceMode2D.Impulse，瞬时速度变化量 = Force / Mass</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注意：这里假设你发射时使用的是 Impulse 模式</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">launchVelocity</span> <span class="p">=</span> <span class="n">forceVector</span> <span class="p">/</span> <span class="n">_rb</span><span class="p">.</span><span class="n">mass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 绘制抛物线</span>
</span></span><span class="line"><span class="cl">        <span class="n">DrawTrajectory</span><span class="p">(</span><span class="n">launchVelocity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">DrawTrajectory</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">initialVelocity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span><span class="p">[]</span> <span class="n">points</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">[</span><span class="n">resolution</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">points</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span> <span class="c1">// 起点</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取当前世界的重力加速度 (别忘了乘物体自身的重力缩放)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">gravity</span> <span class="p">=</span> <span class="n">Physics2D</span><span class="p">.</span><span class="n">gravity</span> <span class="p">*</span> <span class="n">_rb</span><span class="p">.</span><span class="n">gravityScale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">resolution</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 计算时间点 t</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">t</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">i</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">*</span> <span class="n">simulationDuration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 核心物理公式：P = P0 + vt + 0.5gt^2</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector2</span> <span class="n">displacement</span> <span class="p">=</span> <span class="p">(</span><span class="n">initialVelocity</span> <span class="p">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">gravity</span> <span class="p">*</span> <span class="p">(</span><span class="n">t</span> <span class="p">*</span> <span class="n">t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector2</span> <span class="n">drawPoint</span> <span class="p">=</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">)</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+</span> <span class="n">displacement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 碰撞检测：防止线穿墙</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 检测上一个点到当前点之间有没有障碍物</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector2</span> <span class="n">previousPoint</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector2</span> <span class="n">direction</span> <span class="p">=</span> <span class="n">drawPoint</span> <span class="p">-</span> <span class="n">previousPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">distance</span> <span class="p">=</span> <span class="n">direction</span><span class="p">.</span><span class="n">magnitude</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">RaycastHit2D</span> <span class="n">hit</span> <span class="p">=</span> <span class="n">Physics2D</span><span class="p">.</span><span class="n">Raycast</span><span class="p">(</span><span class="n">previousPoint</span><span class="p">,</span> <span class="n">direction</span><span class="p">.</span><span class="n">normalized</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">collisionLayer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="n">collider</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 如果撞到了墙，把当前点设为撞击点</span>
</span></span><span class="line"><span class="cl">                <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">hit</span><span class="p">.</span><span class="n">point</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 剩下的点全部重叠在这个撞击点上（或者你可以直接截断 LineRenderer 的 count）</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 这里为了简单，把剩下的点都设为同一个位置，视觉上就是线停住了</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">resolution</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">hit</span><span class="p">.</span><span class="n">point</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span> <span class="c1">// 停止计算后续轨迹</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">drawPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">SetPositions</span><span class="p">(</span><span class="n">points</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">CalculateForce</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">rawMousePos</span> <span class="p">=</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">ScreenToWorldPoint</span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">mousePos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">rawMousePos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rawMousePos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">dragVector</span> <span class="p">=</span> <span class="n">mousePos</span> <span class="p">-</span> <span class="n">_startPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dragVector</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&gt;</span> <span class="n">maxDragDistance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dragVector</span> <span class="p">=</span> <span class="n">dragVector</span><span class="p">.</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">maxDragDistance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 反向拖拽</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">-</span><span class="n">dragVector</span> <span class="p">*</span> <span class="n">powerMultiplier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Fire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isDragging</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lineRenderer</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">forceVector</span> <span class="p">=</span> <span class="n">CalculateForce</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 限制最大力度</span>
</span></span><span class="line"><span class="cl">        <span class="n">forceVector</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">ClampMagnitude</span><span class="p">(</span><span class="n">forceVector</span><span class="p">,</span> <span class="n">maxPower</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">forceVector</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&gt;</span> <span class="m">0.1f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">OnFire</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">forceVector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="如何设置-unity-组件">如何设置 Unity 组件
</h3><p>为了让效果最好，请按照以下步骤操作：</p>
<ol>
<li>
<p><strong>LineRenderer 设置</strong>：</p>
<ul>
<li>
<p><strong>Width</strong>: 设为 0.1 或 0.2，两头可以设置渐变（头部粗尾部细）。</p>
</li>
<li>
<p><strong>Material</strong>: 找一个简单的 Sprites-Default 材质，或者虚线材质。</p>
</li>
<li>
<p><strong>Color</strong>: 设为白色带透明度，或者亮黄色。</p>
</li>
<li>
<p><strong>Texture Mode</strong>: 建议设为 Tile 并配合虚线贴图，这样看起来就是一条一条的虚线轨迹。</p>
</li>
</ul>
</li>
<li>
<p><strong>Rigidbody2D 设置</strong>：</p>
<ul>
<li>
<p><strong>Mass</strong>: 建议默认为 1。</p>
</li>
<li>
<p><strong>Gravity Scale</strong>: 建议设为 2~4，手感比较扎实。</p>
</li>
</ul>
</li>
<li>
<p><strong>Layer Mask</strong>:</p>
<ul>
<li>
<p>创建一个 Layer 叫 Ground 或 Wall。</p>
</li>
<li>
<p>把地板和墙壁设为这个 Layer。</p>
</li>
<li>
<p>在脚本的 Collision Layer 选项中，只勾选 Ground 和 Wall。</p>
</li>
<li>
<p><strong>千万不要勾选 Player 自己</strong>，否则射线一出来就打中自己，线会显示不出来。</p>
</li>
</ul>
</li>
<li>
<p><strong>发射脚本 (PlayerMovement)</strong>：</p>
<ul>
<li>
<p>和之前一样，订阅 OnFire 事件。</p>
</li>
<li>
<p><strong>关键</strong>：发射时必须使用 Impulse 模式，才能匹配我们的预测算法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">Launch</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">force</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 必须是用 Impulse，因为我们的预测算法基于瞬时速度改变</span>
</span></span><span class="line"><span class="cl">    <span class="n">_rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">ForceMode2D</span><span class="p">.</span><span class="n">Impulse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h2 id="九数值与ui绑定系统">九、数值与UI绑定系统
</h2><h3 id="代码全景分析-8">代码全景分析
</h3><ul>
<li>
<p><strong>核心模式</strong>：观察者模式（通过 C# event Action 实现）。</p>
</li>
<li>
<p><strong>设计目的</strong>：创建一个通用的数值容器，任何数值变化都能自动通知监听者（UI、特效管理器、音效管理器）。</p>
</li>
<li>
<p><strong>亮点</strong>：</p>
<ul>
<li>
<p><strong>[System.Serializable]</strong>：这是一个纯 C# 类，但加上这个标签后，它就能像 Unity 原生组件一样显示在 Inspector 面板中，非常方便调试。</p>
</li>
<li>
<p><strong>Mathf.Clamp</strong>：数据安全保护，防止血量变成负数或超过上限，杜绝了经典的“负血不死”或“血条溢出”Bug。</p>
</li>
<li>
<p><strong>OnDepleted</strong>：专门为“归零”（死亡/没蓝）设计的事件，逻辑清晰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[System.Serializable]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ObservableStat</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [SerializeField]</span> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_currentValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">    [SerializeField]</span> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_maxValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 优化：增加一个只读属性，直接返回 0-1 的百分比，方便 UI 使用</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Ratio</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">_maxValue</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="n">_currentValue</span> <span class="p">/</span> <span class="n">_maxValue</span><span class="p">)</span> <span class="p">:</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Current</span> <span class="p">=&gt;</span> <span class="n">_currentValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Max</span> <span class="p">=&gt;</span> <span class="n">_maxValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">event</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObservableStat</span><span class="p">&gt;</span> <span class="n">OnValueChanged</span><span class="p">;</span> <span class="c1">// 传自己出去，参数更灵活</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">event</span> <span class="n">Action</span> <span class="n">OnDepleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造函数，方便代码里直接 new</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ObservableStat</span><span class="p">(</span><span class="kt">float</span> <span class="n">max</span><span class="p">,</span> <span class="kt">float</span> <span class="n">current</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_maxValue</span> <span class="p">=</span> <span class="n">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentValue</span> <span class="p">=</span> <span class="p">(</span><span class="n">current</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="n">max</span> <span class="p">:</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 初始化（通常在 Start 或 Awake 中调用）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="kt">float</span> <span class="n">max</span><span class="p">,</span> <span class="kt">float</span> <span class="n">current</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_maxValue</span> <span class="p">=</span> <span class="n">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentValue</span> <span class="p">=</span> <span class="p">(</span><span class="n">current</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="n">max</span> <span class="p">:</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Notify</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 相对修改 (加血/扣血)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Modify</span><span class="p">(</span><span class="kt">float</span> <span class="n">amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Approximately</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="m">0f</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 没变化就不执行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">finalValue</span> <span class="p">=</span> <span class="n">_currentValue</span> <span class="p">+</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetCurrent</span><span class="p">(</span><span class="n">finalValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 绝对修改 (直接设置血量)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetCurrent</span><span class="p">(</span><span class="kt">float</span> <span class="k">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">prevValue</span> <span class="p">=</span> <span class="n">_currentValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentValue</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">_maxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Approximately</span><span class="p">(</span><span class="n">_currentValue</span><span class="p">,</span> <span class="n">prevValue</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Notify</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_currentValue</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="n">OnDepleted</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 修改最大值 (比如升级，获得Buff)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;newMax&#34;&gt;新上限&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;keepRatio&#34;&gt;是否保持百分比? (True=等比加血, False=只加上限当前血不变)&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetMax</span><span class="p">(</span><span class="kt">float</span> <span class="n">newMax</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">keepRatio</span> <span class="p">=</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newMax</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">ratio</span> <span class="p">=</span> <span class="n">Ratio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_maxValue</span> <span class="p">=</span> <span class="n">newMax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">keepRatio</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_currentValue</span> <span class="p">=</span> <span class="n">_maxValue</span> <span class="p">*</span> <span class="n">ratio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_currentValue</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">_currentValue</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">_maxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Notify</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 供 Unity 编辑器脚本调用，解决 Inspector 修改数值不刷新 UI 的问题</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 注意：这需要配合自定义 Editor 脚本使用，或者在 OnValidate 里手动调用</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">EditorForceNotify</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Notify</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Notify</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 传递 &#39;this&#39;，让监听者可以访问 Ratio, Current, Max 等所有属性</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnValueChanged</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景示例ui-血条绑定">使用场景示例：UI 血条绑定
</h3><p>有了 Ratio 属性和改良的事件，你的 UI 脚本会变得异常简洁。</p>
<p><strong>HealthBarUI.cs (UI 脚本)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span> <span class="c1">// 强烈建议配合 DOTween 做血条缓冲</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">HealthBarUI</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Image</span> <span class="n">fillImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Image</span> <span class="n">easeImage</span><span class="p">;</span> <span class="c1">// 缓冲层（黄色血条）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 现在的参数直接是 ObservableStat 对象，太方便了</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">UpdateHealth</span><span class="p">(</span><span class="n">ObservableStat</span> <span class="n">stat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 直接拿百分比</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">targetFill</span> <span class="p">=</span> <span class="n">stat</span><span class="p">.</span><span class="n">Ratio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 主血条直接变</span>
</span></span><span class="line"><span class="cl">        <span class="n">fillImage</span><span class="p">.</span><span class="n">fillAmount</span> <span class="p">=</span> <span class="n">targetFill</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 缓冲血条慢慢变 (DOTween)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">easeImage</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">easeImage</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">easeImage</span><span class="p">.</span><span class="n">DOFillAmount</span><span class="p">(</span><span class="n">targetFill</span><span class="p">,</span> <span class="m">0.5f</span><span class="p">).</span><span class="n">SetEase</span><span class="p">(</span><span class="n">Ease</span><span class="p">.</span><span class="n">OutCirc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="playercs-角色脚本">Player.cs (角色脚本)
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Player</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ObservableStat</span> <span class="n">health</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ObservableStat</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HealthBarUI</span> <span class="n">healthBar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化</span>
</span></span><span class="line"><span class="cl">        <span class="n">health</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 绑定 UI</span>
</span></span><span class="line"><span class="cl">        <span class="n">health</span><span class="p">.</span><span class="n">OnValueChanged</span> <span class="p">+=</span> <span class="n">healthBar</span><span class="p">.</span><span class="n">UpdateHealth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 强制刷新一次 UI，让血条显示初始状态</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这是一个好习惯，防止 UI 在 Start 前是空的</span>
</span></span><span class="line"><span class="cl">        <span class="n">health</span><span class="p">.</span><span class="n">Modify</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 测试扣血</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">health</span><span class="p">.</span><span class="n">Modify</span><span class="p">(-</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 测试升级 (血量上限翻倍，保持百分比)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">U</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">health</span><span class="p">.</span><span class="n">SetMax</span><span class="p">(</span><span class="n">health</span><span class="p">.</span><span class="n">Max</span> <span class="p">*</span> <span class="m">2</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-5">核心技能点总结
</h3><ol>
<li>
<p><strong>MVC 思想 (Model-View-Controller)</strong>：</p>
<ul>
<li>
<p>ObservableStat 是 <strong>Model</strong> (纯数据)。</p>
</li>
<li>
<p>HealthBarUI 是 <strong>View</strong> (纯表现)。</p>
</li>
<li>
<p>Player 是 <strong>Controller</strong> (把 Model 给 View)。</p>
</li>
<li>
<p>这是避免项目后期变成“代码屎山”的唯一解药。</p>
</li>
</ul>
</li>
<li>
<p><strong>事件参数优化</strong>：</p>
<ul>
<li>
<p>原代码传 float, float。改良版传 this (ObservableStat)。</p>
</li>
<li>
<p><strong>为什么？</strong> 传对象扩展性更强。如果未来 UI 想要显示“是否濒死”状态，直接访问 stat.Current &lt; 10 即可，不需要修改事件签名。</p>
</li>
</ul>
</li>
<li>
<p><strong>Ratio 属性</strong>：</p>
<ul>
<li>封装 Current / Max 的计算逻辑。永远不要在 UI 层做数学题，Model 层应该提供好现成的数据。</li>
</ul>
</li>
<li>
<p><strong>序列化类的局限性</strong>：</p>
<ul>
<li>虽然 [Serializable] 很棒，但要注意：<strong>它是引用类型</strong>。如果你直接 new ObservableStat() 赋值给两个变量，它们会指向同一个内存地址（血条同步扣血）。在 MonoBehaviour 字段中实例化是安全的。</li>
</ul>
</li>
</ol>
<h2 id="十对象池框架">十、对象池框架
</h2><h3 id="代码全景分析-9">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：预先生成一批物体隐藏起来。需要时“借”出来（激活），用完“还”回去（隐藏），而不是真正的销毁。</p>
</li>
<li>
<p><strong>数据结构</strong>：Queue<GameObject>（队列）。</p>
<ul>
<li><strong>先进先出 (FIFO)</strong>：这是管理池子最快的数据结构 (O(1) 复杂度)。</li>
</ul>
</li>
<li>
<p><strong>2D 应用场景</strong>：</p>
<ul>
<li>
<p>机枪射出的子弹。</p>
</li>
<li>
<p>金币掉落动画。</p>
</li>
<li>
<p>怪物的死亡爆炸特效。</p>
</li>
</ul>
</li>
</ul>
<p><strong>步骤 1：定义复位接口</strong></p>
<p>任何想放入池子的东西（子弹、特效），最好都实现这个接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 所有池子里的物体，建议实现这个接口，用于自动“洗白”状态</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">interface</span> <span class="nc">IPoolable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnSpawn</span><span class="p">();</span> <span class="c1">// 当从池子取出时调用（代替 Start）</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnDespawn</span><span class="p">();</span> <span class="c1">// 当放回池子时调用（代替 OnDestroy）</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>步骤 2：编写通用对象池管理器</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="err">继承之前的</span> <span class="n">Singleton</span> <span class="err">框架。</span><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ObjectPoolManager</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">ObjectPoolManager</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [System.Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">PoolConfig</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">string</span> <span class="n">tag</span><span class="p">;</span>       <span class="c1">// 标识符 (如 &#34;Bullet&#34;, &#34;Coin&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">prefab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">size</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;池子配置表&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">PoolConfig</span><span class="p">&gt;</span> <span class="n">configs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 字典：Key是Tag，Value是该Tag对应的对象队列</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;&gt;</span> <span class="n">_poolDictionary</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitializePools</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">InitializePools</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_poolDictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">config</span> <span class="k">in</span> <span class="n">configs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Queue</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;</span> <span class="n">objectPool</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 创建父节点，保持 Hierarchy 干净整洁</span>
</span></span><span class="line"><span class="cl">            <span class="n">GameObject</span> <span class="n">poolParent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">(</span><span class="s">$&#34;Pool_{config.tag}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">poolParent</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">config</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">GameObject</span> <span class="n">obj</span> <span class="p">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">prefab</span><span class="p">,</span> <span class="n">poolParent</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">obj</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">objectPool</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">_poolDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">objectPool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 获取对象</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">Spawn</span><span class="p">(</span><span class="kt">string</span> <span class="n">tag</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">position</span><span class="p">,</span> <span class="n">Quaternion</span> <span class="n">rotation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">_poolDictionary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">$&#34;池子中不存在 Tag: {tag}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 取出对象</span>
</span></span><span class="line"><span class="cl">        <span class="n">GameObject</span> <span class="n">objToSpawn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Queue</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;</span> <span class="n">pool</span> <span class="p">=</span> <span class="n">_poolDictionary</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pool</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 池子空了？这是个策略问题。</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 策略A：扩容（推荐）</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 策略B：强制回收最早的一个（适用于特效）</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 这里演示扩容：需要找到对应的 prefab 比较麻烦，简单处理是复用最早的或报错</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 为简化代码，假设池子够用，或者此处应该扩容逻辑...</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 简单扩容逻辑：</span>
</span></span><span class="line"><span class="cl">             <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">$&#34;池子 {tag} 空了，建议增加初始大小&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">objToSpawn</span> <span class="p">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 设置物理状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">objToSpawn</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">objToSpawn</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">objToSpawn</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span> <span class="p">=</span> <span class="n">rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 【关键】调用接口复位状态 (Rigidbody, HP等)</span>
</span></span><span class="line"><span class="cl">        <span class="n">IPoolable</span> <span class="n">poolable</span> <span class="p">=</span> <span class="n">objToSpawn</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IPoolable</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">poolable</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">poolable</span><span class="p">.</span><span class="n">OnSpawn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">objToSpawn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 回收对象</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">ReturnObj</span><span class="p">(</span><span class="kt">string</span> <span class="n">tag</span><span class="p">,</span> <span class="n">GameObject</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">_poolDictionary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用回收接口</span>
</span></span><span class="line"><span class="cl">        <span class="n">IPoolable</span> <span class="n">poolable</span> <span class="p">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IPoolable</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">poolable</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">poolable</span><span class="p">.</span><span class="n">OnDespawn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">obj</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_poolDictionary</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用场景与示例-4">使用场景与示例
</h3><p><strong>场景：2D 飞船发射子弹</strong></p>
<ol>
<li>
<p><strong>场景设置</strong>：</p>
<ul>
<li>
<p>创建一个空物体 BulletPool，挂载此脚本。</p>
</li>
<li>
<p>把 BulletPrefab 拖进去，Initial Size 设为 20。</p>
</li>
</ul>
</li>
<li>
<p><strong>飞船脚本</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Spaceship</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="n">SimpleObjectPool</span> <span class="n">bulletPool</span><span class="p">;</span> <span class="c1">// 引用池子脚本</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="n">Transform</span> <span class="n">firePoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetButtonDown</span><span class="p">(</span><span class="s">&#34;Fire1&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 不再使用 Instantiate，而是向池子要</span>
</span></span><span class="line"><span class="cl">             <span class="n">bulletPool</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">firePoint</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">firePoint</span><span class="p">.</span><span class="n">rotation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>子弹回收脚本</strong>（挂在子弹 Prefab 上）：</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na"> [RequireComponent(typeof(Rigidbody2D))]</span> 
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">class</span> <span class="nc">Bullet2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span><span class="p">,</span> <span class="n">IPoolable</span> 
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kt">float</span> <span class="n">speed</span> <span class="p">=</span> <span class="m">10f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 接口实现：取出时自动发射</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="k">void</span> <span class="n">OnSpawn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 1. 清零之前的速度（非常重要！否则子弹会乱飞）</span>
</span></span><span class="line"><span class="cl">         <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">         <span class="n">_rb</span><span class="p">.</span><span class="n">angularVelocity</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 2. 重新施加力</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// transform.right 在 2D 中通常代表“前方”</span>
</span></span><span class="line"><span class="cl">         <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">right</span> <span class="p">*</span> <span class="n">speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 3. 开启自动回收倒计时</span>
</span></span><span class="line"><span class="cl">         <span class="n">CancelInvoke</span><span class="p">();</span> <span class="c1">// 防止重复</span>
</span></span><span class="line"><span class="cl">         <span class="n">Invoke</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">DespawnMe</span><span class="p">),</span> <span class="m">3f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 接口实现：回收时清理</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="k">void</span> <span class="n">OnDespawn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 可以在这里重置粒子拖尾等</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">void</span> <span class="n">DespawnMe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">ReturnObj</span><span class="p">(</span><span class="s">&#34;Bullet&#34;</span><span class="p">,</span> <span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 碰到东西也要回收</span>
</span></span><span class="line"><span class="cl">     <span class="k">void</span> <span class="n">OnTriggerEnter2D</span><span class="p">(</span><span class="n">Collider2D</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">CompareTag</span><span class="p">(</span><span class="s">&#34;Enemy&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// 造成伤害逻辑...</span>
</span></span><span class="line"><span class="cl">              <span class="n">DespawnMe</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-6">核心技能点总结
</h3><ol>
<li>
<p><strong>IPoolable 接口模式</strong>：</p>
<ul>
<li><strong>面试必杀技</strong>。在对象池中，最大的 Bug 来源就是**“脏状态”**（Dirty State）。通过接口强制对象在 OnSpawn 中重置自己的 Rigidbody.velocity、血量、动画状态机，是 2D 游戏稳定的基石。</li>
</ul>
</li>
<li>
<p><strong>Dictionary 池管理</strong>：</p>
<ul>
<li>使用 Dictionary&lt;string, Queue&gt; 可以让你在一个管理器里同时处理子弹、金币、血瓶等多种物体，保持项目结构清晰。</li>
</ul>
</li>
<li>
<p><strong>Hierarchy 管理</strong>：</p>
<ul>
<li>在 InitializePools 中，我创建了 poolParent。这会让 Unity 编辑器的 Hierarchy 面板非常整洁，而不是几百个子弹散落在根目录下。</li>
</ul>
</li>
<li>
<p><strong>2D 物理陷阱</strong>：</p>
<ul>
<li>切记：GameObject.SetActive(false) <strong>不会</strong>自动清空 Rigidbody 的速度。如果你不手动 velocity = Vector2.zero，下次激活时物体会瞬移或保留惯性。</li>
</ul>
</li>
</ol>
<h2 id="十一视觉反馈">十一、视觉反馈
</h2><h3 id="代码全景分析-10">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：为游戏物体提供一套通用的视觉反馈接口（缩放、变色、震动）。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>PlayPunchScale</strong>：UI 按钮点击、获得金币、史莱姆落地。</p>
</li>
<li>
<p><strong>PlayFlash</strong>：角色受击（Hit Flash）、拾取道具高亮。</p>
</li>
<li>
<p><strong>PlayShake</strong>：炸弹爆炸、受到重击、方块被破坏。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心插件</strong>：DOTween (需要 DG.Tweening 命名空间)。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">class</span> <span class="nc">VisualFeedback</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Header(&#34;弹性缩放设置&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2D 游戏通常不缩放 Z 轴，所以用 Vector2 即可</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">punchScaleAmount</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="m">0.3f</span><span class="p">,</span> <span class="m">0.3f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">float</span> <span class="n">punchDuration</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Range(0, 10)]</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">vibrato</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Range(0, 1)]</span> <span class="kd">public</span> <span class="kt">float</span> <span class="n">elasticity</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">  [Header(&#34;闪烁设置&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">SpriteRenderer</span> <span class="n">targetSprite</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Color</span> <span class="n">flashColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">;</span> <span class="c1">// 默认改为红色，因为白色通常没效果</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">float</span> <span class="n">flashDuration</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 【高级】如果你使用了支持 &#34;Flash&#34; 属性的 Shader（例如 Shader Graph），勾选此项</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">bool</span> <span class="n">useShaderFlash</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">string</span> <span class="n">shaderProperty</span> <span class="p">=</span> <span class="s">&#34;_FlashAmount&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Vector3</span> <span class="n">_baseScale</span><span class="p">;</span> <span class="c1">// 缓存初始大小</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Color</span> <span class="n">_baseColor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Material</span> <span class="n">_targetMaterial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Tween</span> <span class="n">_flashTween</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Tween</span> <span class="n">_scaleTween</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 1. 自动获取组件</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">targetSprite</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">targetSprite</span> <span class="p">=</span> <span class="n">GetComponentInChildren</span><span class="p">&lt;</span><span class="n">SpriteRenderer</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 2. 缓存初始状态（关键！）</span>
</span></span><span class="line"><span class="cl">      <span class="n">_baseScale</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">localScale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">targetSprite</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">_baseColor</span> <span class="p">=</span> <span class="n">targetSprite</span><span class="p">.</span><span class="n">color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">useShaderFlash</span><span class="p">)</span> <span class="n">_targetMaterial</span> <span class="p">=</span> <span class="n">targetSprite</span><span class="p">.</span><span class="n">material</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 窗口关闭或物体销毁时，必须杀死动画，防止报错</span>
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">targetSprite</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">targetSprite</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_targetMaterial</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">_targetMaterial</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 播放弹性缩放 (修复了缩放重置 Bug)</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayPunchScale</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 杀掉旧动画，防止快速连续调用时动画叠加导致物体越来越大</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_scaleTween</span> <span class="p">!=</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">_scaleTween</span><span class="p">.</span><span class="n">IsActive</span><span class="p">())</span> <span class="n">_scaleTween</span><span class="p">.</span><span class="n">Kill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 瞬间复位到“初始大小”，而不是 Vector3.one</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">localScale</span> <span class="p">=</span> <span class="n">_baseScale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 播放新动画</span>
</span></span><span class="line"><span class="cl">      <span class="n">_scaleTween</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">DOPunchScale</span><span class="p">(</span><span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">punchScaleAmount</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">punchScaleAmount</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">punchDuration</span><span class="p">,</span> <span class="n">vibrato</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 播放受击闪烁</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayFlash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">targetSprite</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 同样，先杀掉旧动画</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_flashTween</span> <span class="p">!=</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">_flashTween</span><span class="p">.</span><span class="n">IsActive</span><span class="p">())</span> <span class="n">_flashTween</span><span class="p">.</span><span class="n">Kill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">useShaderFlash</span> <span class="p">&amp;&amp;</span> <span class="n">_targetMaterial</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 方案 A：高级 Shader 变白 (修改 Material 属性 0 -&gt; 1 -&gt; 0)</span>
</span></span><span class="line"><span class="cl">          <span class="n">_targetMaterial</span><span class="p">.</span><span class="n">SetFloat</span><span class="p">(</span><span class="n">shaderProperty</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span> <span class="c1">// 复位</span>
</span></span><span class="line"><span class="cl">          <span class="n">_flashTween</span> <span class="p">=</span> <span class="n">_targetMaterial</span><span class="p">.</span><span class="n">DOFloat</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="n">shaderProperty</span><span class="p">,</span> <span class="n">flashDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">.</span><span class="n">SetLoops</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">LoopType</span><span class="p">.</span><span class="n">Yoyo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 方案 B：普通颜色叠加 (变红/变透明)</span>
</span></span><span class="line"><span class="cl">          <span class="n">targetSprite</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">_baseColor</span><span class="p">;</span> <span class="c1">// 复位</span>
</span></span><span class="line"><span class="cl">          <span class="n">_flashTween</span> <span class="p">=</span> <span class="n">targetSprite</span><span class="p">.</span><span class="n">DOColor</span><span class="p">(</span><span class="n">flashColor</span><span class="p">,</span> <span class="n">flashDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">.</span><span class="n">SetLoops</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">LoopType</span><span class="p">.</span><span class="n">Yoyo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 播放震动 (建议挂在 Visual 子物体上，不要挂在根节点)</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayShake</span><span class="p">(</span><span class="kt">float</span> <span class="n">strength</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">DOKill</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// 震动通常需要完全覆盖旧震动</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 仅震动位置，不震动旋转和缩放</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// randomness: 90 是震动方向的随机性，fadeOut: true 表示震动会慢慢停下来</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">DOShakePosition</span><span class="p">(</span><span class="m">0.3f</span><span class="p">,</span> <span class="n">strength</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">90</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-7">核心技能点总结
</h3><ol>
<li>
<p><strong>DOKill 的重要性</strong>：</p>
<ul>
<li>在游戏中，玩家可能会在一秒内连续攻击 5 次。如果不写 DOKill，5 个动画会同时运行，导致颜色错乱或者物体缩放比例爆炸。<strong>永远假设你的函数会被疯狂连续调用。</strong></li>
</ul>
</li>
<li>
<p><strong>初始值缓存 (_baseScale)</strong>：</p>
<ul>
<li><strong>切记</strong>：永远不要假设 transform.localScale 是 Vector3.one。在 2D 游戏中，为了做透视或调整大小，美术经常会把 Scale 设为 0.8 或 -1（翻转）。直接赋值 one 会破坏美术成果。</li>
</ul>
</li>
<li>
<p><strong>Visual 子物体架构</strong>：</p>
<ul>
<li>
<p>为了实现完美的 PlayShake，建议你的 Hierarchy 结构如下：</p>
<ul>
<li>
<p><strong>Player (Root)</strong>: 挂 Rigidbody2D, Collider2D, MovementScript。</p>
</li>
<li>
<p><strong>&ndash; Visual (Child)</strong>: 挂 SpriteRenderer, <strong>VisualFeedback</strong>。</p>
</li>
</ul>
</li>
<li>
<p>这样 PlayShake 只会震动 Visual，而不会影响 Root 的物理移动。</p>
</li>
</ul>
</li>
<li>
<p><strong>Shader Flash (进阶)</strong>：</p>
<ul>
<li>如果你想要那种“亮瞎眼”的纯白闪光，去 Unity Asset Store 搜一个免费的 <strong>&ldquo;Sprite Flash Shader&rdquo;</strong>，然后勾选脚本里的 useShaderFlash，效果会比改 Color 好一万倍。</li>
</ul>
</li>
</ol>
<h2 id="十二刚体速度保持传送门">十二、刚体速度保持/传送门
</h2><h3 id="代码全景分析-11">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：实现保留动量（Momentum）的物理传送。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>Portal 机制</strong>：像《传送门》那样进去出来速度不变。</p>
</li>
<li>
<p><strong>屏幕环绕（Screen Wrapping）</strong>：像《吃豆人》或《Asteroids》，从屏幕左边飞出去，从右边飞进来，速度保持一致。</p>
</li>
<li>
<p><strong>瞬移技能</strong>：角色闪现到敌人身后，但保持之前的冲刺惯性。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心技巧</strong>：<strong>storedVelocity</strong>。这是为了对抗 Unity 物理引擎的“碰撞后自动减速”机制。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="na">  [RequireComponent(typeof(Rigidbody2D))]</span> 
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">class</span> <span class="nc">PhysicsTeleporter</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">TrailRenderer</span> <span class="n">_trail</span><span class="p">;</span> <span class="c1">// 缓存拖尾组件</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_storedVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 传送冷却时间，防止在两个门之间高频鬼畜</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kt">float</span> <span class="n">_cooldownTimer</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">const</span> <span class="kt">float</span> <span class="n">COOLDOWN_DURATION</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">      <span class="n">_trail</span> <span class="p">=</span> <span class="n">GetComponentInChildren</span><span class="p">&lt;</span><span class="n">TrailRenderer</span><span class="p">&gt;();</span> <span class="c1">// 尝试自动找拖尾</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">FixedUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 只有在非传送冷却期才记录速度</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 防止刚传送完那一帧速度被重置导致动量丢失</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_cooldownTimer</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">_storedVelocity</span> <span class="p">=</span> <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">_cooldownTimer</span> <span class="p">-=</span> <span class="n">Time</span><span class="p">.</span><span class="n">fixedDeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">TeleportTo</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">newPosition</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">invertX</span> <span class="p">=</span> <span class="kc">false</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">invertY</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_cooldownTimer</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 冷却中，不传送</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">ExecuteTeleport</span><span class="p">(</span><span class="n">newPosition</span><span class="p">,</span> <span class="n">invertX</span><span class="p">,</span> <span class="n">invertY</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 使用协程来处理 Trail 的断开和重连</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">ExecuteTeleport</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">newPos</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">invertX</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">invertY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 1. 暂时关闭拖尾（防止拉丝）</span>
</span></span><span class="line"><span class="cl">      <span class="kt">float</span> <span class="n">originalTime</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_trail</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">originalTime</span> <span class="p">=</span> <span class="n">_trail</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">_trail</span><span class="p">.</span><span class="n">time</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="c1">// 将时间设为0会清除当前拖尾</span>
</span></span><span class="line"><span class="cl">          <span class="n">_trail</span><span class="p">.</span><span class="n">emitting</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 2. 移动位置</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">newPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 3. 计算并应用新速度</span>
</span></span><span class="line"><span class="cl">      <span class="n">Vector2</span> <span class="n">newVel</span> <span class="p">=</span> <span class="n">_storedVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">invertX</span><span class="p">)</span> <span class="n">newVel</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">newVel</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">invertY</span><span class="p">)</span> <span class="n">newVel</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="p">-</span><span class="n">newVel</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">newVel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 开启冷却</span>
</span></span><span class="line"><span class="cl">      <span class="n">_cooldownTimer</span> <span class="p">=</span> <span class="n">COOLDOWN_DURATION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 4. 等待一帧，让渲染引擎更新位置，不再拉丝</span>
</span></span><span class="line"><span class="cl">      <span class="k">yield</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 5. 恢复拖尾</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_trail</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">_trail</span><span class="p">.</span><span class="n">time</span> <span class="p">=</span> <span class="n">originalTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">_trail</span><span class="p">.</span><span class="n">emitting</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="使用场景与示例制作一对传送门">使用场景与示例：制作一对传送门
</h6><p>你需要两个物体：PortalA 和 PortalB，以及一个主角。</p>
<p><strong>Portal.cs (传送门触发器)</strong>
public class Portal : MonoBehaviour
{
public Transform targetPortal; // 连接到另一个门
public bool invertX; // 是否反转X速度
void OnTriggerEnter2D(Collider2D other)
{
// 1. 检查是否是带传送功能的物体
var teleporter = other.GetComponent<PhysicsTeleporter>();
if (teleporter != null)
{
// 2. 调用传送
// 注意：出点位置通常要稍微偏移一点，防止无限循环传送
Vector3 exitPos = targetPortal.position;
teleporter.TeleportTo(exitPos, invertX, false);
}
}
}</p>
<h3 id="核心技能点总结-8">核心技能点总结
</h3><ol>
<li>
<p><strong>FixedUpdate 缓存机制</strong>：</p>
<ul>
<li><strong>面试金句</strong>：处理物理反弹或传送逻辑时，永远不要相信 CollisionEnter 时刻的 velocity，永远要用 FixedUpdate 缓存的“上一帧速度”。</li>
</ul>
</li>
<li>
<p><strong>TrailRenderer 的坑</strong>：</p>
<ul>
<li>凡是涉及瞬移（Teleport/Respawn）的功能，必须处理 TrailRenderer。简单做法是 Clear()，更彻底的做法是暂时把 time 设为 0。</li>
</ul>
</li>
<li>
<p><strong>防抖动 (Debounce/Cooldown)</strong>：</p>
<ul>
<li>物理 Trigger 很容易在边缘反复触发。传送后给予 0.1~0.2秒 的无敌/冷却时间，是防止逻辑死锁的必要手段。</li>
</ul>
</li>
</ol>
<h2 id="十三智能生命周期控制器">十三、智能生命周期控制器
</h2><h3 id="代码全景分析-12">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：定时销毁物体。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>原型开发</strong>：快速测试功能。</p>
</li>
<li>
<p><strong>低频物体</strong>：比如几分钟才掉落一个的特殊道具，或者是过关后只出现一次的胜利特效。</p>
</li>
</ol>
</li>
<li>
<p><strong>2D 开发中的隐患</strong>：</p>
<ul>
<li>
<p><strong>GC（垃圾回收）卡顿</strong>：如果你把这个脚本挂在<strong>子弹</strong>或<strong>受击特效</strong>上，一把机枪每秒射出 20 发子弹，意味着每秒 new 20次，Destroy 20次。这会产生大量内存碎片，导致手机发烫、游戏周期性卡顿。</p>
</li>
<li>
<p><strong>对象池杀手</strong>：它会真的把物体从内存里删掉。如果你用了对象池，物体被它删了，池子再次引用该物体时就会报 MissingReferenceException（空引用）。</p>
</li>
</ul>
</li>
</ul>
<h3 id="场景示例错误示范-vs-正确示范">场景示例（错误示范 vs 正确示范）
</h3><p><strong>❌ 错误场景：挂在子弹上</strong>你做了一个弹幕游戏，同屏有 500 发子弹。你给子弹挂了这个脚本。</p>
<ul>
<li>后果：每一帧 Unity 都在忙着申请内存和释放内存，帧率从 60 掉到 15。</li>
</ul>
<p><strong>✅ 正确场景：挂在 Boss 死亡后的剧情道具上</strong>Boss 死了，掉落了一把“传说之剑”，这把剑只出现一次，捡不到就消失。</p>
<ul>
<li>理由：这种低频事件，为了省事直接 Destroy 是完全没问题的，没必要为了一个物体去建个对象池。</li>
</ul>
<ol>
<li>
<p><strong>自动识别粒子系统</strong>：如果是特效，应该等粒子播完再消失，而不是死板地读秒。</p>
</li>
<li>
<p><strong>兼容对象池</strong>：如果是池子里的东西，就<strong>归还</strong>；如果是临时生成的，就<strong>销毁</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">class</span> <span class="nc">SmartDespawn</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na"> [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na"> [Tooltip(&#34;固定存活时间（如果勾选 AutoDetectParticle 则此项无效）&#34;)]</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kt">float</span> <span class="n">lifeTime</span> <span class="p">=</span> <span class="m">2.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na"> [Tooltip(&#34;是否自动根据粒子特效的时长来决定存活时间&#34;)]</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kt">bool</span> <span class="n">autoDetectParticle</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na"> [Tooltip(&#34;如果是从对象池出来的，必须填入池子的 Tag，否则会直接 Destroy&#34;)]</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kt">string</span> <span class="n">poolTag</span> <span class="p">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="k">void</span> <span class="n">OnEnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kt">float</span> <span class="n">finalDelay</span> <span class="p">=</span> <span class="n">lifeTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 1. 智能检测粒子系统</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">autoDetectParticle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ParticleSystem</span> <span class="n">ps</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ParticleSystem</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">ps</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 粒子的 duration 只是发射时长，要加上 startLifetime 才是真正的存活时间</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 但通常 main.duration + startLifetime 比较保险，或者直接用 main.duration 如果是 loop=false</span>
</span></span><span class="line"><span class="cl">             <span class="n">finalDelay</span> <span class="p">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">duration</span> <span class="p">+</span> <span class="n">ps</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">startLifetime</span><span class="p">.</span><span class="n">constantMax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 2. 启动计时器</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 既然可能要回池子，就不能用 Destroy(go, time) 了</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 我们用 Invoke，因为它方便取消</span>
</span></span><span class="line"><span class="cl">     <span class="n">CancelInvoke</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">     <span class="n">Invoke</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Despawn</span><span class="p">),</span> <span class="n">finalDelay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="k">void</span> <span class="n">Despawn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 3. 核心分流逻辑：是销毁还是回池子？</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 检查是否有我们之前定义的 IPoolable 接口（或者直接根据 poolTag 判断）</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 这里演示配合之前的 ObjectPoolManager 使用</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">poolTag</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 如果填了 Tag，说明想回池子</span>
</span></span><span class="line"><span class="cl">         <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">ReturnObj</span><span class="p">(</span><span class="n">poolTag</span><span class="p">,</span> <span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">else</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 没填 Tag，或者是野生的物体，直接销毁</span>
</span></span><span class="line"><span class="cl">         <span class="n">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// 当物体被强制隐藏或手动回收时，取消正在进行的计时</span>
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">CancelInvoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="2d-特效管理的最佳实践">2D 特效管理的最佳实践
</h3><p>在 2D 游戏中，<strong>受击特效 (Hit Effect)</strong> 和 <strong>爆炸特效 (Explosion)</strong> 是最常用的。</p>
<p><strong>使用上述脚本的流程：</strong></p>
<ol>
<li>
<p><strong>制作特效 Prefab</strong>：做一个爆炸动画。</p>
</li>
<li>
<p><strong>挂载脚本</strong>：挂上 SmartDespawn。</p>
<ul>
<li>
<p>勾选 Auto Detect Particle。</p>
</li>
<li>
<p>Pool Tag 填入 &ldquo;Explosion&rdquo;。</p>
</li>
</ul>
</li>
<li>
<p><strong>放入池子</strong>：在 ObjectPoolManager 里注册 &ldquo;Explosion&rdquo;。</p>
</li>
<li>
<p><strong>调用</strong>：
// 怪物脚本</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">   <span class="k">void</span> <span class="n">OnDeath</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 从池子拿出来，SmartDespawn 的 OnEnable 会自动开始倒计时</span>
</span></span><span class="line"><span class="cl">       <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Spawn</span><span class="p">(</span><span class="s">&#34;Explosion&#34;</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li><strong>自动回收</strong>：粒子播完后，SmartDespawn 里的 Invoke 触发，执行 Despawn，因为它有 Tag，所以它会把自己还回池子，而不是销毁。</li>
</ol>
<h2 id="十五2d旋转器">十五、2D旋转器
</h2><h3 id="代码全景分析-13">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：让物体绕着 Z 轴（垂直于屏幕的轴）持续旋转。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>纯视觉物体</strong>：UI loading 图标、背景里的风车、金币特效。</p>
</li>
<li>
<p><strong>无物理交互的物体</strong>：不需要把玩家弹开，也不需要产生碰撞力的物体。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心逻辑</strong>：每帧修改 Transform 的欧拉角。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">class</span> <span class="nc">Rotator2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">  [Tooltip(&#34;旋转速度 (度/秒)&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">float</span> <span class="n">speed</span> <span class="p">=</span> <span class="m">180f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">  [Tooltip(&#34;是否顺时针&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">bool</span> <span class="n">clockwise</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">  [Tooltip(&#34;旋转轴向 (2D游戏通常选 Z)&#34;)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">rotateAxis</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span> <span class="c1">// 默认 (0, 0, 1)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 缓存组件</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果没有刚体，就在 Update 里做纯视觉旋转 (省性能)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_rb</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">PerformRotation</span><span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">void</span> <span class="n">FixedUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果有刚体，必须在 FixedUpdate 里做物理旋转 (保证碰撞正确)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_rb</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">PerformPhysicsRotation</span><span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">fixedDeltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 纯视觉旋转逻辑</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="k">void</span> <span class="n">PerformRotation</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">float</span> <span class="n">dir</span> <span class="p">=</span> <span class="n">clockwise</span> <span class="p">?</span> <span class="p">-</span><span class="m">1f</span> <span class="p">:</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 使用 Rotate 的轴向重载版本</span>
</span></span><span class="line"><span class="cl">      <span class="n">transform</span><span class="p">.</span><span class="n">Rotate</span><span class="p">(</span><span class="n">rotateAxis</span><span class="p">,</span> <span class="n">speed</span> <span class="p">*</span> <span class="n">dir</span> <span class="p">*</span> <span class="n">delta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 物理旋转逻辑</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="k">void</span> <span class="n">PerformPhysicsRotation</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">float</span> <span class="n">dir</span> <span class="p">=</span> <span class="n">clockwise</span> <span class="p">?</span> <span class="p">-</span><span class="m">1f</span> <span class="p">:</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 刚体旋转是基于 Z 轴的</span>
</span></span><span class="line"><span class="cl">      <span class="kt">float</span> <span class="n">angleChange</span> <span class="p">=</span> <span class="n">speed</span> <span class="p">*</span> <span class="n">dir</span> <span class="p">*</span> <span class="n">delta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// MoveRotation 是物理安全的旋转方式，它会计算摩擦力和碰撞</span>
</span></span><span class="line"><span class="cl">      <span class="n">_rb</span><span class="p">.</span><span class="n">MoveRotation</span><span class="p">(</span><span class="n">_rb</span><span class="p">.</span><span class="n">rotation</span> <span class="p">+</span> <span class="n">angleChange</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>简单装饰物（金币、背景）</strong>：直接用原来的代码（或者改良版自动走的 Update 分支），性能最好。</p>
</li>
<li>
<p><strong>交互陷阱（锯齿、风扇）</strong>：<strong>必须</strong>使用 Rigidbody2D.MoveRotation，否则碰撞检测会失效。</p>
</li>
<li>
<p><strong>旋转平台</strong>：必须使用物理旋转，并配合摩擦力设置。</p>
</li>
</ul>
<h2 id="十六鼠标点击响应器">十六、鼠标点击响应器
</h2><h3 id="代码全景分析-14">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：检测鼠标对 2D 物体的操作（点击、悬停、离开），并通过 UnityEvent 触发外部逻辑。</p>
</li>
<li>
<p><strong>依赖条件</strong>：</p>
<ol>
<li>
<p>物体必须有 <strong>Collider2D</strong>（BoxCollider2D, CircleCollider2D 等）。</p>
</li>
<li>
<p>场景中必须有摄像机（且摄像机视锥体覆盖该物体）。</p>
</li>
<li>
<p>不能被 UI 遮挡（但原生写法其实<strong>防不住</strong> UI 遮挡，详见下文）。</p>
</li>
</ol>
</li>
<li>
<p><strong>设计亮点</strong>：使用了 UnityEvent，这意味着策划人员可以直接在 Inspector 面板里拖拽赋值，不需要写代码就能实现“点击宝箱 -&gt; 播放动画”或“点击怪物 -&gt; 扣血”。</p>
</li>
</ul>
<h3 id="使用场景与示例-5">使用场景与示例
</h3><p><strong>场景：一个可以点击的宝箱</strong></p>
<ol>
<li>
<p><strong>场景设置</strong>：</p>
<ul>
<li>
<p>场景里放一个宝箱 Sprite。</p>
</li>
<li>
<p>给宝箱加 BoxCollider2D。</p>
</li>
<li>
<p>给宝箱挂 ClickableObject 脚本。</p>
</li>
</ul>
</li>
<li>
<p><strong>配置 Inspector</strong>：</p>
<ul>
<li>
<p>找到 On Click () 列表。</p>
</li>
<li>
<p>拖入宝箱自己的 Animator 组件。</p>
</li>
<li>
<p>选择函数 Animator.Play(&ldquo;ChestOpen&rdquo;)。</p>
</li>
<li>
<p>再拖入 SoundManager，选择 PlaySound(&ldquo;OpenBox&rdquo;)。
. <strong>效果</strong>：点击宝箱，自动播放开箱动画并播放音效，一行代码都不用多写
. ```csharp
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.EventSystems; // 1. 引入事件系统命名空间
// 2. 实现标准接口
[RequireComponent(typeof(Collider2D))]
public class ClickableObject : MonoBehaviour, IPointerClickHandler, IPointerEnterHandler, IPointerExitHandler, IPointerDownHandler
{</p>
<pre><code>  [Header(&quot;交互设置&quot;)]
  [Tooltip(&quot;是否允许穿透 UI 点击（通常选 False）&quot;)]
  public bool allowClickThroughUI = false;

  [Header(&quot;事件反馈&quot;)]
  public UnityEvent onClick;
  public UnityEvent onMouseEnter;
  public UnityEvent onMouseExit;
  public UnityEvent onMouseDown; // 新增：按下瞬间

  // 接口实现：点击（完整的按下+抬起过程）
  public void OnPointerClick(PointerEventData eventData)
  {
      // 这里不需要做 UI 阻挡判断，因为 EventSystem 会自动处理层级！
      // 只要 UI 挡在前面，这个方法压根不会触发（除非 UI 设置了不阻挡射线）。
      onClick?.Invoke();
  }

  // 接口实现：鼠标按下瞬间
  public void OnPointerDown(PointerEventData eventData)
  {
      onMouseDown?.Invoke();
  }

  // 接口实现：悬停进入
  public void OnPointerEnter(PointerEventData eventData)
  {
      // 手机上通常不会触发，除非按住滑动经过
      onMouseEnter?.Invoke();
  }

  // 接口实现：悬停离开
  public void OnPointerExit(PointerEventData eventData)
  {
      onMouseExit?.Invoke();
  }
</code></pre>
<p>}</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h3 id="关键设置必须做否则代码无效">关键设置（必须做，否则代码无效！）
</h3><p>要让上面的接口代码对 2D Sprite 生效，你必须做一件事：</p>
<ol>
<li>
<p>找到你的 <strong>Main Camera</strong>。</p>
</li>
<li>
<p>点击 Add Component，搜索并添加 <strong>Physics 2D Raycaster</strong> 组件。</p>
</li>
</ol>
<p><strong>原理</strong>：</p>
<ul>
<li>
<p>Unity 的 UI 系统（Canvas）默认只检测 UI 元素。</p>
</li>
<li>
<p>加上 Physics 2D Raycaster 后，摄像机会把物理世界的 Collider 也视为“UI 的一部分”发送给 EventSystem。</p>
</li>
<li>
<p><strong>好处</strong>：EventSystem 会根据深度（Depth）自动判断谁在前面。如果 UI 按钮在 Sprite 前面，点击时只有 UI 按钮会响，<strong>Sprite 不会响</strong>。完美解决了穿透问题！</p>
</li>
</ul>
<h3 id="核心技能点总结-9">核心技能点总结
</h3><ol>
<li>
<p><strong>UnityEvent 的威力</strong>：</p>
<ul>
<li>做工具类脚本时，尽量暴露 UnityEvent 给策划，而不是写死逻辑。</li>
</ul>
</li>
<li>
<p><strong>OnMouseDown vs EventInterfaces</strong>：</p>
<ul>
<li>
<p><strong>OnMouseDown</strong>：简单粗暴，适合快速原型，但防不住 UI 穿透，且难以处理多点触控。</p>
</li>
<li>
<p><strong>IPointerClickHandler</strong>：工业标准。统一了 UI 和 3D/2D 物体的输入逻辑，自动处理层级遮挡，支持多点触控 ID 区分。</p>
</li>
</ul>
</li>
<li>
<p><strong>Physics 2D Raycaster</strong>：</p>
<ul>
<li>这是打通 UI 系统和 2D 物理系统的桥梁。记住：<strong>要想用接口控制 Sprite，必须给摄像机加这个组件。</strong></li>
</ul>
</li>
</ol>
<h2 id="十七延迟执行器">十七、延迟执行器
</h2><h3 id="代码全景分析-15">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：延迟执行一段逻辑。</p>
</li>
<li>
<p><strong>设计模式</strong>：命令模式的简化版（通过 UnityEvent 封装命令）。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>特效回收</strong>：播放爆炸特效 -&gt; 等 1 秒 -&gt; Destroy 自身。</p>
</li>
<li>
<p><strong>连招重置</strong>：玩家停止攻击 -&gt; 等 0.5 秒 -&gt; 重置连招计数器。</p>
</li>
<li>
<p><strong>关卡机关</strong>：踩下按钮 -&gt; 等 2 秒 -&gt; 门打开。</p>
</li>
</ol>
</li>
<li>
<p><strong>优点</strong>：完全解耦。这个脚本不需要知道它要触发什么，只需要在 Inspector 面板里拖拽即可。</p>
</li>
</ul>
<h3 id="用场景与示例">用场景与示例
</h3><p><strong>场景：简单的宝箱开启</strong></p>
<ol>
<li>
<p><strong>设置</strong>：</p>
<ul>
<li>
<p>宝箱上挂 Animator（有 Open 动画）。</p>
</li>
<li>
<p>宝箱上挂 DelayAction（Delay = 0.5秒，对应动画播放到一半的时间）。</p>
</li>
<li>
<p>宝箱上挂 SoundManager（播放音效）。</p>
</li>
</ul>
</li>
<li>
<p><strong>配置 DelayAction</strong>：</p>
<ul>
<li>
<p>在 Inspector 的 Action 里，拖入 SoundManager.PlaySound。</p>
</li>
<li>
<p>这样就实现了：点击宝箱 -&gt; 播动画 -&gt; （延迟0.5秒） -&gt; 播音效。让音效和动画完美对齐。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Events</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DelayAction</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;延迟时间 (秒)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">delayTime</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否在 Start 时自动运行&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">playOnStart</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否循环执行&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">loop</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否使用真实时间 (不受 TimeScale=0 暂停影响)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">useRealTime</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;回调&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UnityEvent</span> <span class="n">action</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Coroutine</span> <span class="n">_currentCoroutine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnEnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// OnEnable 比 Start 更安全，因为对象池取出来时会触发 OnEnable，但不会再次触发 Start</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">playOnStart</span><span class="p">)</span> <span class="n">Execute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 养成好习惯：物体失活时，重置协程引用，防止逻辑错乱</span>
</span></span><span class="line"><span class="cl">        <span class="n">StopTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 开始执行延迟任务</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 防止重复调用导致开启多个计时器</span>
</span></span><span class="line"><span class="cl">        <span class="n">StopTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentCoroutine</span> <span class="p">=</span> <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">RunDelay</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 强制停止计时</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">StopTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_currentCoroutine</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">StopCoroutine</span><span class="p">(</span><span class="n">_currentCoroutine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">_currentCoroutine</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">RunDelay</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">useRealTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// UI 动画常用：不受暂停影响</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSecondsRealtime</span><span class="p">(</span><span class="n">delayTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 游戏逻辑常用：受暂停影响</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSeconds</span><span class="p">(</span><span class="n">delayTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span> <span class="c1">// 如果开启循环，就一直执行</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-10">核心技能点总结
</h3><ol>
<li>
<p><strong>协程 (Coroutine)</strong>：</p>
<ul>
<li>
<p>轻量级的多帧操作。记住：<strong>协程不是多线程</strong>，它依然是在主线程跑的。</p>
</li>
<li>
<p><strong>WaitForSeconds</strong> vs <strong>WaitForSecondsRealtime</strong> 的区别是面试常考题（受不受 TimeScale 影响）。</p>
</li>
</ul>
</li>
<li>
<p><strong>UnityEvent 的双刃剑</strong>：</p>
<ul>
<li>
<p><strong>好</strong>：策划喜欢，解耦。</p>
</li>
<li>
<p><strong>坏</strong>：性能比直接代码调用稍差（但在这种低频延迟逻辑里完全可以忽略），且代码里看不出调用关系（References 难找）。</p>
</li>
</ul>
</li>
<li>
<p><strong>生命周期陷阱</strong>：</p>
<ul>
<li>永远记住：<strong>GameObject SetActive(false) 会立刻杀死依附在它上面的所有协程</strong>。如果需要“死后依然执行”的逻辑，必须把协程交给一个不会死的物体（比如单例 GameManager）去跑。</li>
</ul>
</li>
</ol>
<h2 id="十八富文本构建器">十八、富文本构建器
</h2><h3 id="代码全景分析-16">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：封装 Unity 支持的富文本标签，通过 C# 代码动态生成带格式的字符串。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>UI 显示</strong>：动态拼接物品描述（如：“造成 <strong>50</strong> 点 &lt;color=red&gt;火焰</color> 伤害”）。</p>
</li>
<li>
<p><strong>Debug 调试</strong>：让控制台输出的信息五颜六色，方便分类查找。</p>
</li>
<li>
<p><strong>飘字特效</strong>：2D 游戏中常见的伤害数字（暴击时变大、变红）。</p>
</li>
</ol>
</li>
<li>
<p><strong>核心技巧</strong>：使用 ColorUtility.ToHtmlStringRGBA 将 Unity 的 Color 结构体转为 HTML 十六进制字符串</p>
</li>
</ul>
<h3 id="使用场景与示例-6">使用场景与示例
</h3><p><strong>场景 A：控制台调试神器</strong></p>
<p>你是否觉得 Unity 控制台全是白字，找不到重点?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;玩家 {RichText.Bold(&#34;</span><span class="n">Player1</span><span class="s">&#34;)} 进入了 {RichText.Color(&#34;</span><span class="err">危险区域</span><span class="s">&#34;, Color.red)}&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>场景 B：RPG 物品描述</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">string</span> <span class="n">GetItemDescription</span><span class="p">(</span><span class="kt">string</span> <span class="n">itemName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">damage</span><span class="p">,</span> <span class="kt">string</span> <span class="n">element</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 拼接出：获得 [火焰剑]，造成 100 点 火焰 伤害</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">nameStr</span> <span class="p">=</span> <span class="n">RichText</span><span class="p">.</span><span class="n">Color</span><span class="p">(</span><span class="s">$&#34;[{itemName}]&#34;</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">dmgStr</span> <span class="p">=</span> <span class="n">RichText</span><span class="p">.</span><span class="n">Size</span><span class="p">(</span><span class="n">damage</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="m">40</span><span class="p">);</span> <span class="c1">// 伤害数字大一点</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">eleStr</span> <span class="p">=</span> <span class="n">RichText</span><span class="p">.</span><span class="n">Color</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s">&#34;orange&#34;</span><span class="p">);</span> <span class="c1">// 直接用单词颜色</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">$&#34;获得 {nameStr}，造成 {dmgStr} 点 {eleStr} 伤害&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="示例代码">示例代码
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">RichText</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// === 基础版本 (方便低频使用) ===</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Bold</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="n">text</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">$&#34;&lt;b&gt;{text}&lt;/b&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Italic</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="n">text</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">$&#34;&lt;i&gt;{text}&lt;/i&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Size</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">$&#34;&lt;size={size}&gt;{text}&lt;/size&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Color</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">)</span> <span class="p">=&gt;</span> 
</span></span><span class="line"><span class="cl">        <span class="s">$&#34;&lt;color=#{ColorUtility.ToHtmlStringRGBA(color)}&gt;{text}&lt;/color&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// === TextMeshPro 专属标签 ===</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 插入图集中的图标 (例如 &lt;sprite=0&gt;)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Sprite</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">$&#34;&lt;sprite={index}&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 插入特定名称的图标 (例如 &lt;sprite name=&#34;GoldIcon&#34;&gt;)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Sprite</span><span class="p">(</span><span class="kt">string</span> <span class="n">spriteName</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">$&#34;&lt;sprite name=\&#34;</span><span class="p">{</span><span class="n">spriteName</span><span class="p">}</span><span class="err">\</span><span class="s">&#34;&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// === StringBuilder 高性能扩展 (高频环境专用) ===</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 追加加粗文本</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StringBuilder</span> <span class="n">AppendBold</span><span class="p">(</span><span class="k">this</span> <span class="n">StringBuilder</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&lt;b&gt;&#34;</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&lt;/b&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 追加颜色文本</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StringBuilder</span> <span class="n">AppendColor</span><span class="p">(</span><span class="k">this</span> <span class="n">StringBuilder</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&lt;color=#&#34;</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="n">ColorUtility</span><span class="p">.</span><span class="n">ToHtmlStringRGBA</span><span class="p">(</span><span class="n">color</span><span class="p">)).</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&lt;/color&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 追加带图标的文本</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StringBuilder</span> <span class="n">AppendIcon</span><span class="p">(</span><span class="k">this</span> <span class="n">StringBuilder</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spriteIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&lt;sprite=&#34;</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="n">spriteIndex</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="优化">优化：
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 高性能写法：</span>
</span></span><span class="line"><span class="cl"><span class="n">StringBuilder</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span> <span class="c1">// 最好缓存这个 sb，不要每帧 new</span>
</span></span><span class="line"><span class="cl"><span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34;HP: &#34;</span><span class="p">).</span><span class="n">AppendColor</span><span class="p">(</span><span class="n">currentHp</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">Color</span><span class="p">.</span><span class="n">green</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&#34; | MP: &#34;</span><span class="p">).</span><span class="n">AppendColor</span><span class="p">(</span><span class="n">currentMp</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">myTmpText</span><span class="p">.</span><span class="n">SetText</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span> <span class="c1">// TMP 支持直接传入 StringBuilder，零 GC！</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-11">核心技能点总结
</h3><ol>
<li>
<p><strong>富文本 (Rich Text)</strong>：</p>
<ul>
<li>这是 Unity UI 的基础。即使你不用代码生成，在 Inspector 里手动填 &lt;color=red&gt;HP</color> 也是基本功。</li>
</ul>
</li>
<li>
<p><strong>ColorUtility</strong>：</p>
<ul>
<li>记住这个类，处理颜色转换（Hex &lt;-&gt; Color）时它是最快最稳的。</li>
</ul>
</li>
<li>
<p><strong>字符串性能 (String Interning/GC)</strong>：</p>
<ul>
<li>字符串拼接（+ 或 $）在 C# 中是昂贵的。在游戏开发中，<strong>静态文本随便拼，动态高频文本用 Builder</strong>。</li>
</ul>
</li>
<li>
<p><strong>TextMeshPro (TMP)</strong>：</p>
<ul>
<li>TMP 是 2D 游戏字体的唯一选择。它不仅清晰，还支持 <sprite>（图文混排）、<page>（分页）、<link>（超链接）等高级标签，建议去查阅 TMP 的文档，这能极大丰富你的 UI 表现力。</li>
</ul>
</li>
</ol>
<h2 id="十九帧率计数器">十九、帧率计数器
</h2><h3 id="代码全景分析-17">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：实时计算并显示游戏的帧率（FPS）和帧时（ms）。</p>
</li>
<li>
<p><strong>算法逻辑</strong>：使用了<strong>加权移动平均算法</strong>（Weighted Moving Average）。它不是只显示当前这一帧的数据，而是让数值平滑过渡，防止数字跳动太快导致看不清。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>开发调试</strong>：检查游戏有没有掉帧卡顿。</p>
</li>
<li>
<p><strong>性能优化</strong>：对比优化前后的数值变化。</p>
</li>
</ul>
</li>
<li>
<p><strong>致命弱点</strong>：OnGUI 每帧运行，且代码中不断 new 对象和拼接字符串，会产生大量的<strong>垃圾内存（Garbage Collection）</strong>，反而可能导致游戏轻微卡顿。</p>
</li>
</ul>
<h3 id="使用场景">使用场景
</h3><p><strong>场景：寻找性能瓶颈</strong></p>
<ol>
<li>
<p>你发现游戏在生成大量怪物时变卡了。</p>
</li>
<li>
<p>挂上这个脚本，打包到手机上运行。</p>
</li>
<li>
<p>观察 FPS：平时 60，出怪时瞬间掉到 20。</p>
</li>
<li>
<p>观察 ms：平时 16ms，出怪时飙升到 50ms。</p>
</li>
<li>
<p><strong>结论</strong>：出怪逻辑（可能是 Instantiate）太耗时，需要优化（比如上对象池）。</p>
</li>
<li>
<p><strong>使用 TextMeshPro</strong>：清晰、美观，也是 Unity 的标准 UI。</p>
</li>
<li>
<p><strong>低频更新</strong>：每 0.5 秒更新一次文字，既看得清，又极大减少了字符串拼接的开销。</p>
</li>
<li>
<p><strong>颜色分级</strong>：FPS 高显示绿色，中等显示黄色，低显示红色（直观预警）。
using UnityEngine;
using TMPro; // 引入 TextMeshPro 命名空间
public class FPSDisplay : MonoBehaviour
{</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">TMPro</span><span class="p">;</span> <span class="c1">// 引入 TextMeshPro 命名空间 </span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">class</span> <span class="nc">FPSDisplay</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na"> [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na"> [Tooltip(&#34;拖入场景 Canvas 下的一个 TextMeshProUGUI 组件&#34;)]</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">TextMeshProUGUI</span> <span class="n">fpsText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na"> [Tooltip(&#34;刷新频率 (秒)，建议 0.5秒 更新一次，不要每帧更新&#34;)]</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kt">float</span> <span class="n">updateInterval</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_accum</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span> <span class="c1">// 累计时间</span>
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">int</span> <span class="n">_frames</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>   <span class="c1">// 累计帧数</span>
</span></span><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_timeLeft</span><span class="p">;</span>   <span class="c1">// 倒计时</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">_timeLeft</span> <span class="p">=</span> <span class="n">updateInterval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">fpsText</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">&#34;FPSDisplay: 还没有赋值 Text 组件！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="n">enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 1. 累计每一帧的时间和帧数</span>
</span></span><span class="line"><span class="cl">     <span class="n">_timeLeft</span> <span class="p">-=</span> <span class="n">Time</span><span class="p">.</span><span class="n">unscaledDeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="n">_accum</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">unscaledTimeScale</span> <span class="p">/</span> <span class="n">Time</span><span class="p">.</span><span class="n">unscaledDeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="n">_frames</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// 2. 时间到了，计算一次平均 FPS</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">_timeLeft</span> <span class="p">&lt;=</span> <span class="m">0.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 平均 FPS</span>
</span></span><span class="line"><span class="cl">         <span class="kt">float</span> <span class="n">fps</span> <span class="p">=</span> <span class="n">_accum</span> <span class="p">/</span> <span class="n">_frames</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 3. 设置颜色 (60以上绿，30以上黄，30以下红)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="p">&gt;=</span> <span class="m">60</span><span class="p">)</span> <span class="n">fpsText</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="p">&gt;=</span> <span class="m">30</span><span class="p">)</span> <span class="n">fpsText</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span> <span class="n">fpsText</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 4. 更新文本</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// {0:F1} 表示保留1位小数</span>
</span></span><span class="line"><span class="cl">         <span class="n">fpsText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&#34;{0:F1} FPS&#34;</span><span class="p">,</span> <span class="n">fps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 5. 重置计数器</span>
</span></span><span class="line"><span class="cl">         <span class="n">_timeLeft</span> <span class="p">=</span> <span class="n">updateInterval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">_accum</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">_frames</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="如何在项目中使用setup">如何在项目中使用（Setup）
</h3><ol>
<li>
<p><strong>创建 UI</strong>：</p>
<ul>
<li>
<p>在 Canvas 下创建一个 <strong>Text - TextMeshPro</strong>。</p>
</li>
<li>
<p>放在屏幕右上角，颜色设为白色，字体搞大点。</p>
</li>
<li>
<p>为了防止被游戏物体遮挡，确保它在 Canvas 的最下层（渲染顺序的最上层），或者使用 Overlay Canvas。</p>
</li>
</ul>
</li>
<li>
<p><strong>挂载脚本</strong>：</p>
<ul>
<li>
<p>创建一个空物体 System_FPS，挂载上面的脚本。</p>
</li>
<li>
<p>把刚才创建的 Text 拖进 fpsText 槽位。</p>
</li>
</ul>
</li>
<li>
<p><strong>运行</strong>：</p>
<ul>
<li>你会看到数字每 0.5 秒跳动一次，颜色会随着流畅度变化。</li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-12">核心技能点总结
</h3><ol>
<li>
<p><strong>OnGUI 的 obsolescence (过时)</strong>：</p>
<ul>
<li><strong>面试考点</strong>：尽量别在正式项目里用 OnGUI，除了它的性能差（每帧重绘、GC多），它还无法适配不同分辨率的屏幕。现在都是用 UGUI 或 UI Toolkit。</li>
</ul>
</li>
<li>
<p><strong>UnscaledDeltaTime</strong>：</p>
<ul>
<li><strong>必记</strong>：做 UI 动画、系统计时、FPS 统计时，永远优先考虑 Time.unscaledDeltaTime，否则游戏暂停时这些逻辑也会跟着“冻结”。</li>
</ul>
</li>
<li>
<p><strong>频率控制 (Throttling)</strong>：</p>
<ul>
<li><strong>优化思维</strong>：不需要每一帧都更新 UI 文本。人的眼睛看不清每秒闪烁 60 次的数字。降低更新频率（如 0.5s 一次）是 UI 性能优化的常见手段。</li>
</ul>
</li>
</ol>
<h2 id="二十刚体冻结器">二十、刚体冻结器
</h2><h3 id="代码全景分析-18">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：暂停和恢复物体的物理模拟。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>负面状态（Debuff）</strong>：比如被冰冻法术击中、被美杜莎石化。</p>
</li>
<li>
<p><strong>剧情演出</strong>：对话时强制锁定主角，不让玩家乱动。</p>
</li>
<li>
<p><strong>时间停止技能</strong>：类似《塞尔达传说：荒野之息》的“时停”符文。</p>
</li>
</ol>
</li>
<li>
<p><strong>核心原理</strong>：</p>
<ul>
<li>
<p><strong>Freeze</strong>：记录当前速度 -&gt; 切换为 Kinematic。</p>
<ul>
<li>Kinematic 特性：不受重力影响，不受力影响，像钉在墙上一样，但依然能挡住别人（有碰撞体积）。</li>
</ul>
</li>
<li>
<p><strong>Unfreeze</strong>：恢复刚体类型 -&gt; 将记录的速度塞回去。</p>
</li>
</ul>
</li>
</ul>
<h3 id="使用场景与示例-7">使用场景与示例
</h3><p><strong>场景：制作一个“冰冻地雷”</strong></p>
<ol>
<li>
<p><strong>设置</strong>：</p>
<ul>
<li>
<p>给主角挂上 RigidbodyFreezer。</p>
</li>
<li>
<p>制作一个地雷 Prefab，挂载以下脚本。</p>
</li>
</ul>
</li>
<li>
<p><strong>地雷脚本</strong>：</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">   <span class="kd">public</span> <span class="k">class</span> <span class="nc">IceMine</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">void</span> <span class="n">OnTriggerEnter2D</span><span class="p">(</span><span class="n">Collider2D</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="kt">var</span> <span class="n">freezer</span> <span class="p">=</span> <span class="n">other</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">RigidbodyFreezer</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="p">(</span><span class="n">freezer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="c1">// 冻住目标</span>
</span></span><span class="line"><span class="cl">           <span class="n">freezer</span><span class="p">.</span><span class="n">Freeze</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="c1">// 2秒后自动解冻</span>
</span></span><span class="line"><span class="cl">           <span class="c1">// 注意：这里需要一个协程或者延时调用，简单的可以用 Invoke</span>
</span></span><span class="line"><span class="cl">           <span class="n">freezer</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="s">&#34;Unfreeze&#34;</span><span class="p">,</span> <span class="m">2.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="c1">// 销毁地雷</span>
</span></span><span class="line"><span class="cl">           <span class="n">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(Rigidbody2D))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PhysicsFreezer2D</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Rigidbody2D</span> <span class="n">_rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_savedVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_savedAngularVelocity</span><span class="p">;</span> <span class="c1">// 【新增】保存旋转速度</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RigidbodyType2D</span> <span class="n">_savedType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用计数器而不是 bool，以处理多个冻结源同时作用的情况</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 例如：先被冰冻，还没解冻又触发了剧情锁定。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">_freezeCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 缓存 Animator，冻结物理时通常也要冻结动画</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_savedAnimSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody2D</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_animator</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Animator</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 永久冻结（直到手动解冻）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Freeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_freezeCount</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 只有第一次冻结时执行逻辑</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_freezeCount</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ApplyFreeze</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 暂时冻结指定时间（最常用的接口）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">FreezeForDuration</span><span class="p">(</span><span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">FreezeCoroutine</span><span class="p">(</span><span class="n">duration</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 解冻</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Unfreeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_freezeCount</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_freezeCount</span><span class="p">--;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 只有当所有冻结源都解除时，才真正恢复</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_freezeCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ApplyUnfreeze</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">ApplyFreeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 保存状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">_savedVelocity</span> <span class="p">=</span> <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_savedAngularVelocity</span> <span class="p">=</span> <span class="n">_rb</span><span class="p">.</span><span class="n">angularVelocity</span><span class="p">;</span> <span class="c1">// 保存旋转</span>
</span></span><span class="line"><span class="cl">        <span class="n">_savedType</span> <span class="p">=</span> <span class="n">_rb</span><span class="p">.</span><span class="n">bodyType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 冻结物理</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">angularVelocity</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">bodyType</span> <span class="p">=</span> <span class="n">RigidbodyType2D</span><span class="p">.</span><span class="n">Kinematic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 冻结动画 (可选，视需求而定)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_savedAnimSpeed</span> <span class="p">=</span> <span class="n">_animator</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_animator</span><span class="p">.</span><span class="n">speed</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">ApplyUnfreeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 恢复物理类型</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">bodyType</span> <span class="p">=</span> <span class="n">_savedType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 恢复速度 (注意顺序，先改类型再改速度，否则Kinematic可能不接受速度)</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">_savedVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rb</span><span class="p">.</span><span class="n">angularVelocity</span> <span class="p">=</span> <span class="n">_savedAngularVelocity</span><span class="p">;</span> <span class="c1">// 恢复旋转</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 恢复动画</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_animator</span><span class="p">.</span><span class="n">speed</span> <span class="p">=</span> <span class="n">_savedAnimSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">FreezeCoroutine</span><span class="p">(</span><span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Freeze</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSeconds</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Unfreeze</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-13">核心技能点总结
</h3><ol>
<li>
<p><strong>RigidbodyType2D</strong>：</p>
<ul>
<li>
<p><strong>Dynamic</strong>：受力、受重力（主角、怪）。</p>
</li>
<li>
<p><strong>Kinematic</strong>：不受力、不受重力，但可以代码移动，且是个坚硬的障碍物（移动平台、被冻住的主角）。</p>
</li>
<li>
<p><strong>Static</strong>：完全不动（墙壁）。</p>
</li>
</ul>
</li>
<li>
<p><strong>Rigibody.simulated vs bodyType</strong>：</p>
<ul>
<li>
<p>如果你想让物体<strong>消失</strong>（不挡子弹），用 rb.simulated = false。</p>
</li>
<li>
<p>如果你想让物体<strong>定格</strong>（挡子弹），用 rb.bodyType = Kinematic。</p>
</li>
</ul>
</li>
<li>
<p><strong>状态叠加管理</strong>：</p>
<ul>
<li>当一个状态（如冻结、无敌、沉默）可能由多个来源触发时，永远不要用 bool，要用 int 计数器。</li>
</ul>
</li>
</ol>
<h2 id="二十一随机激活器">二十一、随机激活器
</h2><h3 id="代码全景分析-19">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：互斥选择（Mutually Exclusive Selection）。确保父物体下<strong>有且仅有一个</strong>子物体是激活的，其余全部隐藏。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>场景装饰多样性</strong>：路边的一块石头，你做了 3 种造型，挂在这个脚本下，每次进游戏看到的石头形状都不一样。</p>
</li>
<li>
<p><strong>随机出生点</strong>：在地图上放 5 个点，随机选一个作为玩家出生位置。</p>
</li>
<li>
<p><strong>怪物换皮</strong>：同一个哥布林预制体，下面挂了“拿刀”、“拿剑”、“拿斧头”三个子模型，随机选一个显示。</p>
</li>
</ol>
</li>
<li>
<p><strong>性能隐患</strong>：使用了 new List<Transform>()，产生了不必要的堆内存分配。</p>
</li>
</ul>
<h3 id="使用场景与示例-8">使用场景与示例
</h3><p><strong>场景：2D 平台跳跃游戏中的“随机路障”</strong></p>
<ol>
<li>
<p><strong>制作 Prefab</strong>：</p>
<ul>
<li>
<p>创建一个空物体叫 RandomTrap。</p>
</li>
<li>
<p>在下面放三个子物体：</p>
<ol>
<li>
<p>Spikes (地刺 Sprite + Collider)</p>
</li>
<li>
<p>SawBlade (锯齿 Sprite + 旋转脚本 + Collider)</p>
</li>
<li>
<p>Empty (一个空物体，代表这里什么都没有，安全)</p>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>挂载脚本</strong>：</p>
<ul>
<li>给 RandomTrap 挂上 RandomActivator。</li>
</ul>
</li>
<li>
<p><strong>效果</strong>：</p>
<ul>
<li>
<p>你在关卡里拖入 10 个 RandomTrap。</p>
</li>
<li>
<p>玩家每次玩，这 10 个地方的路障分布完全不同，有些地方安全，有些地方是刺，增加了重玩价值（Rogue-lite 元素）。</p>
</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">RandomActivator</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否在 Start 时自动执行&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">activateOnStart</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否允许“全空”？(即可能运气好，所有物体都隐藏)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">allowEmpty</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">activateOnStart</span><span class="p">)</span> <span class="n">ActivateRandomChild</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 随机激活一个子物体 (零 GC 优化版)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// </span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">ActivateRandomChild</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">childCount</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">childCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">childCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 决定谁是那个“幸运儿”</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果允许空，我们就随机到 childCount (越界索引代表空)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">maxIndex</span> <span class="p">=</span> <span class="n">allowEmpty</span> <span class="p">?</span> <span class="n">childCount</span> <span class="p">+</span> <span class="m">1</span> <span class="p">:</span> <span class="n">childCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">targetIndex</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">maxIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 遍历子物体 (直接使用索引访问，不需要 List)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">childCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Transform</span> <span class="n">child</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">GetChild</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 3. 核心优化：只修改状态不一致的物体</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 只有当 i 等于目标索引时，shouldActive 为 true</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">shouldActive</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="n">targetIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查当前状态，避免重复调用 SetActive 触发不必要的 OnEnable/Disable</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">activeSelf</span> <span class="p">!=</span> <span class="n">shouldActive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">child</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="n">shouldActive</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-14">核心技能点总结
</h3><ol>
<li>
<p><strong>Transform 的数组特性</strong>：</p>
<ul>
<li>
<p><strong>必考题</strong>：Transform 实现了 IEnumerable，所以可以被 foreach。但它同时也提供了 childCount 和 GetChild(index)。</p>
</li>
<li>
<p><strong>优化准则</strong>：在性能敏感的代码中，优先使用 for 循环 + GetChild，而不是 foreach。</p>
</li>
</ul>
</li>
<li>
<p><strong>Dirty State Check (脏状态检查)</strong>：</p>
<ul>
<li>在调用 SetActive 或修改 text 之前，先判断一下值变没变。这是一个非常好的编程习惯，能减少 Unity 内部的开销（Layout Rebuild, Draw Call 变动等）。</li>
</ul>
</li>
<li>
<p><strong>随机性控制</strong>：</p>
<ul>
<li>理解 Random.Range 对整数是“包头不包尾”的。</li>
</ul>
</li>
</ol>
<h2 id="二十二全局事件总线">二十二、全局事件总线
</h2><h3 id="代码全景分析-20">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：允许任何系统发送消息，任何系统接收消息，两者无需互相引用。</p>
</li>
<li>
<p><strong>技术亮点</strong>：使用 <strong>泛型 (<T>)</strong> 和 <strong>Type 字典</strong> 来区分不同的事件类型。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>全局事件</strong>：游戏胜利、游戏暂停、玩家死亡。</p>
</li>
<li>
<p><strong>跨模块通讯</strong>：玩家吃金币（Player脚本发布），UI 增加分数（UI脚本订阅），播放音效（Audio脚本订阅）。</p>
</li>
</ul>
</li>
<li>
<p><strong>致命缺陷</strong>：原始代码使用了 Lambda 表达式包装器，导致<strong>无法取消订阅</strong>。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">EventBus</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 字典：Key是事件类型，Value是 C# 原生的 Delegate</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Delegate</span><span class="p">&gt;</span> <span class="n">_events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Delegate</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 订阅事件</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Subscribe</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">listener</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(!</span><span class="n">_events</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 强转为 Action&lt;T&gt; 进行合并</span>
</span></span><span class="line"><span class="cl">      <span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">+</span> <span class="n">listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 取消订阅 (现在可以正常工作了！)</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Unsubscribe</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">listener</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 强转并移除</span>
</span></span><span class="line"><span class="cl">          <span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">-</span> <span class="n">listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 如果委托链空了，可以考虑移除 Key 以节省内存</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">_events</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 发布事件</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">eventArgs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">currentDelegate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 强转回具体类型并调用</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 使用 Invoke 可以比 DynamicInvoke 快得多</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">currentDelegate</span> <span class="k">is</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">callback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">callback</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">eventArgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 切换场景时清理所有事件（防止静态变量持有已销毁对象的引用）</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">ClearAll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_events</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用场景与示例-9">使用场景与示例
</h3><p>在 2D 游戏中，我们经常需要处理 <strong>“拾取金币”</strong> 这个逻辑。</p>
<p><strong>Step 1: 定义事件结构体 (struct 比 class 更省 GC)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">struct</span> <span class="nc">EventCoinCollected</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">amount</span><span class="p">;</span> <span class="c1">// 金币数量</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">isSpecial</span><span class="p">;</span> <span class="c1">// 是否是特殊金币</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 2: 玩家脚本 (发布者)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Player</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">OnTriggerEnter2D</span><span class="p">(</span><span class="n">Collider2D</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">CompareTag</span><span class="p">(</span><span class="s">&#34;Coin&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 广播：我捡到钱了！至于谁关心这个，我不care。</span>
</span></span><span class="line"><span class="cl">                <span class="n">EventBus</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="k">new</span> <span class="n">EventCoinCollected</span> <span class="p">{</span> <span class="n">amount</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">isSpecial</span> <span class="p">=</span> <span class="kc">false</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">                <span class="n">Destroy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">gameObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 3: UI 脚本 (订阅者)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UIManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnEnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注册监听</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventBus</span><span class="p">.</span><span class="n">Subscribe</span><span class="p">&lt;</span><span class="n">EventCoinCollected</span><span class="p">&gt;(</span><span class="n">OnCoinCollected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ⚠️ 重要：销毁时必须取消订阅，否则报错</span>
</span></span><span class="line"><span class="cl">        <span class="n">EventBus</span><span class="p">.</span><span class="n">Unsubscribe</span><span class="p">&lt;</span><span class="n">EventCoinCollected</span><span class="p">&gt;(</span><span class="n">OnCoinCollected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 回调函数</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnCoinCollected</span><span class="p">(</span><span class="n">EventCoinCollected</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;UI更新：增加了 {e.amount} 金币&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// UpdateUIText(e.amount);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 4: 音效脚本 (另一个订阅者)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">AudioManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">OnEnable</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">EventBus</span><span class="p">.</span><span class="n">Subscribe</span><span class="p">&lt;</span><span class="n">EventCoinCollected</span><span class="p">&gt;(</span><span class="n">PlaySound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">EventBus</span><span class="p">.</span><span class="n">Unsubscribe</span><span class="p">&lt;</span><span class="n">EventCoinCollected</span><span class="p">&gt;(</span><span class="n">PlaySound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">PlaySound</span><span class="p">(</span><span class="n">EventCoinCollected</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">isSpecial</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">Play</span><span class="p">(</span><span class="s">&#34;BigCoinSound&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> 
</span></span><span class="line"><span class="cl">                <span class="n">Play</span><span class="p">(</span><span class="s">&#34;NormalCoinSound&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-15">核心技能点总结
</h3><ol>
<li>
<p><strong>解耦 (Decoupling)</strong>：</p>
<ul>
<li>你看上面的例子：Player 根本不知道 UIManager 和 AudioManager 的存在。你删掉 UI 脚本，玩家照样能捡钱，不会报错。这就是架构的魅力。</li>
</ul>
</li>
<li>
<p><strong>Struct vs Class 事件</strong>：</p>
<ul>
<li><strong>Struct</strong>：作为事件参数（T）时，分配在栈上（如果不用装箱），通常比 Class 更轻量，适合高频事件。</li>
</ul>
</li>
<li>
<p><strong>静态类的生命周期</strong>：</p>
<ul>
<li>
<p>static EventBus 在切换场景时<strong>不会</strong>自动清空。</p>
</li>
<li>
<p><strong>必考题</strong>：如果在 Scene A 里，一个物体订阅了事件，然后切换到 Scene B，物体被销毁了。如果 Event Bus 不清理，它还持有那个物体的引用。</p>
</li>
<li>
<p><strong>解决方案</strong>：在 GameManager 切换场景时调用 EventBus.ClearAll()，或者确保每个物体都严格写了 OnDisable -&gt; Unsubscribe。</p>
</li>
</ul>
</li>
<li>
<p><strong>Delegate 的本质</strong>：</p>
<ul>
<li>理解 Delegate 是一个链表。+= 是在链表末尾加节点，-= 是移除节点。修复版利用了这一点，避免了 Lambda 包装器的坑。</li>
</ul>
</li>
</ol>
<h2 id="二十三有限状态机">二十三、有限状态机
</h2><h3 id="代码全景分析-21">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：将复杂的逻辑拆分成一个个独立的“状态”（如待机、跑步、攻击），并由一个“机器”来管理状态之间的切换。</p>
</li>
<li>
<p><strong>设计模式</strong>：状态模式（State Pattern）。</p>
</li>
<li>
<p><strong>泛型设计</strong>：<T> 的使用非常高明，意味着这就一套代码可以给主角（StateMachine<Player>）用，也可以给Boss（StateMachine<Boss>）用，复用性极高。</p>
</li>
<li>
<p><strong>核心价值</strong>：<strong>解耦</strong>。攻击状态的代码只管攻击，不知道移动状态的存在；状态机只管切换，不知道具体逻辑</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">class</span> <span class="nc">StateMachine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">BaseState</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CurrentState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">BaseState</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">PreviousState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// 新增：记录前一个状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">T</span> <span class="n">_owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isTransitioningState</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 防止递归切换</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">T</span> <span class="n">owner</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_owner</span> <span class="p">=</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">ChangeState</span><span class="p">(</span><span class="n">BaseState</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">newState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_isTransitioningState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">CurrentState</span> <span class="p">==</span> <span class="n">newState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 防止重复进入同一状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">_isTransitioningState</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">CurrentState</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">CurrentState</span><span class="p">.</span><span class="n">Exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="n">PreviousState</span> <span class="p">=</span> <span class="n">CurrentState</span><span class="p">;</span> <span class="c1">// 记录前任</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">CurrentState</span> <span class="p">=</span> <span class="n">newState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">CurrentState</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">CurrentState</span><span class="p">.</span><span class="n">Enter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">_isTransitioningState</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// 返回到上一个状态 (常用于 攻击/硬直 结束后恢复 待机/移动)</span>
</span></span><span class="line"><span class="cl">  <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">RevertToPreviousState</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">PreviousState</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">ChangeState</span><span class="p">(</span><span class="n">PreviousState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">CurrentState</span><span class="p">?.</span><span class="n">Update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 物理更新，对于 2D 移动逻辑很重要</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">void</span> <span class="n">FixedUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 假设 BaseState 里也加了 FixedUpdate 方法</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// CurrentState?.FixedUpdate(); </span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用场景与示例编写一个-2d-巡逻怪">使用场景与示例：编写一个 2D 巡逻怪
</h3><p>假设我们有一个史莱姆（Slime），它有两个状态：<strong>巡逻（Patrol）</strong> 和 <strong>追逐（Chase）</strong>。</p>
<p><strong>步骤 1：定义宿主（Owner）</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">SlimeEnemy</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 状态机实例</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">SlimeEnemy</span><span class="p">&gt;</span> <span class="n">fsm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 缓存状态实例（优化点：避免 new 产生的 GC）</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PatrolState</span> <span class="n">patrolState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChaseState</span> <span class="n">chaseState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">moveSpeed</span> <span class="p">=</span> <span class="m">2f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Transform</span> <span class="n">player</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fsm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">SlimeEnemy</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化具体状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">patrolState</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PatrolState</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">chaseState</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChaseState</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 启动！</span>
</span></span><span class="line"><span class="cl">        <span class="n">fsm</span><span class="p">.</span><span class="n">ChangeState</span><span class="p">(</span><span class="n">patrolState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 驱动状态机运转</span>
</span></span><span class="line"><span class="cl">        <span class="n">fsm</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>步骤 2：编写具体状态</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 巡逻状态</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">PatrolState</span> <span class="p">:</span> <span class="n">BaseState</span><span class="p">&lt;</span><span class="n">SlimeEnemy</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">PatrolState</span><span class="p">(</span><span class="n">SlimeEnemy</span> <span class="n">owner</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;开始巡逻...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// _owner.animator.Play(&#34;Walk&#34;);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 简单的向左移动</span>
</span></span><span class="line"><span class="cl">            <span class="n">_owner</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">Vector2</span><span class="p">.</span><span class="n">left</span> <span class="p">*</span> <span class="n">_owner</span><span class="p">.</span><span class="n">moveSpeed</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 检测：如果发现玩家，切换到追逐状态</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">.</span><span class="n">Distance</span><span class="p">(</span><span class="n">_owner</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">_owner</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">position</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">5f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_owner</span><span class="p">.</span><span class="n">fsm</span><span class="p">.</span><span class="n">ChangeState</span><span class="p">(</span><span class="n">_owner</span><span class="p">.</span><span class="n">chaseState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 追逐状态</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">ChaseState</span> <span class="p">:</span> <span class="n">BaseState</span><span class="p">&lt;</span><span class="n">SlimeEnemy</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ChaseState</span><span class="p">(</span><span class="n">SlimeEnemy</span> <span class="n">owner</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;发现玩家！开始追逐！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// _owner.animator.Play(&#34;Run&#34;);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 向玩家移动</span>
</span></span><span class="line"><span class="cl">            <span class="n">_owner</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">MoveTowards</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_owner</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_owner</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_owner</span><span class="p">.</span><span class="n">moveSpeed</span> <span class="p">*</span> <span class="m">2</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果玩家跑远了，切回巡逻</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">.</span><span class="n">Distance</span><span class="p">(</span><span class="n">_owner</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">_owner</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">position</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">8f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_owner</span><span class="p">.</span><span class="n">fsm</span><span class="p">.</span><span class="n">ChangeState</span><span class="p">(</span><span class="n">_owner</span><span class="p">.</span><span class="n">patrolState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-16">核心技能点总结
</h3><ol>
<li>
<p><strong>多态 (Polymorphism)</strong>：</p>
<ul>
<li>StateMachine 持有的是父类 BaseState 的引用，但实际运行的是子类 PatrolState 的逻辑。这是面向对象编程的精髓。</li>
</ul>
</li>
<li>
<p><strong>避免 GC (Garbage Collection)</strong>：</p>
<ul>
<li>
<p><strong>新手陷阱</strong>：fsm.ChangeState(new AttackState(this))。千万别这么写！这样每次切换都在分配内存，会导致卡顿。</p>
</li>
<li>
<p><strong>正确做法</strong>：像上面的示例一样，在 Start 里把所有状态都 new 好存起来，切换时只传引用。</p>
</li>
</ul>
</li>
<li>
<p><strong>Owner 模式</strong>：</p>
<ul>
<li>状态类不存储数据（如血量、速度），只存储行为逻辑。数据全部存在 Owner（宿主）身上。这样保证了状态类是轻量级的。</li>
</ul>
</li>
<li>
<p><strong>FixedUpdate 的必要性</strong>：</p>
<ul>
<li>在 2D 游戏中，移动逻辑通常涉及 Rigidbody2D，建议在 BaseState 和 StateMachine 中增加 FixedUpdate 虚方法，专门处理物理逻辑。</li>
</ul>
</li>
</ol>
<h2 id="二十四数值修饰器">二十四、数值修饰器
</h2><h3 id="代码全景分析-22">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：管理一个数值（如攻击力），并自动计算来自不同来源（装备、药水、天赋）的加成。</p>
</li>
<li>
<p><strong>核心模式</strong>：<strong>脏标记模式（Dirty Flag Pattern）</strong>。</p>
<ul>
<li>
<p>痛点：如果每帧（Update）都去遍历几十个 Buff 来计算攻击力，CPU 会爆炸。</p>
</li>
<li>
<p>解法：只有当 Buff 发生增减时，才标记为“脏（Dirty）”。下次有人问“多少攻？”时，发现是脏的才重新算；如果不是脏的，直接返回上次算好的缓存。</p>
</li>
</ul>
</li>
<li>
<p><strong>数学模型</strong>：标准 RPG 公式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">Final</span><span class="p">=(</span><span class="n">Base</span><span class="p">+</span><span class="n">Flat</span><span class="p">)</span><span class="err">×</span><span class="p">(</span><span class="m">1</span><span class="p">+</span><span class="err">∑</span><span class="p">%</span><span class="n">Add</span><span class="p">)</span><span class="err">×</span><span class="p">(</span><span class="err">∏</span><span class="p">%</span><span class="n">Mult</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[Serializable]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Stat</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [SerializeField]</span> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_baseValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 优化 1: 保持列表有序，计算速度更快</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StatModifier</span><span class="p">&gt;</span> <span class="n">_modifiers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StatModifier</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isDirty</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_cachedValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">BaseValue</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">_baseValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span> <span class="p">{</span> <span class="n">_baseValue</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="n">_isDirty</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Value</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_isDirty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_cachedValue</span> <span class="p">=</span> <span class="n">CalculateFinalValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">_isDirty</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_cachedValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Stat</span><span class="p">(</span><span class="kt">float</span> <span class="n">baseValue</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_baseValue</span> <span class="p">=</span> <span class="n">baseValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">AddModifier</span><span class="p">(</span><span class="n">StatModifier</span> <span class="n">mod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_modifiers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isDirty</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 优化 2: 每次添加后排序，确保 Flat 在前，Mult 在后</span>
</span></span><span class="line"><span class="cl">        <span class="n">_modifiers</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">CompareModifierOrder</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 优化 3: 根据来源批量移除 (卸载装备神器)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">RemoveAllModifiersFromSource</span><span class="p">(</span><span class="kt">object</span> <span class="n">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">didRemove</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 倒序遍历删除是安全的</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">_modifiers</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_modifiers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Source</span> <span class="p">==</span> <span class="n">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_modifiers</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">didRemove</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">didRemove</span><span class="p">)</span> <span class="n">_isDirty</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">didRemove</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">CompareModifierOrder</span><span class="p">(</span><span class="n">StatModifier</span> <span class="n">a</span><span class="p">,</span> <span class="n">StatModifier</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Type</span> <span class="p">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span> <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Type</span> <span class="p">&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">CalculateFinalValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">finalValue</span> <span class="p">=</span> <span class="n">BaseValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">sumPercentAdd</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 因为排好序了，Flat 一定在 PercentAdd 前面，逻辑更清晰，但这里为了兼容混合计算，</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 我们还是得遍历。不过有序列表对于某些复杂的 Order 需求很有帮助。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_modifiers</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">StatModifier</span> <span class="n">mod</span> <span class="p">=</span> <span class="n">_modifiers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">Flat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">finalValue</span> <span class="p">+=</span> <span class="n">mod</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">PercentAdd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sumPercentAdd</span> <span class="p">+=</span> <span class="n">mod</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 这里有个细节：如果列表是有序的，当遇到第一个 PercentAdd 时，</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 说明所有的 Flat 都加完了。</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">PercentMult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 在进入乘法计算前，先结算前面的加成</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 但为了逻辑简单，通常建议还是分两步，或者像原代码那样。</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 工业级通常会有更复杂的 Order 字段，这里保持原逻辑。</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 重新整理一遍最高效的算法 (O(N) 一次遍历)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 实际上由于 PercentAdd 是加在一起再乘的，必须全部统计完 PercentAdd 才能乘。</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 所以原代码的逻辑其实是正确的，但我们可以写得更紧凑。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 让我们用最稳健的 O(2N) 逻辑，或者 O(N) 配合多个变量</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 推荐：还是用三个累加器，遍历一次</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CalculateFast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">CalculateFast</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">finalValue</span> <span class="p">=</span> <span class="n">BaseValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">sumPercentAdd</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">finalMult</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_modifiers</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">mod</span> <span class="p">=</span> <span class="n">_modifiers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">Flat</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">finalValue</span> <span class="p">+=</span> <span class="n">mod</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">PercentAdd</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">sumPercentAdd</span> <span class="p">+=</span> <span class="n">mod</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">PercentMult</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">finalMult</span> <span class="p">*=</span> <span class="n">mod</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 公式：(Base + Flat) * (1 + sum%) * (mult1 * mult2...)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">finalValue</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">+</span> <span class="n">sumPercentAdd</span><span class="p">))</span> <span class="p">*</span> <span class="n">finalMult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用场景与示例-10">使用场景与示例
</h3><p><strong>场景：主角装备了一把剑，并喝了一瓶狂暴药水</strong></p>
<p><strong>PlayerStats.cs</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PlayerStats</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义攻击力，初始 10 点</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Stat</span> <span class="n">attack</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Stat</span><span class="p">(</span><span class="m">10f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;初始攻击: &#34;</span> <span class="p">+</span> <span class="n">attack</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">// 输出 10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 穿上一把铁剑 (+5 固定攻击)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">swordMod</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StatModifier</span><span class="p">(</span><span class="m">5f</span><span class="p">,</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">Flat</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">attack</span><span class="p">.</span><span class="n">AddModifier</span><span class="p">(</span><span class="n">swordMod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;穿剑后: &#34;</span> <span class="p">+</span> <span class="n">attack</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">// 输出 15</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 喝狂暴药水 (+50% 攻击)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">potionMod</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StatModifier</span><span class="p">(</span><span class="m">0.5f</span><span class="p">,</span> <span class="n">ModifierType</span><span class="p">.</span><span class="n">PercentAdd</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">attack</span><span class="p">.</span><span class="n">AddModifier</span><span class="p">(</span><span class="n">potionMod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 计算逻辑: (10 + 5) * (1 + 0.5) = 22.5</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;喝药后: &#34;</span> <span class="p">+</span> <span class="n">attack</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">// 输出 22.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 药水过期 (移除)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attack</span><span class="p">.</span><span class="n">RemoveModifier</span><span class="p">(</span><span class="n">potionMod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;药效结束: &#34;</span> <span class="p">+</span> <span class="n">attack</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">// 回到 15</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-17">核心技能点总结
</h3><ol>
<li>
<p><strong>脏标记 (Dirty Flag)</strong>：</p>
<ul>
<li><strong>面试必考</strong>：每当数据可能发生变化时，不立即计算，而是立一个 Flag。只有在外界请求数据时，才检查 Flag 决定是否计算。这是图形学、物理引擎和数值策划中通用的优化手段。</li>
</ul>
</li>
<li>
<p><strong>数值公式顺序</strong>：</p>
<ul>
<li>
<p><strong>B -&gt; F -&gt; A -&gt; M</strong></p>
</li>
<li>
<p><strong>Base</strong> (基础)</p>
</li>
<li>
<p><strong>Flat</strong> (固定加值)</p>
</li>
<li>
<p><strong>Add</strong> (百分比叠加)</p>
</li>
<li>
<p><strong>Mult</strong> (独立乘区 - 稀有且强大)</p>
</li>
<li>
<p>理解这个顺序，你就能设计出平衡的装备系统。</p>
</li>
</ul>
</li>
<li>
<p><strong>依赖注入 (Source)</strong>：</p>
<ul>
<li>在 StatModifier 里存 object Source。这是一种简单的依赖注入思想。Modifier 知道是谁创造了它。这对于后续的逻辑清理（如 Buff 驱散、装备卸载）至关重要。</li>
</ul>
</li>
</ol>
<h2 id="二十五音频管理器">二十五、音频管理器
</h2><h3 id="代码全景分析-23">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：全局管理 BGM 和 SFX（音效）。</p>
</li>
<li>
<p><strong>依赖库</strong>：<strong>DOTween</strong>。这是 Unity 最好用的动画插件，在这里用于处理音量的线性插值。</p>
</li>
<li>
<p><strong>亮点</strong>：</p>
<ul>
<li>
<p><strong>淡入淡出 (Cross-fading)</strong>：音乐切换时先变小声，切歌，再变大声，非常丝滑。</p>
</li>
<li>
<p><strong>单例模式</strong>：保证全局只有一个音频控制器，且跨场景存在。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Audio</span><span class="p">;</span> <span class="c1">// 引入 Mixer 命名空间</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">AudioManager</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">AudioManager</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;组件配置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioSource</span> <span class="n">musicSource</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioSource</span> <span class="n">sfxSource</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;混音器 (必填)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 请在 Unity 资源里创建一个 AudioMixer，并拖入这里的 Group</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioMixerGroup</span> <span class="n">musicGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioMixerGroup</span> <span class="n">sfxGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">musicFadeDuration</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 缓存玩家设置的音乐音量 (0~1)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_targetMusicVolume</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span> <span class="c1">// 确保单例初始化</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 自动补全 AudioSource</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">musicSource</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">sfxSource</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">sfxSource</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 配置 AudioSource</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">loop</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">musicGroup</span><span class="p">;</span> <span class="c1">// 绑定 Mixer</span>
</span></span><span class="line"><span class="cl">        <span class="n">sfxSource</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">sfxGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 播放背景音乐 (修复了音量重置 Bug)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayMusic</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果是同一首，啥也不做</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">==</span> <span class="n">clip</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 杀掉旧的动画，防止快速切换导致回调混乱</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 如果当前没在播，直接开始</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="n">_targetMusicVolume</span><span class="p">,</span> <span class="n">musicFadeDuration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 如果在播，执行标准 FadeOut -&gt; Switch -&gt; FadeIn 流程</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">musicFadeDuration</span><span class="p">).</span><span class="n">OnComplete</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 这里 fade 回 _targetMusicVolume，而不是 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="n">_targetMusicVolume</span><span class="p">,</span> <span class="n">musicFadeDuration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 播放音效 (带随机音调)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlaySFX</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">volumeScale</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">randomPitch</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 简单的随机音调，增加 2D 游戏的打击感</span>
</span></span><span class="line"><span class="cl">        <span class="n">sfxSource</span><span class="p">.</span><span class="n">pitch</span> <span class="p">=</span> <span class="n">randomPitch</span> <span class="p">?</span> <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0.9f</span><span class="p">,</span> <span class="m">1.1f</span><span class="p">)</span> <span class="p">:</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sfxSource</span><span class="p">.</span><span class="n">PlayOneShot</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">volumeScale</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 调节音乐音量 (用于设置菜单)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetMusicVolume</span><span class="p">(</span><span class="kt">float</span> <span class="n">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_targetMusicVolume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp01</span><span class="p">(</span><span class="n">volume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果当前正在播放，实时调整</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 只有当音乐不处于 fade 过程中才调整，避免打断转场</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 但为了响应及时，通常直接 DOKill 并跳到目标值</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">_targetMusicVolume</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 真正的静音功能 (通过 Mixer)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetMasterVolume</span><span class="p">(</span><span class="kt">float</span> <span class="n">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// AudioMixer 的音量是分贝 (dB)，范围通常是 -80 到 0</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 需要把 0-1 的线性值转换为对数</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">db</span> <span class="p">=</span> <span class="n">volume</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">?</span> <span class="p">-</span><span class="m">80f</span> <span class="p">:</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Log10</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="p">*</span> <span class="m">20f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 假设你的 Mixer 里暴露了一个叫 &#34;MasterVolume&#34; 的参数</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicGroup</span><span class="p">.</span><span class="n">audioMixer</span><span class="p">.</span><span class="n">SetFloat</span><span class="p">(</span><span class="s">&#34;MasterVolume&#34;</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景与示例-11">使用场景与示例
</h3><p><strong>场景：主菜单 -&gt; 进入游戏</strong></p>
<ol>
<li>
<p><strong>Main Menu</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">   <span class="c1">// 播放舒缓的菜单音乐</span>
</span></span><span class="line"><span class="cl">   <span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlayMusic</span><span class="p">(</span><span class="n">menuThemeClip</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>点击开始游戏</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 播放点击音效</span>
</span></span><span class="line"><span class="cl"><span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlaySFX</span><span class="p">(</span><span class="n">buttonClickClip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 加载场景...</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>Level 1 Start</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 自动平滑切换到激昂的战斗音乐</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 即使你在 Start 里直接调用，因为有 fadeDuration，听起来也不会突兀</span>
</span></span><span class="line"><span class="cl"><span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlayMusic</span><span class="p">(</span><span class="n">battleThemeClip</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="核心技能点总结-18">核心技能点总结
</h3><ol>
<li>
<p><strong>DOKill (Tween Killing)</strong>：</p>
<ul>
<li>在处理异步动画（Fade）时，永远要假设<strong>玩家的手速比你代码快</strong>。如果玩家在 0.5 秒内连续切了 3 次 BGM，不加 DOKill 你的音量会乱跳。</li>
</ul>
</li>
<li>
<p><strong>PlayOneShot 的叠加性</strong>：</p>
<ul>
<li>AudioSource 在播放 PlayOneShot 时，是一个<strong>混合器</strong>。它可以在同一个 Source 上混合播放多个不同的 Clip。但要注意总音量不要爆表。</li>
</ul>
</li>
<li>
<p><strong>AudioMixer (分贝 vs 线性)</strong>：</p>
<ul>
<li>
<p>AudioSource.volume 是 0~1 (线性)。</p>
</li>
<li>
<p>AudioMixer 是 -80dB ~ 0dB (对数)。</p>
</li>
<li>
<p><strong>面试必问</strong>：如何将 slider 的值给 Mixer？公式是 Mathf.Log10(sliderValue) * 20。</p>
</li>
</ul>
</li>
<li>
<p><strong>State Retention (状态保持)</strong>：</p>
<ul>
<li>当你编写任何涉及“渐变动画”的系统时，务必引入一个变量（如 _targetMusicVolume）来记录“动画结束后应该停留的值”，而不是硬编码目标值。</li>
</ul>
</li>
</ol>
<h2 id="音频系统结合">[音频系统结合]
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Audio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">DG.Tweening</span><span class="p">;</span> <span class="c1">// 必须引用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">AudioManager</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">AudioManager</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;🔗 连接设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;Unity 的 AudioMixer 资源&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioMixerGroup</span> <span class="n">musicGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioMixerGroup</span> <span class="n">sfxGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;🎵 BGM 设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AudioSource</span> <span class="n">musicSource</span><span class="p">;</span> <span class="c1">// 专门播 BGM 的源</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">musicFadeTime</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;🔊 SFX 对象池设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">poolSize</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;</span> <span class="n">_sfxPool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">GameObject</span> <span class="n">_poolRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 运行时状态</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_targetMusicVol</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 初始化 BGM 轨道</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">musicSource</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">loop</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">musicGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 初始化 SFX 对象池</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitSFXPool</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// =========================================================</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 第一部分：BGM 管理 (DOTween 渐变)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// =========================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayMusic</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果是同一首，不重播</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">==</span> <span class="n">clip</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span> <span class="c1">// 打断之前的渐变</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果当前是静音或空的，直接淡入</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="p">!</span><span class="n">musicSource</span><span class="p">.</span><span class="n">isPlaying</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="n">_targetMusicVolume</span><span class="p">,</span> <span class="n">musicFadeTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 否则：淡出旧的 -&gt; 换碟 -&gt; 淡入新的</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">musicFadeTime</span><span class="p">).</span><span class="n">OnComplete</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">musicSource</span><span class="p">.</span><span class="n">DOFade</span><span class="p">(</span><span class="n">_targetMusicVolume</span><span class="p">,</span> <span class="n">musicFadeTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetMusicVolume</span><span class="p">(</span><span class="kt">float</span> <span class="n">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_targetMusicVolume</span> <span class="p">=</span> <span class="n">volume</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">DOKill</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">musicSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">volume</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// =========================================================</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 第二部分：SFX 管理 (对象池 + 2D 空间感)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// =========================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">InitSFXPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sfxPool</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_poolRoot</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">(</span><span class="s">&#34;SFX_Pool_Root&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_poolRoot</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">poolSize</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CreatePoolItem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AudioSource</span> <span class="n">CreatePoolItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GameObject</span> <span class="n">go</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GameObject</span><span class="p">(</span><span class="s">&#34;Pooled_SFX&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">_poolRoot</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AudioSource</span> <span class="n">source</span> <span class="p">=</span> <span class="n">go</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">sfxGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">playOnAwake</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2D 游戏关键设置：Spatial Blend = 0 (不受 Z 轴距离影响)</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">spatialBlend</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">go</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sfxPool</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 播放 2D 空间音效 (支持立体声定位)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlaySound</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">volume</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="kt">float</span> <span class="n">pitchRandom</span> <span class="p">=</span> <span class="m">0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 从池取对象</span>
</span></span><span class="line"><span class="cl">        <span class="n">AudioSource</span> <span class="n">source</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_sfxPool</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">source</span> <span class="p">=</span> <span class="n">_sfxPool</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="n">source</span> <span class="p">=</span> <span class="n">CreatePoolItem</span><span class="p">();</span> <span class="c1">// 自动扩容</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">worldPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 2D 立体声计算 (左边响左耳，右边响右耳)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Camera</span><span class="p">.</span><span class="n">main</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector3</span> <span class="n">viewportPos</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">WorldToViewportPoint</span><span class="p">(</span><span class="n">worldPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">pan</span> <span class="p">=</span> <span class="p">(</span><span class="n">viewportPos</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="m">0.5f</span><span class="p">)</span> <span class="p">*</span> <span class="m">2f</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="p">.</span><span class="n">panStereo</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">pan</span><span class="p">,</span> <span class="p">-</span><span class="m">0.8f</span><span class="p">,</span> <span class="m">0.8f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 随机音调</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">pitch</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">+</span> <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(-</span><span class="n">pitchRandom</span><span class="p">,</span> <span class="n">pitchRandom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">volume</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">Play</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 回收</span>
</span></span><span class="line"><span class="cl">        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">ReturnToPool</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">clip</span><span class="p">.</span><span class="n">length</span> <span class="p">/</span> <span class="n">source</span><span class="p">.</span><span class="n">pitch</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 播放 UI 音效 (无空间感)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlayUISound</span><span class="p">(</span><span class="n">AudioClip</span> <span class="n">clip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">volume</span> <span class="p">=</span> <span class="m">1f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">clip</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 复用 BGM 的 AudioSource 来播 UI 声也可以，或者单独再开一个 UI Source</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这里为了简单，使用 PlayOneShot 挂在 musicSource 上（如果不介意混音组的话）</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 或者直接调用 PlaySound 并传入屏幕中心位置</span>
</span></span><span class="line"><span class="cl">        <span class="n">PlaySound</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">ReturnToPool</span><span class="p">(</span><span class="n">AudioSource</span> <span class="n">source</span><span class="p">,</span> <span class="kt">float</span> <span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSeconds</span><span class="p">(</span><span class="n">delay</span> <span class="p">+</span> <span class="m">0.1f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sfxPool</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用指南如何调用">使用指南：如何调用？
</h3><p>现在，你只需要和这一个 AudioManager 打交道，逻辑非常清晰：</p>
<p><strong>场景 A：进入 Boss 战</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// 调用 BGM 模块，自动淡入淡出</span>
</span></span><span class="line"><span class="cl">    <span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlayMusic</span><span class="p">(</span><span class="n">bossBattleBGM</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>场景 B：主角开枪</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 调用 SFX 模块，带对象池和随机音调</span>
</span></span><span class="line"><span class="cl"><span class="c1">// transform.position 决定了声音是从左边还是右边传来</span>
</span></span><span class="line"><span class="cl"><span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlaySound</span><span class="p">(</span><span class="n">gunShotClip</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">,</span> <span class="m">0.1f</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>场景 C：点击 UI 按钮</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 简单的 UI 音效</span>
</span></span><span class="line"><span class="cl"><span class="n">AudioManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">PlayUISound</span><span class="p">(</span><span class="n">clickClip</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="二十六调试控制台">二十六、调试控制台
</h2><h3 id="代码全景分析-24">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：提供作弊指令（回血、秒杀全屏、获得道具）。</p>
</li>
<li>
<p><strong>关键特性</strong>：[ContextMenu]。这是 Unity 编辑器扩展的一个小技巧，允许你给脚本的右上角齿轮菜单（或组件名右键菜单）添加自定义按钮。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>快速测试</strong>：测试数值平衡、测试死亡逻辑。</p>
</li>
<li>
<p><strong>Bug 复现</strong>：快速调整游戏状态到出错的那一刻。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 挂载在名为 [DebugSystem] 的物体上，并设为 DontDestroyOnLoad</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DebugCommands</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 只有在 Unity 编辑器里，或者开启了 &#34;Development Build&#34; 选项的包里，这段代码才生效</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 正式发售的 Release 包里，这段代码会被编译器直接删掉，极其安全！</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if</span> <span class="n">UNITY_EDITOR</span> <span class="p">||</span> <span class="n">DEVELOPMENT_BUILD</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;调试开关&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">showGUI</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 键盘快捷键触发</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">F1</span><span class="p">))</span> <span class="n">HealPlayer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">F2</span><span class="p">))</span> <span class="n">KillAllEnemies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 切换 GUI 显示 (按波浪号键 `)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">BackQuote</span><span class="p">))</span> <span class="n">showGUI</span> <span class="p">=</span> <span class="p">!</span><span class="n">showGUI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绘制简易的屏幕按钮 (IMGUI)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 虽然 IMGUI 性能一般且不仅好看，但作为调试工具它是最快的，不需要配 Canvas</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnGUI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">showGUI</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">GUILayout</span><span class="p">.</span><span class="n">BeginArea</span><span class="p">(</span><span class="k">new</span> <span class="n">Rect</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">300</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 标题</span>
</span></span><span class="line"><span class="cl">        <span class="n">GUILayout</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="s">&#34;--- 开发者控制台 ---&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">GUILayout</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="s">&#34;F1: 玩家回满血&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HealPlayer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">GUILayout</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="s">&#34;F2: 秒杀全屏敌人&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">KillAllEnemies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">GUILayout</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="s">&#34;F3: 加速游戏 (x2)&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span> <span class="p">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span> <span class="p">==</span> <span class="m">1.0f</span><span class="p">)</span> <span class="p">?</span> <span class="m">2.0f</span> <span class="p">:</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">GUILayout</span><span class="p">.</span><span class="n">EndArea</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 具体逻辑 ---</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [ContextMenu(&#34;Heal Player&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">HealPlayer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这里假设你有单例，且使用了 ?. 防止空引用报错</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果 PlayerController 为空，说明还没加载出主角，直接 return</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">.</span><span class="n">Instance</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PlayerController</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Health</span><span class="p">?.</span><span class="n">ResetHealth</span><span class="p">();</span> <span class="c1">// 假设有这个方法</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;&lt;color=green&gt;[Cheat] 玩家已回满血&lt;/color&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [ContextMenu(&#34;Nuke Enemies&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">KillAllEnemies</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 查找所有实现了&#34;受伤接口&#34;的物体，比只找 EnemyController 更通用</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 假设你有一个 IDamageable 接口</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">targets</span> <span class="p">=</span> <span class="n">FindObjectsOfType</span><span class="p">&lt;</span><span class="n">EnemyController</span><span class="p">&gt;();</span> 
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">targets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 造成巨量伤害</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">TakeDamage</span><span class="p">(</span><span class="m">999999</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;&lt;color=red&gt;[Cheat] 已清除 {targets.Length} 个敌人&lt;/color&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景-1">使用场景
</h3><ol>
<li>
<p><strong>场景运行中</strong>：游戏跑起来了，主角快被打死了。</p>
</li>
<li>
<p><strong>操作</strong>：</p>
<ul>
<li>
<p>在 Hierarchy 选中挂载了 DebugCommands 的物体。</p>
</li>
<li>
<p>在 Inspector 找到该组件。</p>
</li>
<li>
<p><strong>右键点击</strong>组件标题栏。</p>
</li>
<li>
<p>选择 Heal Player Full。</p>
</li>
</ul>
</li>
<li>
<p><strong>结果</strong>：主角瞬间满血。</p>
</li>
</ol>
<h3 id="核心技能点总结-19">核心技能点总结
</h3><ol>
<li>
<p><strong>编辑器扩展 (Editor Scripting)</strong>：</p>
<ul>
<li>[ContextMenu] 是最入门的编辑器扩展。进阶的还有 [MenuItem]（在顶部菜单栏加按钮）和 CustomEditor（重写 Inspector 面板）。</li>
</ul>
</li>
<li>
<p><strong>条件编译 (Conditional Compilation)</strong>：</p>
<ul>
<li>掌握 #if UNITY_EDITOR、#if UNITY_ANDROID 等宏指令，是发布多平台和区分 Debug/Release 的必备技能。</li>
</ul>
</li>
<li>
<p><strong>开发者体验 (DX)</strong>：</p>
<ul>
<li>好的代码不仅要给玩家好的体验，也要给和你一起工作的同事（策划、测试）好的体验。一个好用的 Debug 面板能让团队效率翻倍。</li>
</ul>
</li>
</ol>
<h2 id="二十七数据持久化">二十七、数据持久化
</h2><h3 id="代码全景分析-25">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：将 C# 对象序列化为 JSON 字符串并写入硬盘；读取文件并反序列化为 C# 对象。</p>
</li>
<li>
<p><strong>核心技术</strong>：</p>
<ul>
<li>
<p><strong>JsonUtility</strong>：Unity 原生的 JSON 库，速度极快（比著名的 Newtonsoft.Json 快），但功能有限（不能直接存 Dictionary，不能存顶层数组）。</p>
</li>
<li>
<p><strong>Application.persistentDataPath</strong>：<strong>面试必问</strong>。这是 Unity 提供的“沙盒路径”。在 Windows 上是 AppData，在 iOS/Android 上是应用私有文档目录。<strong>永远不要把存档写在 Assets 文件夹里</strong>，因为打包后 Assets 文件夹是只读的！</p>
</li>
</ul>
</li>
<li>
<p><strong>优缺点</strong>：</p>
<ul>
<li>
<p><strong>优点</strong>：简单、跨平台、人类可读（方便调试）。</p>
</li>
<li>
<p>*<em>缺点</em>：明文存储（玩家可以用记事本打开修改金币数量，容易作弊）。</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">SaveSystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">const</span> <span class="kt">string</span> <span class="n">FILE_EXT</span> <span class="p">=</span> <span class="s">&#34;.sav&#34;</span><span class="p">;</span> <span class="c1">// 使用自定义后缀，显得专业点</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">const</span> <span class="kt">string</span> <span class="n">ENCRYPTION_KEY</span> <span class="p">=</span> <span class="s">&#34;MySuperSecretKey&#34;</span><span class="p">;</span> <span class="c1">// 加密密钥</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 获取存档路径 (支持多槽位)</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">GetPath</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">persistentDataPath</span><span class="p">,</span> <span class="s">$&#34;save_slot_{slotIndex}{FILE_EXT}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 保存数据</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;param name=&#34;data&#34;&gt;数据对象&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;param name=&#34;slotIndex&#34;&gt;存档槽位 (0, 1, 2...)&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;param name=&#34;useEncryption&#34;&gt;是否加密&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slotIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useEncryption</span> <span class="p">=</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 序列化</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span> <span class="n">JsonUtility</span><span class="p">.</span><span class="n">ToJson</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">!</span><span class="n">useEncryption</span><span class="p">);</span> <span class="c1">// 加密就不需要格式化了</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. 加密处理</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">useEncryption</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">json</span> <span class="p">=</span> <span class="n">EncryptDecrypt</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. 写入文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="n">GetPath</span><span class="p">(</span><span class="n">slotIndex</span><span class="p">),</span> <span class="n">json</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;[SaveSystem] Saved to Slot {slotIndex}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">$&#34;[SaveSystem] Save Failed: {e.Message}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 读取数据</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span> <span class="n">Load</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">int</span> <span class="n">slotIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useEncryption</span> <span class="p">=</span> <span class="kc">true</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="n">GetPath</span><span class="p">(</span><span class="n">slotIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;[SaveSystem] Slot {slotIndex} not found, creating new.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 读取文件</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">content</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 解密</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">useEncryption</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="p">=</span> <span class="n">EncryptDecrypt</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 反序列化</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JsonUtility</span><span class="p">.</span><span class="n">FromJson</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">$&#34;[SaveSystem] Load Failed: {e.Message}, returning new data.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span> <span class="c1">// 出错时返回默认值，防止卡死</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 删除存档</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">DeleteSave</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="n">GetPath</span><span class="p">(</span><span class="n">slotIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 检查存档是否存在</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">bool</span> <span class="n">HasSave</span><span class="p">(</span><span class="kt">int</span> <span class="n">slotIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">GetPath</span><span class="p">(</span><span class="n">slotIndex</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// --- 简易异或加密 (XOR) ---</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 原理：对字符串的每个字符和密钥进行异或运算。两次异或就能还原。</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">EncryptDecrypt</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">StringBuilder</span> <span class="n">modifiedData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">modifiedData</span><span class="p">.</span><span class="n">Append</span><span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="n">ENCRYPTION_KEY</span><span class="p">[</span><span class="n">i</span> <span class="p">%</span> <span class="n">ENCRYPTION_KEY</span><span class="p">.</span><span class="n">Length</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">modifiedData</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --- 实用工具：List 包装器 ---</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解决 JsonUtility 无法直接序列化 List&lt;T&gt; 的问题</span>
</span></span><span class="line"><span class="cl"><span class="na">[System.Serializable]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">SerializationWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">SerializationWrapper</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">list</span> <span class="p">=</span> <span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景与示例-12">使用场景与示例
</h3><p>我们需要定义一个数据类来承载存档内容。</p>
<p><strong>Step 1: 定义存档数据结构 (GameData.cs)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[System.Serializable]</span> <span class="c1">// 必须加上这个标签，否则 JsonUtility 无法识别！</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">GameData</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">coins</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">currentLevel</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">playerHealth</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">playerPosition</span><span class="p">;</span> <span class="c1">// JsonUtility 支持 Vector3</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注意：JsonUtility 无法直接序列化 List&lt;T&gt; 或 Dictionary</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果需要存物品列表，建议用数组或封装一层</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">inventoryItemIds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 2: 在 GameManager 中调用</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">GameManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GameData</span> <span class="n">currentData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 游戏启动时读档</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentData</span> <span class="p">=</span> <span class="n">SaveSystem</span><span class="p">.</span><span class="n">LoadData</span><span class="p">&lt;</span><span class="n">GameData</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ApplyDataToGame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SaveGame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 收集当前状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentData</span><span class="p">.</span><span class="n">coins</span> <span class="p">=</span> <span class="n">PlayerWallet</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Coins</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentData</span><span class="p">.</span><span class="n">playerPosition</span> <span class="p">=</span> <span class="n">PlayerController</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 写入硬盘</span>
</span></span><span class="line"><span class="cl">        <span class="n">SaveSystem</span><span class="p">.</span><span class="n">SaveData</span><span class="p">(</span><span class="n">currentData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">ApplyDataToGame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 把读出来的数据应用到游戏里</span>
</span></span><span class="line"><span class="cl">        <span class="n">PlayerController</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">currentData</span><span class="p">.</span><span class="n">playerPosition</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-20">核心技能点总结
</h3><ol>
<li>
<p><strong>PersistentDataPath</strong>：</p>
<ul>
<li>
<p>永远不要把存档保存在 Application.dataPath（即 Assets 目录），这在编辑器里能用，但打包后那个文件夹是只读的，会导致游戏无法存档。</p>
</li>
<li>
<p>PC 路径通常在：C:\Users\用户名\AppData\LocalLow\公司名\游戏名。</p>
</li>
</ul>
</li>
<li>
<p><strong>序列化陷阱 (Serialization Pitfalls)</strong>：</p>
<ul>
<li>
<p><strong>JsonUtility</strong>：无法序列化 Dictionary。如果你想存背包（ItemID -&gt; 数量），必须把它转换成两个 List，或者定义一个 class ItemEntry { id, count } 的 List。</p>
</li>
<li>
<p><strong>字段可见性</strong>：JsonUtility <strong>只保存 public 字段</strong>，或者加了 [SerializeField] 的 private 字段。</p>
</li>
<li>
<p><strong>Vector3/Color</strong>：Unity 的原生类型 JsonUtility 可以直接存，但第三方库（如 Newtonsoft）通常需要写转换器。</p>
</li>
</ul>
</li>
<li>
<p><strong>加密意识</strong>：</p>
<ul>
<li>单机游戏防不住真正的黑客，但加上简单的 XOR 或 Base64 编码，能防住 90% 的“手贱”玩家修改存档导致游戏崩溃。</li>
</ul>
</li>
</ol>
<h2 id="二十八顿帧时间冻结管理器">二十八、顿帧/时间冻结管理器
</h2><h3 id="代码全景分析-26">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：通过修改 Unity 全局时间倍率 Time.timeScale 来控制游戏节奏。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>顿帧 (Hit Stop)</strong>：攻击命中瞬间，画面定格 0.05~0.15秒，强化冲击感。</p>
</li>
<li>
<p><strong>慢动作 (Slow Motion)</strong>：主角死亡瞬间、精准闪避成功（魔女时间）、Boss 释放大招前摇。</p>
</li>
</ul>
</li>
<li>
<p><strong>关键技术</strong>：WaitForSecondsRealtime。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">  <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">TimeManager</span> <span class="p">:</span> <span class="n">Singleton</span><span class="p">&lt;</span><span class="n">TimeManager</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_defaultFixedDeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 状态栈标记：是否有慢动作正在进行</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isSlowMotionActive</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_currentSlowMotionScale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Awake</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录游戏初始的物理更新频率 (通常是 0.02)</span>
</span></span><span class="line"><span class="cl">        <span class="n">_defaultFixedDeltaTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">fixedDeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 触发顿帧（高优先级，会暂时覆盖慢动作）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">DoHitStop</span><span class="p">(</span><span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果已经在顿帧中，不再重复触发，或者可以选择覆盖</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span> <span class="p">==</span> <span class="m">0f</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">HitStopRoutine</span><span class="p">(</span><span class="n">duration</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 触发慢动作</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">DoSlowMotion</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">,</span> <span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果已经在慢动作中，可以选择刷新时间或忽略</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_isSlowMotionActive</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">SlowMotionRoutine</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">duration</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 核心协程 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">HitStopRoutine</span><span class="p">(</span><span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 记录顿帧前的状态 (可能是 1.0，也可能是 0.5 的慢动作)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">prevTimeScale</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 瞬间冻结</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetTimeScale</span><span class="p">(</span><span class="m">0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 等待真实时间</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSecondsRealtime</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 恢复到顿帧前的状态 (关键修复：不是无脑恢复 1.0)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetTimeScale</span><span class="p">(</span><span class="n">prevTimeScale</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">SlowMotionRoutine</span><span class="p">(</span><span class="kt">float</span> <span class="n">targetScale</span><span class="p">,</span> <span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isSlowMotionActive</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentSlowMotionScale</span> <span class="p">=</span> <span class="n">targetScale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 进入慢动作</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetTimeScale</span><span class="p">(</span><span class="n">targetScale</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 等待真实时间</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">WaitForSecondsRealtime</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 恢复正常</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetTimeScale</span><span class="p">(</span><span class="m">1f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isSlowMotionActive</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 辅助方法 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 统一修改时间缩放的入口，自动处理物理和音频</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">SetTimeScale</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span> <span class="p">=</span> <span class="n">scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 【关键修复】同步调整物理更新频率，保证慢动作丝般顺滑</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 限制最小值为 0，防止除以零或负数错误</span>
</span></span><span class="line"><span class="cl">        <span class="n">Time</span><span class="p">.</span><span class="n">fixedDeltaTime</span> <span class="p">=</span> <span class="n">_defaultFixedDeltaTime</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="m">0.001f</span><span class="p">);</span> <span class="c1">// 0.001f防止为0时物理完全停止计算</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 【音频修复】(可选) </span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 许多游戏希望慢动作时音效不变调，或者变调。</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果你不希望声音变低沉，可以反向设置 pitch</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// AudioListener.volume = 1f; // 或者在这里做静音处理</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用场景示例连击与处决">使用场景示例：连击与处决
</h3><p><strong>场景：主角连击</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 在 Enemy.cs 的 TakeDamage 中</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">TakeDamage</span><span class="p">(</span><span class="kt">int</span> <span class="n">damage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hp</span> <span class="p">-=</span> <span class="n">damage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 播放受击特效...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 触发轻微顿帧，增加肉感 (0.05秒)</span>
</span></span><span class="line"><span class="cl">    <span class="n">TimeManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">DoHitStop</span><span class="p">(</span><span class="m">0.05f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 敌人死亡瞬间，触发慢动作 (0.2倍速，持续1秒)，营造史诗感</span>
</span></span><span class="line"><span class="cl">        <span class="n">TimeManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">DoSlowMotion</span><span class="p">(</span><span class="m">0.2f</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-21">核心技能点总结
</h3><ol>
<li>
<p><strong>物理更新频率 (fixedDeltaTime)</strong>：</p>
<ul>
<li>这是中级开发者必须掌握的知识点。<strong>只要动 timeScale，必须动 fixedDeltaTime</strong>。否则你的物理模拟（跳跃、弹道）在慢动作下会完全乱套。</li>
</ul>
</li>
<li>
<p><strong>协程与真实时间</strong>：</p>
<ul>
<li>明确区分 WaitForSeconds (受 timeScale 影响) 和 WaitForSecondsRealtime (不受影响)。做 UI 动画、暂停菜单、顿帧逻辑时，通常用后者。</li>
</ul>
</li>
<li>
<p><strong>状态恢复逻辑</strong>：</p>
<ul>
<li>在修改全局状态（如时间）前，先记录 prevValue，结束后恢复 prevValue，而不是恢复 default。这是防止多个系统（顿帧系统、技能系统）打架的关键。</li>
</ul>
</li>
</ol>
<h2 id="二十九加权随机算法">二十九、加权随机算法
</h2><h3 id="代码全景分析-27">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：从一堆物品中，根据各自的权重，随机抽取一个。</p>
</li>
<li>
<p><strong>数学原理</strong>：</p>
<ol>
<li>
<p>计算所有物品的权重总和（TotalWeight）。</p>
</li>
<li>
<p>在 0 到 TotalWeight 之间随机取一个数 roll。</p>
</li>
<li>
<p>遍历列表，累加权重。一旦累加值超过 roll，当前物品就是中奖者。</p>
</li>
</ol>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>怪物掉落</strong>：大金币（权重10），小金币（权重50），回血草（权重20）。</p>
</li>
<li>
<p><strong>随机刷怪</strong>：生成普通僵尸（权重80），精英僵尸（权重5）。</p>
</li>
<li>
<p><strong>音效随机</strong>：攻击时随机播放 3 种挥刀音效，防止听觉疲劳。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 1. 定义掉落项</span>
</span></span><span class="line"><span class="cl"><span class="na">[System.Serializable]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">LootEntry</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">prefab</span><span class="p">;</span> <span class="c1">// 掉落物</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;权重：数值越大，掉率越高&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">weight</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [HideInInspector]</span> <span class="kd">public</span> <span class="kt">float</span> <span class="n">displayChance</span><span class="p">;</span> <span class="c1">// 用于在编辑器显示百分比</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 2. 创建 ScriptableObject，让掉落表变成一个可复用的资源文件</span>
</span></span><span class="line"><span class="cl"><span class="na">[CreateAssetMenu(menuName = &#34;Game/Loot Table&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">LootTableSO</span> <span class="p">:</span> <span class="n">ScriptableObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;全局掉落率 (0-1)&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;如果是 0.3，说明有 70% 的几率什么都不掉&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">globalDropChance</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;掉落池&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">LootEntry</span><span class="p">&gt;</span> <span class="n">items</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 缓存总权重，避免每次计算</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">_totalWeight</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 获取掉落物（可能返回 null）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GameObject</span> <span class="n">GetLoot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 第一层判定：这次到底掉不掉？</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="k">value</span> <span class="p">&gt;</span> <span class="n">globalDropChance</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 初始化总权重（懒加载）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_totalWeight</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="n">CalculateTotalWeight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 轮盘赌算法</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">items</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">roll</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">_totalWeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">currentSum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">currentSum</span> <span class="p">+=</span> <span class="n">entry</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">roll</span> <span class="p">&lt;</span> <span class="n">currentSum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">entry</span><span class="p">.</span><span class="n">prefab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">prefab</span><span class="p">;</span> <span class="c1">// 兜底</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">CalculateTotalWeight</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_totalWeight</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 防止策划手滑填了负数</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">weight</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">item</span><span class="p">.</span><span class="n">weight</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_totalWeight</span> <span class="p">+=</span> <span class="n">item</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 编辑器辅助功能 ---</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这个函数会在 Inspector 数值变化时自动调用</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 让我们在编辑器里实时看到算好的百分比！</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">OnValidate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">||</span> <span class="n">items</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">total</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">items</span><span class="p">)</span> <span class="n">total</span> <span class="p">+=</span> <span class="n">item</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">.</span><span class="n">displayChance</span> <span class="p">=</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">weight</span> <span class="p">/</span> <span class="n">total</span><span class="p">)</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用场景与示例-13">使用场景与示例
</h3><p>假设你要做一个 <strong>怪物掉落系统</strong>。</p>
<p><strong>Step 1: 准备数据</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">EnemyLoot</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义你要掉什么，这里以 GameObject 为例</span>
</span></span><span class="line"><span class="cl"><span class="na">    [System.Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">DropTable</span> <span class="p">:</span> <span class="n">LootTable</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 需要显式构造函数来适配父类</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">DropTable</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">LootItem</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;&gt;</span> <span class="n">items</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 Inspector 里配置</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">LootItem</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;&gt;</span> <span class="n">dropConfig</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LootTable</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;</span> <span class="n">_lootTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化算法类</span>
</span></span><span class="line"><span class="cl">        <span class="n">_lootTable</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LootTable</span><span class="p">&lt;</span><span class="n">GameObject</span><span class="p">&gt;(</span><span class="n">dropConfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">OnDeath</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 随机获取一个物品</span>
</span></span><span class="line"><span class="cl">        <span class="n">GameObject</span> <span class="n">reward</span> <span class="p">=</span> <span class="n">_lootTable</span><span class="p">.</span><span class="n">GetRandom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">reward</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Instantiate</span><span class="p">(</span><span class="n">reward</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-22">核心技能点总结
</h3><ol>
<li>
<p><strong>加权随机 (Weighted Random)</strong>：</p>
<ul>
<li><strong>面试必问</strong>。请熟练掌握 累加权重 -&gt; 随机Roll点 -&gt; 遍历判断 这一套逻辑。</li>
</ul>
</li>
<li>
<p><strong>ScriptableObject 的威力</strong>：</p>
<ul>
<li>对于数据配置（掉落表、怪物属性、武器参数），<strong>ScriptableObject 永远优于 MonoBehaviour</strong>。因为它减少了内存开销（数据共享），且方便版本管理。</li>
</ul>
</li>
<li>
<p><strong>OnValidate</strong>：</p>
<ul>
<li>这是 Unity 编辑器编程的入门技巧。利用它可以在编辑阶段自动计算、校验数据，不用等到运行游戏才发现填错了。</li>
</ul>
</li>
</ol>
<h2 id="三十通用悬停提示器">三十、通用悬停提示器
</h2><h3 id="代码全景分析-28">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：鼠标移入显示信息，移出隐藏信息。</p>
</li>
<li>
<p><strong>设计模式</strong>：</p>
<ul>
<li>
<p><strong>观察者模式</strong>（通过 Unity 接口实现）。</p>
</li>
<li>
<p><strong>单例模式</strong>（System 全局唯一）。</p>
</li>
</ul>
</li>
<li>
<p><strong>关键接口</strong>：IPointerEnterHandler 和 IPointerExitHandler。这是 Unity UI 事件系统的标准接口，比 OnMouseEnter（物理射线）更适合 UI 元素。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">TMPro</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 挂载在 Tooltip 的 Panel 上</span>
</span></span><span class="line"><span class="cl"><span class="na">[ExecuteInEditMode]</span> <span class="c1">// 允许在编辑器里实时预览大小变化</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">TooltipUI</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;UI 组件&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TextMeshProUGUI</span> <span class="n">headerText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TextMeshProUGUI</span> <span class="n">contentText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">LayoutElement</span> <span class="n">layoutElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">characterWrapLimit</span> <span class="p">=</span> <span class="m">80</span><span class="p">;</span> <span class="c1">// 超过多少个字就换行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RectTransform</span> <span class="n">_rectTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rectTransform</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">RectTransform</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">SetText</span><span class="p">(</span><span class="kt">string</span> <span class="n">content</span><span class="p">,</span> <span class="kt">string</span> <span class="n">header</span> <span class="p">=</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 设置内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">headerText</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">headerText</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">SetActive</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">headerText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">contentText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 动态调整宽度的逻辑 (Layout Element)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取 header 和 content 中较长的那个长度</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">headerLength</span> <span class="p">=</span> <span class="n">headerText</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">contentLength</span> <span class="p">=</span> <span class="n">contentText</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果字数太长，就开启 layoutElement 的 enabled 让它限制最大宽度并换行</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 否则就禁用，让 Content Size Fitter 自动适应文字的短宽度</span>
</span></span><span class="line"><span class="cl">        <span class="n">layoutElement</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="p">(</span><span class="n">headerLength</span> <span class="p">&gt;</span> <span class="n">characterWrapLimit</span> <span class="p">||</span> <span class="n">contentLength</span> <span class="p">&gt;</span> <span class="n">characterWrapLimit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 实时跟随鼠标 (在 Update 里调用！)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">isPlaying</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FollowMouse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">FollowMouse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Vector2</span> <span class="n">mousePos</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// --- 核心算法：防出屏枢轴翻转 (Pivot Flipping) ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">pivotX</span> <span class="p">=</span> <span class="n">mousePos</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">pivotY</span> <span class="p">=</span> <span class="n">mousePos</span><span class="p">.</span><span class="n">y</span> <span class="p">/</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果鼠标在屏幕左半边，pivotX 设为 0 (UI在鼠标右侧显示)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果鼠标在屏幕右半边，pivotX 设为 1 (UI在鼠标左侧显示)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这样 Tooltip 永远不会飞出屏幕左右边界</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rectTransform</span><span class="p">.</span><span class="n">pivot</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">pivotX</span><span class="p">,</span> <span class="n">pivotY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">mousePos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="如何在-unity-中组装setup">如何在 Unity 中组装（Setup）
</h3><p>这套系统非常依赖 <strong>Unity UI 的布局组件</strong>，请按以下步骤操作：</p>
<ol>
<li>
<p><strong>制作 Tooltip 面板</strong>：</p>
<ul>
<li>
<p>Canvas 下创建一个 Image，命名为 Tooltip。</p>
</li>
<li>
<p>添加组件 <strong>Vertical Layout Group</strong> (勾选 Control Child Size: Width &amp; Height)。</p>
</li>
<li>
<p>添加组件 <strong>Content Size Fitter</strong> (Horizontal: Preferred, Vertical: Preferred)。这是自适应大小的关键。</p>
</li>
<li>
<p>挂载上面的 <strong>TooltipUI</strong> 脚本。</p>
</li>
<li>
<p>添加组件 <strong>Canvas Group</strong> (用于将来做淡入淡出，且勾选 Block Raycasts = false，防止 Tooltip 挡住鼠标射线)。</p>
</li>
</ul>
</li>
<li>
<p><strong>制作文本子物体</strong>：</p>
<ul>
<li>
<p>在 Tooltip 下创建两个 TextMeshPro (Header 和 Content)。</p>
</li>
<li>
<p>把它们拖给脚本里的变量。</p>
</li>
</ul>
</li>
<li>
<p><strong>布局限制</strong>：</p>
<ul>
<li>
<p>给 Tooltip 物体再加一个 <strong>Layout Element</strong> 组件。</p>
</li>
<li>
<p>勾选 Preferred Width 并填入比如 300。</p>
</li>
<li>
<p>把这个 Layout Element 组件拖给脚本里的 layoutElement 变量。</p>
</li>
</ul>
</li>
<li>
<p><strong>连接系统</strong>：</p>
<ul>
<li>
<p>场景里创建一个 GameManager，挂载 TooltipSystem。</p>
</li>
<li>
<p>把刚才做好的 Tooltip 拖给 TooltipSystem 的 tooltipUI 变量。</p>
</li>
<li>
<p>一开始把 Tooltip 物体隐藏（SetActive false）。</p>
</li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-23">核心技能点总结
</h3><ol>
<li>
<p><strong>UI 自适应布局 (Auto Layout)</strong>：</p>
<ul>
<li>熟练掌握 Content Size Fitter + Vertical Layout Group + Layout Element 的组合拳。这是制作对话框、气泡、Tooltip 的标准流程。</li>
</ul>
</li>
<li>
<p><strong>Pivot (枢轴) 的妙用</strong>：</p>
<ul>
<li>RectTransform.pivot 不仅仅是旋转中心。在代码中动态修改 Pivot（如 FollowMouse 中的算法），是实现“智能贴边 UI”最优雅的数学方法，完全不需要复杂的坐标判断 if (x &gt; width - 100)。</li>
</ul>
</li>
<li>
<p><strong>ExecuteInEditMode</strong>：</p>
<ul>
<li>这个标签让脚本在编辑器非运行状态下也能执行。对于 UI 布局脚本来说，能让你在编辑时直接看到字多了框变大的效果，非常实用。</li>
</ul>
</li>
</ol>
<h2 id="三十一冷却时间追踪器">三十一、冷却时间追踪器
</h2><h3 id="代码全景分析-29">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：封装了基于时间戳的计时逻辑。</p>
</li>
<li>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>
<p><strong>无 Update</strong>：它不依赖 Update 每帧扣时间，而是记录“下次可用的时间点”（Time Stamp）。这使得它性能极高，且不用担心多线程问题。</p>
</li>
<li>
<p><strong>序列化</strong>：[Serializable] 让它能直接在 Inspector 面板里显示和配置。</p>
</li>
</ul>
</li>
<li>
<p><strong>类型</strong>：<strong>值类型 (Value Type)</strong>。请记住这四个字，后面会考。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[System.Serializable]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">struct</span> <span class="nc">Cooldown</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;冷却总时长(秒)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用 [SerializeField] 让私有变量也能在 Inspector 的 Debug 模式下看到</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 但保持 private 防止外部随意修改</span>
</span></span><span class="line"><span class="cl"><span class="na">    [SerializeField]</span> <span class="kd">private</span> <span class="kt">float</span> <span class="n">_nextReadyTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造函数</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Cooldown</span><span class="p">(</span><span class="kt">float</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">duration</span> <span class="p">=</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">_nextReadyTime</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 技能是否可用？</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">IsReady</span> <span class="p">=&gt;</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="p">&gt;=</span> <span class="n">_nextReadyTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 触发冷却</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 加上 Time.time 得到未来的时间戳</span>
</span></span><span class="line"><span class="cl">        <span class="n">_nextReadyTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="p">+</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 强制重置冷却（立即可用）</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_nextReadyTime</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 剩余秒数</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">TimeRemaining</span> <span class="p">=&gt;</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">_nextReadyTime</span> <span class="p">-</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 进度 (1 -&gt; 0)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;冷却刚开始是 1，冷却完毕是 0&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">ProgressRemaining</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">duration</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">TimeRemaining</span> <span class="p">/</span> <span class="n">duration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 进度 (0 -&gt; 1)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;冷却刚开始是 0，冷却完毕是 1 (适合填充式 UI)&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">ProgressComplete</span> <span class="p">=&gt;</span> <span class="m">1f</span> <span class="p">-</span> <span class="n">ProgressRemaining</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用场景与示例-14">使用场景与示例
</h3><p><strong>场景：实现一个带有冷却的“闪避（Dash）”技能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PlayerController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 Inspector 里直接填 duration = 2</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Cooldown</span> <span class="n">dashCd</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Cooldown</span><span class="p">(</span><span class="m">2f</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TryDash</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">TryDash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 检查冷却</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dashCd</span><span class="p">.</span><span class="n">IsReady</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 2. 执行逻辑</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&#34;发动闪避！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 3. 开始冷却 (关键！)</span>
</span></span><span class="line"><span class="cl">            <span class="n">dashCd</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&#34;技能冷却中... 剩余: {dashCd.TimeRemaining:F1}秒&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// UI 显示 (假设在 OnGUI 或者 UI 脚本中)</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">OnGUI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 显示 0.0 ~ 1.0 的进度</span>
</span></span><span class="line"><span class="cl">        <span class="n">GUI</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="k">new</span> <span class="n">Rect</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">20</span><span class="p">),</span> <span class="s">$&#34;CD Progress: {dashCd.Progress}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-24">核心技能点总结
</h3><ol>
<li>
<p><strong>Struct vs Class (值类型 vs 引用类型)</strong>：</p>
<ul>
<li><strong>核心考点</strong>：明白为什么 struct 不能随便赋值给局部变量再修改。如果你的冷却逻辑非常复杂，或者需要被多个脚本共享引用，请改用 class。但对于简单的 CD，struct 是性能最好的。</li>
</ul>
</li>
<li>
<p><strong>时间戳逻辑 (Timestamp)</strong>：</p>
<ul>
<li><strong>优化思维</strong>：避免在 Update 里写 timer -= Time.deltaTime。使用时间戳（Time.time + duration）可以省去大量的 CPU 计算，且状态更稳定（不会因为掉帧导致计时不准）。</li>
</ul>
</li>
<li>
<p><strong>序列化 (Serialization)</strong>：</p>
<ul>
<li>自定义结构体要想在 Unity Inspector 里显示，必须加 [System.Serializable]。</li>
</ul>
</li>
</ol>
<h2 id="三十二视差滚动背景">三十二、视差滚动背景
</h2><h3 id="代码全景分析-30">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：让背景层跟随摄像机移动，但速度不同，从而产生 3D 的层次感。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>横版卷轴（Platformer）</strong>：远景的山脉、云朵、树林。</p>
</li>
<li>
<p><strong>纵向射击（STG）</strong>：飞船下方的星空、地面建筑。</p>
</li>
</ul>
</li>
<li>
<p><strong>关键数学</strong>：位置 = 初始位置 + (相机移动距离 * 视差系数)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(SpriteRenderer))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Parallax</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">float</span> <span class="n">_length</span><span class="p">,</span> <span class="n">_startPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Camera</span> <span class="n">mainCam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;视差设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;视差系数 (0 ~ 1)\n1 = 远景 (几乎不动，跟着相机)\n0 = 近景 (正常移动)&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">parallaxFactor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否开启无限循环&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">infiniteLoop</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">mainCam</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">mainCam</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 记录初始 X 坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">_startPos</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 获取图片的宽度 (用于循环)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// bounds.size.x 是图片在世界坐标下的实际宽度</span>
</span></span><span class="line"><span class="cl">        <span class="n">_length</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">SpriteRenderer</span><span class="p">&gt;().</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用 LateUpdate 确保在相机移动之后再移动背景，消除抖动</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// temp: 背景相对于相机实际移动了多少 (用于判断是否该重置位置)</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">temp</span> <span class="p">=</span> <span class="p">(</span><span class="n">mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">parallaxFactor</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// dist: 背景应该在的位置偏移量</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">dist</span> <span class="p">=</span> <span class="p">(</span><span class="n">mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">parallaxFactor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. 更新位置</span>
</span></span><span class="line"><span class="cl">        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">_startPos</span> <span class="p">+</span> <span class="n">dist</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. 无限循环逻辑 (Checkbounds)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">infiniteLoop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果相机往右走，超过了图片宽度的一半，把背景的基准点往右挪一个身位</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="p">&gt;</span> <span class="n">_startPos</span> <span class="p">+</span> <span class="n">_length</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_startPos</span> <span class="p">+=</span> <span class="n">_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果相机往左走，超过了图片宽度的一半，把背景的基准点往左挪一个身位</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="p">&lt;</span> <span class="n">_startPos</span> <span class="p">-</span> <span class="n">_length</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_startPos</span> <span class="p">-=</span> <span class="n">_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="如何在-unity-中搭建无限背景">如何在 Unity 中搭建无限背景
</h3><ol>
<li>
<p><strong>准备素材</strong>：找一张两边可以完美拼接的背景图（Seamless Texture）。</p>
</li>
<li>
<p><strong>场景搭建</strong>：</p>
<ul>
<li>
<p>在场景里放 <strong>3 张</strong> 同样的背景图，横向排开（左、中、右），填满相机视野。</p>
</li>
<li>
<p>给这 3 张图都挂上上面的 Parallax 脚本。</p>
</li>
<li>
<p><strong>关键</strong>：它们的 parallaxFactor 必须设为<strong>完全一样</strong>（比如都是 0.8）。</p>
</li>
</ul>
</li>
<li>
<p><strong>运行</strong>：</p>
<ul>
<li>当你控制角色向右跑时，最左边那张图一旦跑出屏幕范围，就会瞬间瞬移到最右边去接力。玩家永远跑不到尽头。</li>
</ul>
</li>
</ol>
<h3 id="核心技能点总结-25">核心技能点总结
</h3><ol>
<li>
<p><strong>Update vs LateUpdate</strong>：</p>
<ul>
<li>
<p><strong>面试考点</strong>：任何跟随相机（Camera Follow）或跟随主角移动的 UI/背景，<strong>必须</strong>放在 LateUpdate 里。</p>
</li>
<li>
<p><strong>原因</strong>：相机通常在 Update 移动。如果在 Update 里移动背景，可能出现“相机动了 -&gt; 渲染画面 -&gt; 背景动了”的顺序错位，导致画面撕裂或抖动。LateUpdate 保证在相机动完后再跟进。</p>
</li>
</ul>
</li>
<li>
<p><strong>相对运动原理</strong>：</p>
<ul>
<li>理解 1 - parallaxFactor 是计算“由于视差导致的滞后距离”，这是判定何时瞬移的关键。</li>
</ul>
</li>
<li>
<p><strong>Sprite Bounds</strong>：</p>
<ul>
<li>不要手动填 length。使用 GetComponent<SpriteRenderer>().bounds.size.x 动态获取，这样无论你怎么缩放图片，逻辑都是对的。</li>
</ul>
</li>
</ol>
<h2 id="三十三屏幕边界限制器">三十三、屏幕边界限制器
</h2><h3 id="代码全景分析-31">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：限制物体（通常是玩家）只能在摄像机可见范围内移动。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>STG 射击游戏</strong>（雷电、东方Project）。</p>
</li>
<li>
<p><strong>封闭式竞技场</strong>（以撒的结合）。</p>
</li>
<li>
<p><strong>UI 拖拽限制</strong>。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心算法</strong>：</p>
<ol>
<li>
<p>ScreenToWorldPoint：将屏幕的像素坐标转为世界坐标。</p>
</li>
<li>
<p>Mathf.Clamp：将坐标数值“钳制”在最小值和最大值之间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(SpriteRenderer))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ScreenBounds</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;设置&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;边缘留白距离&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">padding</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否每帧更新边界（如果摄像机移动，必须勾选）&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">updateEveryFrame</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SpriteRenderer</span> <span class="n">_renderer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_halfSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Camera</span> <span class="n">_mainCam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">_screenBounds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mainCam</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_renderer</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">SpriteRenderer</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 计算物体的一半尺寸 (Extents)</span>
</span></span><span class="line"><span class="cl">        <span class="n">_halfSize</span> <span class="p">=</span> <span class="n">_renderer</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">extents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化计算一次</span>
</span></span><span class="line"><span class="cl">        <span class="n">CalculateBounds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">LateUpdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果摄像机是动的，必须每帧重新计算边界</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">updateEveryFrame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CalculateBounds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Vector3</span> <span class="n">viewPos</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// --- 核心限制逻辑 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 限制 X 轴</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 左边界 = 负屏幕宽 + 物体半宽 + padding</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 右边界 = 正屏幕宽 - 物体半宽 - padding</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">xMin</span> <span class="p">=</span> <span class="p">-</span><span class="n">_screenBounds</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">_halfSize</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">padding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">xMax</span> <span class="p">=</span> <span class="n">_screenBounds</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">_halfSize</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">padding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 加上摄像机当前的位置（适配移动摄像机）</span>
</span></span><span class="line"><span class="cl">        <span class="n">viewPos</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">viewPos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">xMin</span><span class="p">,</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">xMax</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 限制 Y 轴</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">yMin</span> <span class="p">=</span> <span class="p">-</span><span class="n">_screenBounds</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">_halfSize</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">padding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">yMax</span> <span class="p">=</span> <span class="n">_screenBounds</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">_halfSize</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">padding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">viewPos</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">viewPos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">yMin</span><span class="p">,</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">yMax</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">viewPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算屏幕在世界坐标系下的一半宽度和高度</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">CalculateBounds</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这种算法更适合 2D 正交相机，比 ScreenToWorldPoint 更纯粹</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">vertExtent</span> <span class="p">=</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">orthographicSize</span><span class="p">;</span>    <span class="c1">// 屏幕高度的一半</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">horzExtent</span> <span class="p">=</span> <span class="n">vertExtent</span> <span class="p">*</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span> <span class="p">/</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="c1">// 屏幕宽度的一半</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_screenBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">horzExtent</span><span class="p">,</span> <span class="n">vertExtent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 调试辅助线 ---</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 让你在编辑器里直接看到限制框在哪里，非常实用！</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">OnDrawGizmosSelected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_mainCam</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">_mainCam</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_mainCam</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 模拟计算框的大小</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">vertExtent</span> <span class="p">=</span> <span class="n">_mainCam</span><span class="p">.</span><span class="n">orthographicSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">horzExtent</span> <span class="p">=</span> <span class="n">vertExtent</span> <span class="p">*</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span> <span class="p">/</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 绿色线框代表活动范围</span>
</span></span><span class="line"><span class="cl">        <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">width</span> <span class="p">=</span> <span class="p">(</span><span class="n">horzExtent</span> <span class="p">*</span> <span class="m">2</span><span class="p">)</span> <span class="p">-</span> <span class="p">(</span><span class="n">padding</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span> <span class="c1">// 只是大概示意，没减去物体宽度</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">height</span> <span class="p">=</span> <span class="p">(</span><span class="n">vertExtent</span> <span class="p">*</span> <span class="m">2</span><span class="p">)</span> <span class="p">-</span> <span class="p">(</span><span class="n">padding</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Gizmos</span><span class="p">.</span><span class="n">DrawWireCube</span><span class="p">(</span><span class="n">_mainCam</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="核心技能点总结-26">核心技能点总结
</h3><ol>
<li>
<p><strong>Mathf.Clamp</strong>：</p>
<ul>
<li><strong>必背 API</strong>。做血量限制（0~Max）、位置限制（边界）、数值限制时无处不在。</li>
</ul>
</li>
<li>
<p><strong>坐标系转换</strong>：</p>
<ul>
<li>
<p>理解 <strong>Screen Space</strong> (像素) 和 <strong>World Space</strong> (米/单位) 的区别。</p>
</li>
<li>
<p>屏幕左下角是 (0,0) 像素，但在 2D 世界坐标里，相机中心是 (0,0)，左下角可能是 (-8, -4.5)。</p>
</li>
</ul>
</li>
<li>
<p><strong>Bounds.extents</strong>：</p>
<ul>
<li>如果你做 2D 碰撞或限制，一定要分清 size (全长) 和 extents (半长)。绝大多数基于中心点的算法都需要用 extents。</li>
</ul>
</li>
</ol>
<h2 id="三十四协程锁">三十四、协程锁
</h2><h3 id="代码全景分析-32">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：管理协程的生命周期，确保“新来的顶替旧的”。</p>
</li>
<li>
<p><strong>设计模式</strong>：单通道控制（Single Channel Control）。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ol>
<li>
<p><strong>RTS 游戏的角色移动</strong>：玩家狂点鼠标右键，角色应该立刻放弃旧目标，前往新目标，而不是等旧路走完才走新路。</p>
</li>
<li>
<p><strong>UI 弹窗动画</strong>：弹窗正在“淡入”时，玩家点了关闭。代码应该立刻打断“淡入”，直接开始“淡出”，而不是等淡入完了再淡出。</p>
</li>
<li>
<p><strong>蓄力技能</strong>：正在蓄力时被打断，立刻停止蓄力逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">CoroutineRunner</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Coroutine</span> <span class="n">_currentCoroutine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 当前是否有任务在运行？</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">IsRunning</span> <span class="p">=&gt;</span> <span class="n">_currentCoroutine</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 启动新协程</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Run</span><span class="p">(</span><span class="n">IEnumerator</span> <span class="n">routine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 停止旧的</span>
</span></span><span class="line"><span class="cl">        <span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 开启新的（包裹一层，用于监听结束）</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentCoroutine</span> <span class="p">=</span> <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">WrapperRoutine</span><span class="p">(</span><span class="n">routine</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 停止当前协程</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_currentCoroutine</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">StopCoroutine</span><span class="p">(</span><span class="n">_currentCoroutine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">_currentCoroutine</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// --- 内部核心 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 这是一个&#34;中间商&#34;协程</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">WrapperRoutine</span><span class="p">(</span><span class="n">IEnumerator</span> <span class="n">routine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 执行用户的逻辑，直到它跑完</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="k">return</span> <span class="n">routine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 跑完后，把自己置空</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这样 IsRunning 属性就能正确返回 False 了！</span>
</span></span><span class="line"><span class="cl">        <span class="n">_currentCoroutine</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="使用场景与示例-15">使用场景与示例
</h3><p><strong>场景：RTS 游戏点击地板移动</strong></p>
<p>假设你有一个 UnitMovement 脚本。</p>
<p><strong>不使用 CoroutineRunner (痛苦写法)：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">isMoving</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 需要维护标志位</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">Move</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">isMoving</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StopCoroutine</span><span class="p">(</span><span class="s">&#34;MoveRoutine&#34;</span><span class="p">);</span> <span class="c1">// 只能用字符串停？或者保存引用很麻烦</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">MoveRoutine</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用 CoroutineRunner (优雅写法)：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UnitMovement</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 引用 Runner</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CoroutineRunner</span> <span class="n">_moveRunner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Awake</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 挂载 Runner 组件</span>
</span></span><span class="line"><span class="cl">        <span class="n">_moveRunner</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">CoroutineRunner</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">MoveTo</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 直接丢给 Runner，不用管之前在干嘛，它会自动处理打断</span>
</span></span><span class="line"><span class="cl">        <span class="n">_moveRunner</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">MoveRoutine</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IEnumerator</span> <span class="n">MoveRoutine</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">Distance</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0.1f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">MoveTowards</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="m">5f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="核心技能点总结-27">核心技能点总结
</h3><ol>
<li>
<p><strong>协程管理 (Handle Management)</strong>：</p>
<ul>
<li>StartCoroutine 会返回一个对象，接住它，你才能控制它的生死。</li>
</ul>
</li>
<li>
<p><strong>互斥逻辑 (Mutex)</strong>：</p>
<ul>
<li><strong>面试加分项</strong>：在处理异步逻辑（移动、动画、倒计时）时，永远要考虑“如果上一个还没做完，又来了新的怎么办？”。这个脚本就是标准的“后浪推前浪”策略。</li>
</ul>
</li>
<li>
<p><strong>包装器 (Wrapper)</strong>：</p>
<ul>
<li>通过嵌套 yield return 来监听另一个协程的结束，是 Unity 开发中的高级技巧。</li>
</ul>
</li>
</ol>
<h2 id="三十五版本号显示器">三十五、版本号显示器
</h2><h3 id="代码全景分析-33">代码全景分析
</h3><ul>
<li>
<p><strong>核心功能</strong>：自动读取 Unity 项目设置中的版本号，并显示在 UI 上。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>
<p><strong>登录界面/主菜单</strong>：通常放在右下角或左下角。</p>
</li>
<li>
<p><strong>设置面板</strong>：让玩家确认自己是否需要更新。</p>
</li>
<li>
<p><strong>Debug 界面</strong>：显示更详细的构建信息。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心 API</strong>：Application.version。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">TMPro</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[RequireComponent(typeof(TextMeshProUGUI))]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">VersionDisplay</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Header(&#34;格式设置&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">prefix</span> <span class="p">=</span> <span class="s">&#34;Ver: &#34;</span><span class="p">;</span> <span class="c1">// 前缀</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Tooltip(&#34;是否在开发包中显示详细信息&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">showDebugInfo</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">textComp</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">TextMeshProUGUI</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">finalVersion</span> <span class="p">=</span> <span class="s">$&#34;{prefix}{Application.version}&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// --- 工业级环境感知 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 检测是否是开发构建 (Development Build)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这个属性在 Build Settings 里勾选 &#34;Development Build&#34; 时为 true</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">showDebugInfo</span> <span class="p">&amp;&amp;</span> <span class="n">Debug</span><span class="p">.</span><span class="n">isDebugBuild</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">finalVersion</span> <span class="p">+=</span> <span class="s">&#34; &lt;color=yellow&gt;[DEV]&lt;/color&gt;&#34;</span><span class="p">;</span> <span class="c1">// 加个黄色的 DEV 标记</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. 检测是否是编辑器模式</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if</span> <span class="n">UNITY_EDITOR</span>
</span></span><span class="line"><span class="cl">        <span class="n">finalVersion</span> <span class="p">+=</span> <span class="s">&#34; (Editor)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. (可选) 显示具体的平台，方便截图反馈</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// finalVersion += $&#34; [{Application.platform}]&#34;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">textComp</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">finalVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用场景与配置">使用场景与配置
</h3><ol>
<li>
<p><strong>场景搭建</strong>：</p>
<ul>
<li>
<p>在主菜单 Canvas 的角落创建一个 <strong>Text (TMP)</strong>。</p>
</li>
<li>
<p>字体设小一点（比如 20），颜色设为半透明灰色（不要抢眼）。</p>
</li>
<li>
<p>挂载 VersionDisplay 脚本。</p>
</li>
</ul>
</li>
<li>
<p><strong>设置版本</strong>：</p>
<ul>
<li>
<p>打开 Project Settings &gt; Player。</p>
</li>
<li>
<p>在 Version 一栏填入 0.1.0 Alpha。</p>
</li>
</ul>
</li>
<li>
<p><strong>运行</strong>：</p>
<ul>
<li>屏幕上会自动显示 v0.1.0 Alpha。</li>
</ul>
</li>
</ol>
<h3 id="">
</h3><h3 id="核心技能点总结-28">核心技能点总结
</h3><ol>
<li>
<p><strong>Application 类</strong>：</p>
<ul>
<li>
<p>Application 是 Unity 的全局信息中心。</p>
</li>
<li>
<p><strong>常用 API</strong>：</p>
<ul>
<li>
<p>Application.version：版本号。</p>
</li>
<li>
<p>Application.platform：当前运行平台（Windows, Android, iOS&hellip;）。</p>
</li>
<li>
<p>Application.identifier：包名（com.company.game）。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>版本管理意识</strong>：</p>
<ul>
<li>
<p><strong>语义化版本控制 (SemVer)</strong>：建议养成 主版本.次版本.修订号（如 1.2.5）的命名习惯。</p>
</li>
<li>
<p><strong>主版本</strong>：重大架构变更。</p>
</li>
<li>
<p><strong>次版本</strong>：新功能。</p>
</li>
<li>
<p><strong>修订号</strong>：修 Bug。</p>
</li>
</ul>
</li>
</ol>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 黎Yio
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.32.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
  body {
    background: url(https://SelYioZn.github.io/background/Background.jpg) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
</style>

<style>
  @font-face {
    font-family: 'Fonts';
    src: url(https://SelYioZn.github.io/font/FZZH-JYTJW.TTF) format('truetype');
  }

  :root {
    --base-font-family: 'Fonts';
    --code-font-family: 'Fonts';
  }
</style>

    </body>
</html>
